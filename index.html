<!DOCTYPE html> 
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Système de Distribution des Factures Impôts</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#1976d2">

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.css" />
<link rel="stylesheet" href="styles-responsive.css">
<style>
/* Styles pour la page de connexion */
#login-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #007bff, #0056b3);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 20px;
    box-sizing: border-box;
}

#login-container {
    background: rgba(255, 255, 255, 0.95);
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    width: 100%;
    max-width: 350px;
    text-align: center;
}

#login-container h2 {
    margin-top: 0;
    color: #007bff;
    margin-bottom: 25px;
    font-size: 1.8em;
}

.login-input {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1em;
    box-sizing: border-box;
    transition: border-color 0.3s;
}

.login-input:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
}

#login-btn {
    width: 100%;
    padding: 12px;
    background: linear-gradient(145deg, #007bff, #0056b3);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.1em;
    cursor: pointer;
    transition: transform 0.2s, background 0.2s;
    margin-top: 10px;
}

#login-btn:hover {
    background: linear-gradient(145deg, #0056b3, #003f7f);
    transform: translateY(-2px);
}

#login-error {
    color: #dc3545;
    margin-top: 15px;
    display: none;
    font-weight: 500;
}

/* Styles pour l'application principale */
#app-container {
    display: none;
}

/* Modern Material Design Variables */
:root {
    --primary-color: #1976d2;
    --primary-dark: #1565c0;
    --primary-light: #bbdefb;
    --accent-color: #ff5722;
    --success-color: #4caf50;
    --warning-color: #ff9800;
    --error-color: #f44336;
    --text-primary: #212121;
    --text-secondary: #757575;
    --divider-color: #e0e0e0;
    --background-color: #fafafa;
    --surface-color: #ffffff;
    --shadow-1: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    --shadow-2: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
    --shadow-3: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
    --shadow-4: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
    --border-radius: 8px;
    --border-radius-large: 16px;
    --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-medium: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Global Styles with Modern Typography */
* {
    box-sizing: border-box;
}

body { 
    margin: 0; 
    font-family: 'Inter', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--background-color);
    color: var(--text-primary);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    overflow-x: hidden;
    -webkit-text-size-adjust: 100%;
    -webkit-tap-highlight-color: transparent;
}

#header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    color: white; 
    padding: 16px 24px; 
    box-shadow: var(--shadow-2);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 80px;
    z-index: 1001;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

#header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
    pointer-events: none;
}

#header .header-content {
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 1;
    gap: 15px;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
}

#header img { 
    width: 40px; 
    margin-right: 15px; 
}

#header h1 { 
    margin: 0; 
    font-size: 1.4em; 
    text-shadow: 1px 1px 2px #000;
    text-align: center;
}

/* Bouton hamburger pour mobile */
#menu-toggle {
    display: none;
    background: transparent;
    border: none;
    color: white;
    font-size: 1.5em;
    cursor: pointer;
    padding: 8px;
    z-index: 1002;
    min-height: 44px;
    min-width: 44px;
}

/* Bouton pour cacher/afficher la sidebar */
#sidebar-toggle {
    position: fixed;
    top: 15px;
    left: 20px;
    width: 35px;
    height: 35px;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    border: none;
    border-radius: 8px;
    color: white;
    font-size: 1.1em;
    cursor: pointer;
    z-index: 1003;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 44px;
    min-width: 44px;
}

#sidebar-toggle:hover {
    background: linear-gradient(135deg, var(--primary-dark), #0d47a1);
    transform: scale(1.05);
    box-shadow: 0 3px 12px rgba(0,0,0,0.2);
}

#sidebar-toggle.sidebar-hidden {
    /* Position reste la même en haut à gauche */
}

#map { 
    height: calc(100vh - 80px);
    margin-top: 80px;
    margin-left: 320px;
    transition: margin-left 0.3s ease;
}

#map.sidebar-hidden {
    margin-left: 0;
}

#sidebar { 
    position: fixed;
    top: 80px; 
    left: 0; 
    bottom: 0; 
    width: 320px; 
    z-index: 1000; 
    background: var(--surface-color);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    padding: 24px; 
    overflow-y: auto; 
    display: flex; 
    flex-direction: column; 
    border-radius: 0 var(--border-radius-large) var(--border-radius-large) 0; 
    box-shadow: var(--shadow-3);
    border-right: 1px solid var(--divider-color);
    transform: translateX(0);
    transition: transform var(--transition-medium);
}

#sidebar::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(25,118,210,0.02) 0%, rgba(25,118,210,0.01) 100%);
    pointer-events: none;
    border-radius: 0 var(--border-radius-large) var(--border-radius-large) 0;
}

#sidebar.hidden {
    transform: translateX(-100%);
}

#sidebar h3 { 
    margin-top: 0; 
    text-align: center; 
    color: #007bff;
    font-size: 1.1em;
}

#sidebar input, #sidebar select { 
    width: calc(100% - 24px); 
    padding: 14px 12px; 
    margin-bottom: 16px; 
    border-radius: var(--border-radius); 
    border: 2px solid var(--divider-color); 
    font-size: 0.95em; 
    font-family: inherit;
    background: var(--surface-color);
    color: var(--text-primary);
    transition: all var(--transition-fast);
    box-sizing: border-box;
    position: relative;
    min-height: 44px;
}

#sidebar input:focus, #sidebar select:focus { 
    border-color: var(--primary-color); 
    box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1); 
    outline: none;
    transform: translateY(-1px);
}

#sidebar input::placeholder {
    color: var(--text-secondary);
    font-weight: 400;
}

#sidebar button { 
    width: 100%; 
    padding: 12px 16px; 
    margin-bottom: 8px; 
    border: none; 
    border-radius: var(--border-radius); 
    color: white; 
    cursor: pointer; 
    font-weight: 500; 
    font-size: 0.9em;
    letter-spacing: 0.025em;
    transition: all var(--transition-fast); 
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
    box-shadow: var(--shadow-1);
    position: relative;
    overflow: hidden;
    min-height: 44px;
}

#sidebar button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left var(--transition-medium);
}

#sidebar button:hover { 
    background: linear-gradient(135deg, var(--primary-dark) 0%, #0d47a1 100%);
    transform: translateY(-2px); 
    box-shadow: var(--shadow-2);
}

#sidebar button:hover::before {
    left: 100%;
}

#sidebar button:active {
    transform: translateY(0);
    box-shadow: var(--shadow-1);
}

#companyList { 
    display: none; 
    list-style: none; 
    padding: 0; 
    margin: 0; 
    max-height: 200px; 
    overflow-y: auto; 
    border: 1px solid #ddd; 
    border-radius: 5px; 
}

#companyList li { 
    padding: 12px 10px; 
    cursor: pointer; 
    border-bottom: 1px solid #eee; 
    transition: 0.2s; 
    border-radius: 3px;
    font-size: 0.9em;
    min-height: 44px;
    display: flex;
    align-items: center;
}

#companyList li:hover, #companyList li.active { 
    background: #007bff; 
    color: white; 
}

#routeControls { 
    margin-top: auto; 
    border-top: 1px solid #eee; 
    padding-top: 15px; 
}

#routeControls h3 { 
    color: #28a745; 
}

#pauseRoute { background: #ffc107; color: black; }
#resumeRoute { background: #17a2b8; }
#stopRoute { background: #dc3545; }
#locateBtn { background: #28a745; }

#layer-container { 
    position: absolute; 
    top: 90px; 
    right: 10px; 
    z-index: 1000; 
    background: rgba(255,255,255,0.95); 
    backdrop-filter: blur(8px); 
    padding: 10px; 
    border-radius: 12px; 
    display: flex; 
    flex-direction: column; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.25); 
}

.layer-preview { 
    width: 50px; 
    height: 50px; 
    margin: 5px; 
    cursor: pointer; 
    border: 2px solid #ccc; 
    background-size: cover; 
    background-position: center; 
    border-radius: 8px; 
    transition: 0.3s all; 
    min-height: 44px;
    min-width: 44px;
}

.layer-preview.active, .layer-preview:hover { 
    transform: scale(1.1); 
    border-color: #007bff; 
    box-shadow: 0 2px 8px rgba(0,123,255,0.4); 
}

#instructions-container { 
    position: absolute; 
    bottom: 10px; 
    right: 10px; 
    z-index: 1001; 
    max-width: 300px; 
    background: rgba(255,255,255,0.9); 
    backdrop-filter: blur(10px); 
    border-radius: 10px; 
    box-shadow: 0 4px 14px rgba(0,0,0,0.25); 
    padding: 15px; 
    font-size: 0.9em; 
    transition: transform 0.3s ease, opacity 0.3s ease; 
    transform: translateY(20px); 
    opacity: 0.95; 
}

#instructions-container.show { 
    transform: translateY(0); 
    opacity: 1; 
}

#toggleInstructions { 
    background: #007bff; 
    border: none; 
    color: white; 
    padding: 8px 12px; 
    border-radius: 5px; 
    cursor: pointer; 
    font-size: 0.85em; 
    margin-bottom: 5px; 
    min-height: 44px;
}

#instructionsList { 
    max-height: 200px; 
    overflow-y: auto; 
    padding-left: 10px; 
}

#instructionsList li { 
    padding: 8px; 
    margin-bottom: 4px; 
    border-radius: 6px; 
    transition: 0.2s; 
    min-height: 44px;
    display: flex;
    align-items: center;
}

#instructionsList li.current { 
    background: #007bff; 
    color: white; 
    font-weight: bold; 
    box-shadow: 0 2px 6px rgba(0,123,255,0.4); 
}

.leaflet-container { 
    cursor: url('https://maps.gstatic.com/mapfiles/openhand_8_8.cur'), move; 
}

#toggleLayersBtn { 
    position: absolute; 
    top: 50px; 
    right: 10px; 
    z-index: 1002; 
    padding: 12px 16px; 
    border: none; 
    background: #007bff; 
    color: white; 
    border-radius: 8px; 
    cursor: pointer;
    font-size: 0.85em;
    min-height: 44px;
}

/* Contrôles de zoom personnalisés pour navigation */
#zoom-controls {
    position: absolute;
    top: 150px;
    right: 10px;
    z-index: 1002;
    display: none;
    flex-direction: column;
    gap: 5px;
}

.zoom-btn {
    width: 44px;
    height: 44px;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid #ccc;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2em;
    font-weight: bold;
    color: #333;
    transition: all 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    min-height: 44px;
    min-width: 44px;
}

.zoom-btn:hover {
    background: #007bff;
    color: white;
    transform: scale(1.1);
}

/* Petit bouton de fermeture pour les panneaux */
.panel-close {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 1px solid #ccc;
    background: #f1f3f5;
    color: #333;
    font-weight: 700;
    line-height: 26px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.panel-close:hover { background: #e9ecef; }
.panel-close:active { transform: scale(0.95); }

/* Rapport de livraison */
#delivery-report-container {
    position: fixed;
    top: 90px;
    left: 300px;
    z-index: 1000;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    width: 350px;
    max-width: calc(100vw - 40px);
    display: none;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
}

#delivery-report-container h3 {
    margin-top: 0;
    color: #007bff;
    text-align: center;
    margin-bottom: 20px;
    font-size: 1.3em;
}

.delivery-option {
    margin-bottom: 15px;
}

.delivery-option input[type="radio"] {
    margin-right: 10px;
    transform: scale(1.5);
    min-height: 20px;
    min-width: 20px;
}

.delivery-option label {
    font-weight: 500;
    color: #333;
    cursor: pointer;
    display: flex;
    align-items: center;
    padding: 8px;
    min-height: 44px;
}

.delivery-option label.delivered {
    color: #28a745;
}

.delivery-option label.not-delivered {
    color: #dc3545;
}

#reason-container {
    display: none;
    margin-top: 10px;
}

#reason-text {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    resize: vertical;
    min-height: 80px;
    font-family: inherit;
    font-size: 0.9em;
    box-sizing: border-box;
}

#reason-text:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.4);
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #333;
}

.form-group input, .form-group textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 0.9em;
    box-sizing: border-box;
    min-height: 44px;
}

.form-group input:focus, .form-group textarea:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.4);
}

.datetime-group {
    display: flex;
    gap: 10px;
}

.datetime-group .form-group {
    flex: 1;
}

#submit-report {
    width: 100%;
    padding: 14px;
    background: linear-gradient(145deg, #28a745, #1e7e34);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    margin-top: 10px;
    min-height: 48px;
}

#submit-report:hover {
    background: linear-gradient(145deg, #1e7e34, #155724);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

#submit-report:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

#toggle-delivery-report {
    background: linear-gradient(145deg, #28a745, #1e7e34);
    color: white;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    width: 100%;
    padding: 12px;
    margin-bottom: 8px;
    border: none;
    min-height: 48px;
}

#toggle-delivery-report:hover {
    background: linear-gradient(145deg, #1e7e34, #155724);
    transform: translateY(-2px);
}

.success-message, .error-message {
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: none;
}

.success-message {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.error-message {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

/* Interface Admin */
#admin-container { display: none; }
#admin-header {
    display: flex; 
    align-items: center; 
    justify-content: space-between;
    background: #343a40; 
    color: #fff; 
    padding: 12px 16px;
    flex-wrap: wrap;
    gap: 10px;
}
#admin-header .title { 
    display: flex; 
    align-items: center; 
    gap: 12px; 
    flex: 1;
}
#admin-header img { width: 36px; }
#admin-actions { 
    display: flex; 
    gap: 8px; 
    flex-wrap: wrap;
}
.admin-btn {
    padding: 12px 16px; 
    border: none; 
    border-radius: 8px; 
    cursor: pointer; 
    color: #fff;
    background: #007bff; 
    font-weight: 600;
    font-size: 0.9em;
    min-height: 44px;
}
.admin-btn.secondary { background: #6c757d; }
.admin-btn.danger { background: #dc3545; }
#admin-main { 
    display: grid; 
    grid-template-columns: 1fr; 
    gap: 12px; 
    padding: 12px; 
}
#admin-panel {
    background: #fff; 
    border-radius: 12px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
    padding: 12px;
    order: 2;
}
#admin-panel h2 { 
    margin: 0 0 10px; 
    color: #007bff; 
    font-size: 1.3em; 
}
#admin-search { 
    width: 100%; 
    padding: 12px; 
    border: 1px solid #ddd; 
    border-radius: 8px; 
    margin-bottom: 8px;
    box-sizing: border-box;
    min-height: 44px;
}
#reports-table { 
    width: 100%; 
    border-collapse: collapse; 
    font-size: 0.85em;
    overflow-x: auto;
}
#reports-table th, #reports-table td { 
    border-bottom: 1px solid #eee; 
    padding: 8px 6px; 
    text-align: left;
    word-wrap: break-word;
}
#reports-table th { 
    position: sticky; 
    top: 0; 
    background: #f7f9fc; 
    z-index: 1; 
    font-size: 0.8em;
}
.status-badge { 
    padding: 4px 8px; 
    border-radius: 999px; 
    font-weight: 700; 
    font-size: 0.7em;
    white-space: nowrap;
}
.status-ok { background: #d4edda; color: #155724; }
.status-ko { background: #f8d7da; color: #721c24; }
.row-actions button { 
    border: none; 
    border-radius: 6px; 
    padding: 6px 8px; 
    margin-right: 2px; 
    cursor: pointer;
    font-size: 0.7em;
    min-height: 32px;
    min-width: 32px;
}
.row-actions .focus { background: #17a2b8; color: #fff; }
.row-actions .edit { background: #28a745; color: #fff; }
.row-actions .delete { background: #ffc107; color: #000; }
#admin-map { 
    height: 400px; 
    border-radius: 12px; 
    overflow: hidden; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    order: 1;
}
#empty-state { 
    font-size: 0.95em; 
    color: #555; 
    padding: 8px 0 0; 
}

#top-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}
.top-btn {
    padding: 8px 12px;
    border: none;
    border-radius: 999px;
    cursor: pointer;
    font-weight: 700;
    background: #ffffff;
    color: #007bff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    font-size: 0.85em;
    min-height: 36px;
}
.top-btn.danger { color: #fff; background: #dc3545; }
.top-btn.dark { color: #fff; background: #343a40; }

/* Route Options Container */
#route-options-container {
    position: fixed;
    top: 90px;
    left: 300px;
    z-index: 1000;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    width: 400px;
    max-width: calc(100vw - 40px);
    display: none;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
}

#route-options-container h3 {
    margin-top: 0;
    color: #007bff;
    text-align: center;
    margin-bottom: 20px;
    font-size: 1.3em;
}

.route-option {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.3s;
    background: #f8f9fa;
    min-height: 44px;
}

.route-option:hover {
    border-color: #007bff;
    background: #e7f3ff;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.route-option.selected {
    border-color: #007bff;
    background: #007bff;
    color: white;
}

.route-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.route-type {
    font-weight: bold;
    font-size: 1.1em;
}

.route-duration {
    background: #28a745;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.9em;
}

.route-distance {
    color: #666;
    font-size: 0.9em;
    margin-bottom: 5px;
}

.route-description {
    font-size: 0.85em;
    color: #555;
}

#select-route-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(145deg, #007bff, #0056b3);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    margin-top: 15px;
    min-height: 48px;
}

#select-route-btn:hover {
    background: linear-gradient(145deg, #0056b3, #003f7f);
    transform: translateY(-2px);
}

#select-route-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
}

/* Digital Signature Container */
#signature-container {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1500;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(10px);
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 500px;
    display: none;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

#signature-container h3 {
    margin-top: 0;
    color: #007bff;
    text-align: center;
    margin-bottom: 20px;
    font-size: 1.4em;
}

#signature-pad {
    border: 2px solid #007bff;
    border-radius: 8px;
    display: block;
    margin: 0 auto 20px;
    background: white;
    touch-action: none;
    max-width: 100%;
    height: auto;
}

.signature-controls {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.signature-btn {
    padding: 12px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    min-height: 44px;
    flex: 1;
    min-width: 120px;
}

.signature-btn.clear {
    background: #ffc107;
    color: #000;
}

.signature-btn.save {
    background: #28a745;
    color: white;
}

.signature-btn.cancel {
    background: #dc3545;
    color: white;
}

.signature-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.signature-info {
    background: #f8f9fa;
    border-left: 4px solid #007bff;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 0 8px 8px 0;
}

.signature-info h4 {
    margin: 0 0 10px 0;
    color: #007bff;
}

.signature-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1400;
    display: none;
}

/* Envoi Facture */
#invoice-send-container {
    position: fixed;
    top: 90px;
    left: 300px;
    z-index: 1000;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    width: 350px;
    max-width: calc(100vw - 40px);
    display: none;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
}
#invoice-send-container h3 {
    margin-top: 0;
    color: #007bff;
    text-align: center;
    margin-bottom: 20px;
    font-size: 1.3em;
}
.quick-action-btn {
    padding: 8px 10px;
    background: linear-gradient(145deg, #6c757d, #495057);
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 0.8em;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    min-height: 44px;
}

.quick-action-btn:hover {
    background: linear-gradient(145deg, #5a6268, #343a40);
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.15);
}

.quick-action-btn:active {
    transform: translateY(0);
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

#quick-actions-btn:hover {
    background: linear-gradient(145deg, #218838, #1e7e34);
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(40, 167, 69, 0.3);
}

#toggle-invoice-send {
    background: linear-gradient(145deg, #0069d9, #004a9f);
    color: #fff; 
    border-radius: 8px; 
    cursor: pointer; 
    font-weight: 600;
    transition: all .3s; 
    box-shadow: 0 2px 6px rgba(0,0,0,.2);
    width: 100%; 
    padding: 12px; 
    margin-bottom: 8px; 
    border: none;
    min-height: 48px;
}
#toggle-invoice-send:hover {
    background: linear-gradient(145deg, #004a9f, #003a80);
    transform: translateY(-2px);
}
#send-invoice {
    width: 100%;
    padding: 14px;
    background: linear-gradient(145deg, #0069d9, #004a9f);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    margin-top: 8px;
    min-height: 48px;
}
#send-invoice:hover { 
    background: linear-gradient(145deg, #004a9f, #003a80); 
    transform: translateY(-2px); 
}
#send-invoice:disabled { 
    background: #6c757d; 
    cursor: not-allowed; 
    transform: none; 
}
#invoice-success-msg, #invoice-error-msg {
    padding: 10px; 
    border-radius: 8px; 
    margin-bottom: 12px; 
    display: none; 
    border: 1px solid transparent;
}
#invoice-success-msg { 
    background: #d4edda; 
    color: #155724; 
    border-color: #c3e6cb; 
}
#invoice-error-msg { 
    background: #f8d7da; 
    color: #721c24; 
    border-color: #f5c6cb; 
}
.small-muted { 
    font-size: .85em; 
    color: #666; 
}
.accepted-types { 
    font-size: .85em; 
    color: #007bff; 
}

/* Suppression des bordures des tuiles */
.leaflet-tile,
.leaflet-tile-container img,
.leaflet-layer,
.leaflet-tile-pane,
.leaflet-map-pane,
.leaflet-pane {
    border: none !important;
    box-shadow: none !important;
    outline: none !important;
    background: none !important;
}

/* Loading States and Progress Indicators */
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 8px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.progress-bar {
    width: 100%;
    height: 4px;
    background: var(--divider-color);
    border-radius: 2px;
    overflow: hidden;
    margin: 8px 0;
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
    border-radius: 2px;
    transition: width var(--transition-medium);
    width: 0%;
}

/* Status Cards */
.status-card {
    background: var(--surface-color);
    border-radius: var(--border-radius);
    padding: 16px;
    margin: 8px 0;
    box-shadow: var(--shadow-1);
    border-left: 4px solid var(--primary-color);
    transition: all var(--transition-fast);
}

.status-card:hover {
    box-shadow: var(--shadow-2);
    transform: translateY(-2px);
}

.status-card.success {
    border-left-color: var(--success-color);
}

.status-card.warning {
    border-left-color: var(--warning-color);
}

.status-card.error {
    border-left-color: var(--error-color);
}

/* Toast Notifications */
.toast-container {
    position: fixed;
    top: 100px;
    right: 20px;
    z-index: 10000;
    pointer-events: none;
}

.toast {
    background: var(--surface-color);
    color: var(--text-primary);
    padding: 16px 20px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-3);
    margin-bottom: 12px;
    transform: translateX(400px);
    transition: all var(--transition-medium);
    pointer-events: auto;
    border-left: 4px solid var(--primary-color);
    max-width: 300px;
}

.toast.show {
    transform: translateX(0);
}

.toast.success {
    border-left-color: var(--success-color);
}

.toast.error {
    border-left-color: var(--error-color);
}

.toast.warning {
    border-left-color: var(--warning-color);
}
.main-route-line {
    border-radius: 3px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.route-progress-line {
    border-radius: 3px;
    box-shadow: 0 2px 6px rgba(0,123,255,0.3);
    z-index: 1000;
}

/* Amélioration des contrôles de navigation */
#zoom-controls {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-radius: 8px;
    overflow: hidden;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(5px);
}

.zoom-btn {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.zoom-btn:hover {
    background: #007bff;
    color: white;
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0,123,255,0.3);
}

.zoom-btn:active {
    transform: scale(0.95);
}

/* Masquer les contrôles par défaut de Leaflet Routing Machine */
.leaflet-routing-container {
    display: none !important;
}

.leaflet-routing-alternatives-container {
    display: none !important;
}

/* Amélioration de la carte pendant la navigation */
.leaflet-container.navigation-mode {
    cursor: crosshair;
}

/* Styles pour les marqueurs personnalisés */
.custom-marker {
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
}

/* Animation fluide pour les marqueurs */
@keyframes markerPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.pulse-marker {
    animation: markerPulse 2s infinite;
}

/* ====================== MEDIA QUERIES RESPONSIVE AMÉLIORÉES ====================== */

/* Très grands écrans (4K, UltraWide) */
@media screen and (min-width: 1920px) {
    #header h1 {
        font-size: 1.6em;
    }
    
    #sidebar {
        width: 380px;
    }
    
    #map {
        margin-left: 380px;
    }
    
    #delivery-report-container,
    #invoice-send-container,
    #route-options-container {
        left: 400px;
        width: 420px;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
        font-size: 1em;
        padding: 16px 14px;
    }
}

/* Écrans moyens (laptops) */
@media screen and (max-width: 1366px) {
    #sidebar {
        width: 300px;
    }
    
    #map {
        margin-left: 300px;
    }
    
    #delivery-report-container,
    #invoice-send-container,
    #route-options-container {
        left: 320px;
        width: 340px;
    }
}

/* Petites tablettes et laptops compacts */
@media screen and (max-width: 1024px) {
    #admin-main {
        grid-template-columns: 1fr;
    }
    
    #layer-container {
        right: 5px;
        top: 85px;
    }
    
    .layer-preview {
        width: 44px;
        height: 44px;
    }
    
    #instructions-container {
        max-width: 280px;
        bottom: 5px;
        right: 5px;
        font-size: 0.85em;
    }
    
    #delivery-report-container,
    #invoice-send-container,
    #route-options-container {
        left: 20px;
        width: calc(100% - 40px);
        max-width: 400px;
    }
    
    /* Amélioration pour tablettes en mode paysage */
    #sidebar {
        width: 280px;
    }
    
    #map {
        margin-left: 280px;
    }
}

/* Tablettes en mode portrait */
@media screen and (max-width: 820px) {
    #sidebar {
        width: 100%;
        max-width: 320px;
        transform: translateX(-100%);
        z-index: 1100;
        box-shadow: 4px 0 20px rgba(0,0,0,0.4);
    }
    
    #map {
        margin-left: 0;
    }
    
    #sidebar-toggle {
        display: flex;
        top: 90px;
        left: 15px;
    }
    
    #delivery-report-container,
    #invoice-send-container,
    #route-options-container {
        left: 10px;
        right: 10px;
        width: auto;
        max-width: none;
    }
}

/* Smartphones et petites tablettes - Amélioré */
@media screen and (max-width: 768px) {
    /* Variables pour mobile */
    :root {
        --mobile-padding: 12px;
        --mobile-font-size: 0.9em;
        --mobile-button-height: 48px;
        --mobile-input-height: 44px;
    }
    /* Header responsive */
    #header {
        padding: 12px 15px;
        height: 70px;
        flex-direction: row;
        justify-content: space-between;
    }
    
    #header .header-content {
        position: static;
        transform: none;
        justify-content: flex-start;
        flex: 1;
        order: 2;
    }
    
    #header h1 {
        font-size: 1.1em;
        text-align: left;
        line-height: 1.2;
    }
    
    #header img {
        width: 32px;
        height: auto;
        margin-right: 8px;
    }
    
    /* Bouton hamburger visible */
    #menu-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        order: 1;
    }
    
    #top-actions {
        order: 3;
        margin-right: 0;
    }
    
    .top-btn {
        padding: 6px 8px;
        font-size: 0.75em;
        min-height: 36px;
    }
    
    /* Map adaptation */
    #map {
        height: calc(100vh - 70px);
        margin-top: 70px;
        margin-left: 0;
    }
    
    /* Sidebar devient overlay sur mobile */
    #sidebar {
        width: 100%;
        max-width: 340px;
        transform: translateX(-100%);
        z-index: 1100;
        box-shadow: 4px 0 20px rgba(0,0,0,0.4);
        border-radius: 0;
        top: 70px;
        padding: 20px;
    }
    
    #sidebar.show {
        transform: translateX(0);
    }
    
    /* Sidebar toggle adaptattion */
    #sidebar-toggle {
        display: none;
    }
    
    /* Overlay pour fermer la sidebar */
    #sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1050;
        display: none;
    }
    
    #sidebar-overlay.show {
        display: block;
    }
    
    /* Containers repositionnement */
    #delivery-report-container,
    #invoice-send-container,
    #route-options-container {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 380px;
        max-height: 85vh;
        z-index: 1200;
        overflow-y: auto;
    }

    /* Bouton de fermeture plus grand et tactile sur mobile */
    .panel-close {
        top: 6px;
        right: 6px;
        width: 36px;
        height: 36px;
        line-height: 34px;
        font-size: 18px;
        z-index: 2;
    }
    
    /* Signature container mobile */
    #signature-container {
        width: 95%;
        max-width: 450px;
        padding: 20px;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    #signature-pad {
        width: 100%;
        height: 180px;
        border: 3px solid #007bff;
        touch-action: none; /* Optimise les interactions tactiles */
    }
    
    /* Amélioration de la zone de signature pour écrans tactiles */
    .signature-info {
        font-size: 0.9em;
        padding: 12px;
    }
    
    .signature-controls {
        flex-direction: column;
        gap: 8px;
    }
    
    .signature-btn {
        min-width: auto;
        flex: none;
    }
    
    /* Actions Rapides mobile */
    #quick-actions-panel {
        margin-top: 10px !important;
        padding: 12px !important;
    }
    
    .quick-action-btn {
        padding: 10px 6px !important;
        font-size: 0.75em !important;
    }
    
    #quick-actions-btn {
        padding: 12px !important;
        font-size: 0.9em !important;
    }
    
    /* Layer container adapté */
    #layer-container {
        top: 80px;
        right: 5px;
        padding: 6px;
        flex-direction: row;
        flex-wrap: wrap;
        max-width: calc(100vw - 20px);
    }
    
    .layer-preview {
        width: 40px;
        height: 40px;
        margin: 3px;
    }
    
    /* Instructions container mobile */
    #instructions-container {
        bottom: 5px;
        right: 5px;
        left: 5px;
        max-width: none;
        font-size: 0.8em;
        padding: 12px;
    }
    
    #toggleInstructions {
        font-size: 0.8em;
        padding: 10px 12px;
    }
    
    #instructionsList {
        max-height: 150px;
    }
    
    /* Toggle layers button */
    #toggleLayersBtn {
        top: 80px;
        right: 50px;
        padding: 8px 10px;
        font-size: 0.8em;
    }
    
    /* Zoom controls */
    #zoom-controls {
        top: 130px;
        right: 8px;
    }
    
    .zoom-btn {
        width: 40px;
        height: 40px;
        font-size: 1.1em;
    }
    
    /* Interface Admin responsive */
    #admin-header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 15px;
    }
    
    #admin-header .title {
        justify-content: center;
        text-align: center;
    }
    
    #admin-actions {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    #admin-main {
        padding: 10px;
        gap: 10px;
    }
    
    #admin-panel {
        padding: 12px;
    }
    
    #reports-table {
        font-size: 0.75em;
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }
    
    #reports-table th,
    #reports-table td {
        padding: 6px 4px;
        min-width: 80px;
    }
    
    .status-badge {
        font-size: 0.65em;
        padding: 2px 6px;
    }
    
    .row-actions {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .row-actions button {
        padding: 4px 6px;
        font-size: 0.65em;
        margin-right: 0;
        min-height: 28px;
    }
    
    #admin-map {
        height: 300px;
    }
    
    /* Form groups responsive */
    .datetime-group {
        flex-direction: column;
        gap: 8px;
    }
    
    /* Login responsive */
    #login-container {
        padding: 25px;
        margin: 15px;
    }
    
    #login-container h2 {
        font-size: 1.6em;
    }
    
    /* Modal edit responsive */
    #edit-modal > div {
        width: 95%;
        max-width: 400px;
        padding: 20px;
    }
    
    /* View signature modal responsive */
    #signature-view-modal > div {
        width: 95%;
        max-width: 450px;
        padding: 18px;
    }
}

/* Très petits écrans */
@media screen and (max-width: 480px) {
    #header {
        height: 65px;
        padding: 10px 12px;
    }
    
    #header h1 {
        font-size: 1em;
        line-height: 1.1;
    }
    
    #header img {
        width: 28px;
        margin-right: 6px;
    }
    
    #map {
        height: calc(100vh - 65px);
        margin-top: 65px;
    }
    
    #sidebar {
        max-width: 300px;
        padding: 16px;
        top: 65px;
    }
    
    #sidebar h3 {
        font-size: 1em;
        margin-bottom: 12px;
    }
    
    #sidebar button {
        padding: 12px;
        font-size: 0.85em;
    }
    
    #delivery-report-container,
    #invoice-send-container,
    #route-options-container {
        width: 95%;
        padding: 16px;
        max-height: 90vh;
    }
    
    .layer-preview {
        width: 36px;
        height: 36px;
        margin: 2px;
    }
    
    #instructions-container {
        font-size: 0.75em;
        padding: 10px;
    }
    
    #reports-table {
        font-size: 0.7em;
    }
    
    .status-badge {
        font-size: 0.6em;
        padding: 1px 4px;
    }
    
    .row-actions button {
        font-size: 0.6em;
        padding: 2px 4px;
        min-height: 26px;
    }
    
    .zoom-btn {
        width: 36px;
        height: 36px;
        font-size: 1em;
    }
    
    #toggleLayersBtn {
        padding: 6px 8px;
        font-size: 0.75em;
    }
    
    #signature-container {
        width: 98%;
        padding: 15px;
    }
    
    #signature-pad {
        height: 120px;
    }
    
    .signature-btn {
        padding: 10px;
        font-size: 0.9em;
    }
    
    /* Form elements plus grands sur très petits écrans - Amélioré */
    .form-group input, 
    .form-group textarea,
    .form-group select,
    #sidebar input,
    #sidebar select {
        padding: 16px 14px;
        font-size: 16px; /* Évite le zoom sur iOS */
        border-radius: 8px;
        border: 2px solid #ddd;
        min-height: var(--mobile-input-height);
        touch-action: manipulation; /* Améliore les interactions tactiles */
    }
    
    /* Boutons plus tactiles */
    button,
    #sidebar button,
    .signature-btn,
    .admin-btn,
    .top-btn {
        min-height: var(--mobile-button-height);
        padding: 14px 16px;
        font-size: var(--mobile-font-size);
        touch-action: manipulation;
        cursor: pointer;
    }
    
    .delivery-option input[type="radio"] {
        transform: scale(1.8);
        margin-right: 12px;
    }
    
    .delivery-option label {
        padding: 12px 8px;
        font-size: 0.95em;
    }
}

/* Améliorations pour différentes orientations */

/* Orientation portrait sur mobile */
@media screen and (max-width: 768px) and (orientation: portrait) {
    #header {
        height: 70px;
    }
    
    #map {
        height: calc(100vh - 70px);
        margin-top: 70px;
    }
    
    #delivery-report-container,
    #invoice-send-container,
    #route-options-container {
        max-height: calc(100vh - 100px);
        overflow-y: auto;
    }
}

/* Orientation paysage sur mobile */
@media screen and (max-height: 500px) and (orientation: landscape) {
    #header {
        height: 60px;
        padding: 8px 15px;
    }
    
    #header h1 {
        font-size: 1em;
    }
    
    #map {
        height: calc(100vh - 60px);
        margin-top: 60px;
    }
    #delivery-report-container,
    #invoice-send-container,
    #route-options-container {
        max-height: 95vh;
        top: 2.5%;
        transform: translate(-50%, 0);
    }
    
    #instructions-container {
        max-height: 120px;
        font-size: 0.7em;
    }
    
    #instructionsList {
        max-height: 80px;
    }
    
    #signature-container {
        max-height: 95vh;
        overflow-y: auto;
    }
    
    #admin-map {
        height: 250px;
    }
}

/* Très petite hauteur d'écran */
@media screen and (max-height: 600px) {
    #delivery-report-container,
    #invoice-send-container,
    #route-options-container {
        max-height: 85vh;
        padding: 15px;
    }
    
    .form-group {
        margin-bottom: 12px;
    }
    
    #signature-container {
        padding: 15px;
    }
    
    #signature-pad {
        height: 120px;
    }
}

/* Support des écrans avec notch (iPhone X et plus récents) */
@supports (padding: max(0px)) {
    #header {
        padding-left: max(var(--mobile-padding), env(safe-area-inset-left));
        padding-right: max(var(--mobile-padding), env(safe-area-inset-right));
    }
    
    #sidebar {
        padding-left: max(var(--mobile-padding), env(safe-area-inset-left));
        padding-right: max(var(--mobile-padding), env(safe-area-inset-right));
    }
    
    #delivery-report-container,
    #invoice-send-container,
    #route-options-container {
        left: max(10px, env(safe-area-inset-left));
        right: max(10px, env(safe-area-inset-right));
    }
}

/* Interface tactile améliorée */
@media (hover: none) and (pointer: coarse) {
    /* Augmenter les zones de touch sur les appareils tactiles */
    button, 
    .layer-preview, 
    #companyList li,
    .route-option,
    .zoom-btn,
    input[type="radio"],
    input[type="checkbox"] {
        min-height: 44px;
        min-width: 44px;
    }
    
    /* Réduire les effets hover sur tactile */
    .layer-preview:hover,
    .route-option:hover,
    .zoom-btn:hover {
        transform: none;
    }
    
    /* Améliorer le feedback tactile */
    button:active,
    .layer-preview:active,
    .zoom-btn:active {
        opacity: 0.7;
        transform: scale(0.95);
    }
}

/* Mode sombre automatique */
@media (prefers-color-scheme: dark) {
    :root {
        --background-color: #121212;
        --surface-color: #1e1e1e;
        --text-primary: #ffffff;
        --text-secondary: #b3b3b3;
        --divider-color: #333333;
    }
    
    body {
        background: var(--background-color);
        color: var(--text-primary);
    }
    
    #sidebar {
        background: var(--surface-color);
    }
    
    .form-group input, 
    .form-group textarea,
    .form-group select,
    #sidebar input,
    #sidebar select {
        background: var(--surface-color);
        color: var(--text-primary);
        border-color: var(--divider-color);
    }
    
    #instructions-container,
    #delivery-report-container,
    #invoice-send-container,
    #route-options-container,
    #signature-container {
        background: rgba(30, 30, 30, 0.95);
        color: var(--text-primary);
    }
}

/* Préférences d'animation réduites */
@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
    
    .loading-spinner {
        animation: none;
    }
    
    .pulse-marker {
        animation: none;
    }
}
/* ====================== ANDROID: STYLES SPÉCIFIQUES ====================== */
.is-android button,
.is-mobile button,
.is-android #sidebar button,
.is-mobile #sidebar button,
.is-android .signature-btn,
.is-mobile .signature-btn,
.is-android .admin-btn,
.is-mobile .admin-btn,
.is-android .top-btn,
.is-mobile .top-btn,
.is-android .quick-action-btn,
.is-mobile .quick-action-btn {
    min-height: 52px;
    padding: 14px 16px;
    font-size: 1rem;
}

.is-android .form-group input,
.is-mobile .form-group input,
.is-android .form-group textarea,
.is-mobile .form-group textarea,
.is-android .form-group select,
.is-mobile .form-group select,
.is-android #sidebar input,
.is-mobile #sidebar input,
.is-android #sidebar select,
.is-mobile #sidebar select {
    min-height: 48px;
    padding: 14px 12px;
    font-size: 16px; /* évite le zoom auto iOS/Android */
    margin-bottom: 14px;
}

.is-android .form-group, .is-mobile .form-group { margin-bottom: 16px; }

/* Panneaux plein écran sur petits écrans Android */
@media screen and (max-width: 480px), screen and (max-height: 600px) {
.is-android #delivery-report-container,
    .is-mobile #delivery-report-container,
    .is-android #invoice-send-container,
    .is-mobile #invoice-send-container,
    .is-android #route-options-container,
    .is-mobile #route-options-container {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        transform: none;
        width: 100%; max-width: none;
        height: calc(var(--vh, 1vh) * 100);
        max-height: none;
        border-radius: 0;
        padding: max(16px, env(safe-area-inset-top)) max(16px, env(safe-area-inset-right)) max(16px, env(safe-area-inset-bottom)) max(16px, env(safe-area-inset-left));
        z-index: 2000;
    }

    .is-android .panel-close, .is-mobile .panel-close {
        top: max(8px, env(safe-area-inset-top));
        right: max(8px, env(safe-area-inset-right));
    }
}

/* Carte: corriger 100vh sur Android (barres du navigateur) */
@media screen and (max-width: 768px) {
    .is-android #map, .is-mobile #map {
        height: calc(var(--vh, 1vh) * 100 - 70px);
    }
}

/* Cibles tactiles plus larges pour Android */
.is-android .layer-preview,
.is-mobile .layer-preview,
.is-android .zoom-btn,
.is-mobile .zoom-btn {
    min-width: 48px;
    min-height: 48px;
}

/* Réduire le rebond de scroll sur Android pour les panneaux */
.is-android #delivery-report-container,
.is-mobile #delivery-report-container,
.is-android #invoice-send-container,
.is-mobile #invoice-send-container,
.is-android #route-options-container,
.is-mobile #route-options-container {
    overscroll-behavior: contain;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
<!-- Overlay sidebar pour mobile -->
<div id="sidebar-overlay"></div>

<!-- Page de connexion -->
<div id="login-overlay">
    <div id="login-container">
        <h2>Connexion au Système</h2>
        <input type="text" id="username" class="login-input" placeholder="Nom d'utilisateur" autocomplete="off">
        <input type="password" id="password" class="login-input" placeholder="Mot de passe" autocomplete="off">
        <button id="login-btn">Se connecter</button>
        <div id="login-error">Identifiants incorrects. Veuillez réessayer.</div>
        <!-- Astuce d'identifiants -->
        <div style="margin-top:10px;color:#ffffffcc;font-size:0.9em">
            <div><strong>Agent :</strong> IMPOTS / IMPOTS 229</div>
            <div><strong>Admin :</strong> ADMIN / ADMIN229</div>
        </div>
    </div>
</div>

<!-- Application principale (Agent) -->
<div id="app-container">
    <!-- Bouton pour cacher/afficher la sidebar -->
    <button id="sidebar-toggle">☰</button>
    
    <div id="header">
        <button id="menu-toggle">☰</button>
        <div class="header-content">
            <img src="https://upload.wikimedia.org/wikipedia/commons/0/0a/Flag_of_Benin.svg" alt="Drapeau Bénin" style="width: 45px; height: 30px; margin-right: 15px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
            <h1>Système de Distribution des Factures Impôts</h1>
            <img src="https://upload.wikimedia.org/wikipedia/commons/0/0a/Flag_of_Benin.svg" alt="Drapeau Bénin" style="width: 45px; height: 30px; margin-left: 15px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
        </div>
        <div id="top-actions" style="display:none;">
            <button id="switch-to-admin" class="top-btn dark">Admin</button>
            <button id="logout-btn" class="top-btn danger">Déconnexion</button>
        </div>
    </div>
    
    <div id="sidebar">
        <div id="coordContainer">
            <h3>Recherche par coordonnées</h3>
            <input id="latInput" placeholder="Latitude (ex: 6.348958)" type="text">
            <input id="lngInput" placeholder="Longitude (ex: 2.386909)" type="text">
            <select id="coordType">
                <option value="geo">Géographique (Lat/Lng)</option>
                <option value="utm">UTM / Métrique</option>
            </select>
            <button id="coordBtnSidebar">📍 Aller</button>
        </div>
        <div id="searchControls">
            <h3>Rechercher une Structure</h3>
            <input type="text" id="searchStructureInput" placeholder="Nom de la structure">
            <button id="searchStructureBtn">🔍 Rechercher</button>
            <button id="locateBtn">📍 Me localiser</button>
            <button id="toggleVoice">🔊 Voix ON/OFF</button>
        </div>
        <div id="companySection">
            <button id="toggleCompanies">📂 Afficher/Cacher entreprises</button>
            <ul id="companyList"></ul>
        </div>
        <div id="routeControls">
            <h3>Navigation</h3>
            
            <!-- Statistics Dashboard -->
            <div class="status-card" id="stats-card" style="display: none;">
                <h4 style="margin: 0 0 12px 0; color: var(--primary-color);">📊 Statistiques</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85em;">
                    <div>Distance: <strong id="total-distance">0 km</strong></div>
                    <div>Temps: <strong id="estimated-time">0 min</strong></div>
                    <div>Progrès: <strong id="route-progress">0%</strong></div>
                    <div>Vitesse: <strong id="current-speed">0 km/h</strong></div>
                </div>
                <div class="progress-bar">
                    <div class="progress-bar-fill" id="navigation-progress"></div>
                </div>
            </div>
            
            <button id="pauseRoute">⏸️ Pause</button>
            <button id="resumeRoute">▶️ Reprendre</button>
            <button id="stopRoute">🛑 Arrêter</button>
            <button id="toggle-delivery-report">📋 Rapport Livraison</button>
            <button id="toggle-invoice-send">✉️ Envoi Facture</button>
            <button id="quick-actions-btn">🧭 Actions Rapides</button>
        </div>
        
        <!-- Panneau Actions Rapides -->
        <div id="quick-actions-panel" style="display: none; margin-top: 15px; padding: 15px; background: rgba(248, 249, 250, 0.95); border-radius: 8px; border: 1px solid #dee2e6;">
          <h4 style="margin: 0 0 12px 0; color: #495057; font-size: 1em;">🎯 Contrôles de Navigation</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
            <button id="rotate-left" class="quick-action-btn">↺ Gauche</button>
            <button id="rotate-right" class="quick-action-btn">↻ Droite</button>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <button id="reset-rotation" class="quick-action-btn">🧭 Normal</button>
            <button id="toggle-3d" class="quick-action-btn">🌍 Vue 3D</button>
          </div>
        </div>
    </div>
    
    <!-- Container pour le rapport de livraison -->
    <div id="delivery-report-container">
        <button class="panel-close" title="Fermer" data-target="delivery-report-container">✖</button>
        <h3>📋 Rapport de Livraison</h3>
        
        <div id="success-message" class="success-message"></div>
        <div id="error-message" class="error-message"></div>
        
        <div class="delivery-option">
            <label class="delivered">
                <input type="radio" name="delivery-status" value="delivered" id="delivered-radio">
                ✅ Facture Livrée
            </label>
        </div>
        
        <div class="delivery-option">
            <label class="not-delivered">
                <input type="radio" name="delivery-status" value="not-delivered" id="not-delivered-radio">
                ❌ Facture Non Livrée
            </label>
        </div>
        
        <div id="reason-container">
            <label for="reason-text">Raison de la non-livraison :</label>
            <textarea id="reason-text" placeholder="Veuillez préciser la raison..."></textarea>
        </div>
        
        <div class="form-group">
            <label for="agent-name">Nom et Prénoms de l'Agent :</label>
            <input type="text" id="agent-name" placeholder="Nom complet de l'agent">
        </div>
        
        <div class="form-group">
            <label for="agent-contact">Contact :</label>
            <input type="tel" id="agent-contact" placeholder="Numéro de téléphone">
        </div>
        
        <div class="datetime-group">
            <div class="form-group">
                <label for="delivery-date">Date de livraison :</label>
                <input type="date" id="delivery-date">
            </div>
            
            <div class="form-group">
                <label for="delivery-time">Heure de livraison :</label>
                <input type="time" id="delivery-time">
            </div>
        </div>
        
        <div class="form-group">
            <label for="structure-name" style="display:none;">Structure ayant reçu la facture :</label>
            <input type="text" id="structure-name" placeholder="Nom de la structure" style="display:none;">
        </div>
        
        <div id="signature-section" style="display:none;">
            <div class="form-group">
                <label>Signature de réception :</label>
                <button id="open-signature-btn" type="button" style="width:100%;padding:10px;background:#007bff;color:white;border:none;border-radius:8px;cursor:pointer;">✍️ Obtenir la signature</button>
            </div>
            <div id="signature-preview" style="display:none;margin-top:10px;">
                <label>Signature obtenue :</label>
                <div style="border:1px solid #ddd;border-radius:8px;padding:10px;background:#f8f9fa;text-align:center;">
                    <img id="signature-image" style="max-width:100%;max-height:100px;border:1px solid #ccc;border-radius:4px;" />
                    <button id="change-signature-btn" type="button" style="margin-top:5px;padding:5px 10px;background:#ffc107;color:#000;border:none;border-radius:4px;cursor:pointer;font-size:0.8em;">Modifier</button>
                </div>
            </div>
        </div>
        
        <button id="submit-report">📤 Envoyer le Rapport</button>
    </div>

    <!-- Container pour l'envoi de facture -->
    <div id="invoice-send-container">
      <button class="panel-close" title="Fermer" data-target="invoice-send-container">✖</button>
      <h3>✉️ Envoi de Facture</h3>

      <div id="invoice-success-msg"></div>
      <div id="invoice-error-msg"></div>

      <form id="invoice-form" method="POST" enctype="multipart/form-data">
        <div class="form-group">
          <label for="invoice-file">Fichier facture (PDF/JPG/PNG) :</label>
          <input type="file" id="invoice-file" name="attachment" accept=".pdf,.jpg,.jpeg,.png" required>
          <div class="small-muted">Taille max recommandée: 7 Mo</div>
        </div>

        <div class="form-group">
          <label for="invoice-to">Adresse e‑mail destinataire :</label>
          <input type="email" id="invoice-to" name="to_email" placeholder="ex: facturation@structure.bj" required>
        </div>

        <div class="form-group">
          <label for="invoice-ref">Référence (n° de mail ou n° de facture) :</label>
          <input type="text" id="invoice-ref" name="invoice_ref" placeholder="Ex: FAC-2025-001 (optionnel)">
        </div>

        <div class="form-group">
          <label for="invoice-message">Message (optionnel) :</label>
          <textarea id="invoice-message" name="message" placeholder="Message d'accompagnement..."></textarea>
        </div>

        <div class="form-group">
          <label for="api-base">Adresse du serveur (optionnel)</label>
          <input type="text" id="api-base" placeholder="ex: http://192.168.1.10:5000">
          <div class="small-muted">Laissez vide pour détection automatique. Sur téléphone, entrez l'adresse IP du PC si nécessaire.</div>
          <button type="button" id="test-server" class="quick-action-btn" style="margin-top:8px;width:100%;">🔌 Tester la connexion</button>
        </div>

        <input type="hidden" name="from_name" id="invoice-from-name" value="">
        <input type="hidden" name="agent_contact" id="invoice-from-contact" value="">
        <input type="hidden" name="subject" id="invoice-subject" value="">
        <input type="hidden" name="company_name" id="invoice-company-name" value="">
      </form>

      <button id="send-invoice">🚀 Envoyer la facture</button>
      <div class="small-muted accepted-types">Formats acceptés: .pdf, .jpg, .jpeg, .png</div>
      <div class="small-muted">Astuce: le nom et le contact de l'agent (du Rapport de Livraison) sont repris comme expéditeur.</div>
    </div>
    
    <!-- Container pour les options de route -->
    <div id="route-options-container">
        <button class="panel-close" title="Fermer" data-target="route-options-container">✖</button>
        <h3>🛣️ Choisir votre itinéraire</h3>
        <div id="routes-list"></div>
        <button id="select-route-btn" disabled>Sélectionner cet itinéraire</button>
    </div>
    
    <!-- Signature digitale -->
    <div id="signature-overlay"></div>
    <div id="signature-container">
        <button class="panel-close" title="Fermer" data-target="signature-container">✖</button>
        <h3>✍️ Signature de réception</h3>
        <div class="signature-info">
            <h4>Information de livraison</h4>
            <p id="signature-delivery-info">Structure: <span id="signature-structure-name"></span></p>
        </div>
        <canvas id="signature-pad" width="400" height="200"></canvas>
        <div class="signature-controls">
            <button class="signature-btn clear" id="clear-signature">🗑️ Effacer</button>
            <button class="signature-btn save" id="save-signature">✅ Valider</button>
            <button class="signature-btn cancel" id="cancel-signature">❌ Annuler</button>
        </div>
    </div>
    
    <div id="layer-container"></div>
    <div id="map"></div>
    <div id="toggleLayersBtn">Fonds</div>
    
    <!-- Contrôles de zoom pour navigation -->
    <div id="zoom-controls">
        <button class="zoom-btn" id="zoom-in">+</button>
        <button class="zoom-btn" id="zoom-out">−</button>
        <button class="zoom-btn" id="zoom-follow" title="Suivre position">📍</button>
    </div>
    
    <div id="instructions-container">
        <button id="toggleInstructions">Instructions</button>
        <ul id="instructionsList" style="display:none;"></ul>
    </div>
</div>

<!-- Toast Notification Container -->
<div class="toast-container" id="toast-container"></div>

<!-- Interface Administrateur -->
<div id="admin-container">
    <div id="admin-header">
        <div class="title">
            <img src="https://upload.wikimedia.org/wikipedia/commons/0/0a/Flag_of_Benin.svg" alt="BJ">
            <strong>Interface Administrateur — Suivi des Rapports</strong>
        </div>
        <div id="admin-actions">
            <button id="toggle-admin-layers" class="admin-btn">🗺️ Fonds de Carte</button>
            <button id="switch-to-agent" class="admin-btn secondary">Mode Agent</button>
            <button id="export-csv" class="admin-btn">Exporter CSV</button>
            <button id="logout-btn-admin" class="admin-btn danger">Déconnexion</button>
        </div>
    </div>
    <div id="admin-main">
        <div id="admin-map"></div>
        
        <!-- Admin Layer Controls -->
        <div id="admin-layer-container" style="position: absolute; top: 10px; right: 10px; z-index: 1000; background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); padding: 10px; border-radius: 12px; display: none; flex-direction: column; box-shadow: 0 4px 12px rgba(0,0,0,0.25);"></div>
        
        <div id="admin-panel">
            <h2>📑 Rapports reçus</h2>
            <input id="admin-search" placeholder="Rechercher (agent, statut, raison, contact, date, heure)...">
            <div style="max-height: calc(100vh - 300px); overflow:auto; border:1px solid #eee; border-radius:8px;">
                <table id="reports-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Statut</th>
                            <th>Agent</th>
                            <th>Contact</th>
                            <th>Date</th>
                            <th>Heure</th>
                            <th>Raison</th>
                            <th>Structure</th>
                            <th>Signature</th>
                            <th>Position</th>
                            <th>Créé le</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reports-tbody">
                        <!-- Lignes injectées JS -->
                    </tbody>
                </table>
            </div>
            <div id="empty-state" style="display:none;">Aucun rapport pour le moment.</div>
        </div>
    </div>
</div>

<div id="edit-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:12000; padding:20px;">
  <div style="background:#fff; padding:16px; border-radius:8px; width:100%; max-width:420px; box-shadow:0 6px 18px rgba(0,0,0,0.2); max-height:90vh; overflow-y:auto;">
    <h3 style="margin-top:0;">✏️ Modifier le rapport</h3>
    <div style="display:flex;flex-direction:column;gap:8px;">
      <input id="edit-id" type="hidden" />
      <label>Statut:
        <select id="edit-status" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;"><option value="delivered">Livrée</option><option value="not-delivered">Non livrée</option></select>
      </label>
      <label>Agent: <input id="edit-agentName" type="text" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" /></label>
      <label>Contact: <input id="edit-agentContact" type="text" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" /></label>
      <label>Structure: <input id="edit-structure" type="text" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" /></label>
      <label>Date: <input id="edit-deliveryDate" type="date" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" /></label>
      <label>Heure: <input id="edit-deliveryTime" type="time" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" /></label>
      <label>Raison: <textarea id="edit-reason" style="min-height:60px;width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;"></textarea></label>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
        <button onclick="closeEditModal()" style="background:#6c757d;color:#fff;padding:8px 16px;border-radius:6px;border:none;cursor:pointer;">Annuler</button>
        <button onclick="saveEdit()" style="background:#007bff;color:#fff;padding:8px 16px;border-radius:6px;border:none;cursor:pointer;">Enregistrer</button>
      </div>
    </div>
  </div>
</div>
        
<!-- Signature viewing modal -->
<div id="signature-view-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:15000;padding:20px;">
  <div style="background:#fff;padding:20px;border-radius:8px;width:100%;max-width:500px;box-shadow:0 6px 18px rgba(0,0,0,0.2);max-height:90vh;overflow-y:auto;">
    <h3 style="margin-top:0;color:#007bff;text-align:center;">📷 Signature de réception</h3>
    <div style="text-align:center;margin:20px 0;">
      <img id="signature-view-image" style="max-width:100%;max-height:300px;border:1px solid #ddd;border-radius:8px;" />
    </div>
    <div style="text-align:center;">
      <button onclick="closeSignatureViewModal()" style="background:#6c757d;color:#fff;padding:8px 16px;border-radius:6px;border:none;cursor:pointer;">Fermer</button>
      <button id="download-signature" style="background:#28a745;color:#fff;padding:8px 16px;border-radius:6px;border:none;cursor:pointer;margin-left:10px;">💾 Télécharger</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
<script>
// Détection mobile et Android pour styles/ajustements ciblés
const IS_ANDROID = /Android/i.test(navigator.userAgent || '');
const IS_IOS = /iPhone|iPad|iPod/i.test(navigator.userAgent || '');
const IS_MOBILE = IS_ANDROID || IS_IOS || (window.matchMedia && matchMedia('(pointer: coarse)').matches);

if (IS_ANDROID) {
  document.documentElement.classList.add('is-android');
}
if (IS_MOBILE) {
  document.documentElement.classList.add('is-mobile');
  // Fix 100vh mobile (barres du navigateur)
  const setVh = () => document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
  setVh();
  window.addEventListener('resize', setVh);
  window.addEventListener('orientationchange', setVh);
}

// ====================== PROFESSIONAL TOAST NOTIFICATIONS ======================
function showToast(message, type = 'info', duration = 5000) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    const icons = {
        success: '✅',
        error: '❌',
        warning: '⚠️',
        info: 'ℹ️'
    };
    
    toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 1.2em;">${icons[type] || icons.info}</span>
            <div>
                <div style="font-weight: 600; margin-bottom: 4px;">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                <div style="font-size: 0.9em; color: var(--text-secondary);">${message}</div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.2em; cursor: pointer; color: var(--text-secondary); margin-left: auto;">×</button>
        </div>
    `;
    
    container.appendChild(toast);
    
    // Trigger animation
    setTimeout(() => toast.classList.add('show'), 10);
    
    // Auto remove
    if (duration > 0) {
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }
}

// ====================== LOADING STATES ======================
function showLoading(element, text = 'Chargement...') {
    const originalText = element.textContent;
    element.dataset.originalText = originalText;
    element.innerHTML = `<span class="loading-spinner"></span>${text}`;
    element.disabled = true;
}

function hideLoading(element) {
    const originalText = element.dataset.originalText || element.textContent;
    element.innerHTML = originalText;
    element.disabled = false;
    delete element.dataset.originalText;
}

// ====================== PROGRESS BAR ======================
function updateProgress(percentage) {
    const progressBar = document.querySelector('.progress-bar-fill');
    if (progressBar) {
        progressBar.style.width = `${Math.min(100, Math.max(0, percentage))}%`;
    }
}

// ====================== SIGNATURE VIEWING FUNCTIONS ======================
function viewSignature(signatureData) {
  document.getElementById('signature-view-image').src = signatureData;
  document.getElementById('signature-view-modal').style.display = 'flex';
  
  // Set up download functionality
  document.getElementById('download-signature').onclick = () => {
    const link = document.createElement('a');
    link.href = signatureData;
    link.download = 'signature_' + Date.now() + '.png';
    link.click();
  };
}

function closeSignatureViewModal() {
  document.getElementById('signature-view-modal').style.display = 'none';
}

// ====================== AUTH / MODE ======================
let currentUserRole = null;
const LS_KEY = 'deliveryReports_v1';

function saveReportsToLS(reports) {
    try { 
        // Sauvegarder localement
        localStorage.setItem(LS_KEY, JSON.stringify(reports || [])); 
        
        // Envoyer au serveur en temps réel
        fetch('/submit-report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(reports[reports.length - 1]) // Envoyer seulement le dernier rapport
        }).catch(err => {
            console.log('Erreur lors de l\'envoi au serveur:', err);
            // Continuer à fonctionner localement si le serveur est indisponible
        });
    } catch(e){ 
        console.warn(e); 
    }
}

function loadReportsFromLS() {
    try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch(e){ return []; }
}

// Nouvelle fonction pour récupérer les rapports depuis le serveur
async function fetchReportsFromServer() {
    try {
        const response = await fetch('/reports');
        if (response.ok) {
            const serverReports = await response.json();
            // Fusionner avec les rapports locaux pour ne pas perdre de données
            const localReports = loadReportsFromLS();
            const allReports = [...new Map([...localReports, ...serverReports].map(item => [item.id, item])).values()];
            
            // Sauvegarder la fusion
            saveReportsToLS(allReports);
            return allReports;
        } else {
            // Si le serveur ne répond pas, utiliser les rapports locaux
            return loadReportsFromLS();
        }
    } catch (error) {
        console.log('Erreur lors de la récupération depuis le serveur:', error);
        // Si le serveur ne répond pas, utiliser les rapports locaux
        return loadReportsFromLS();
    }
}

// ====================== BOUTONS DE FERMETURE PANNEAUX ======================
function attachPanelCloseHandlers() {
    const mapFlag = {
        'delivery-report-container': 'deliveryReportVisible',
        'invoice-send-container': 'invoicePanelVisible',
        'route-options-container': 'routeOptionsVisible'
    };
    document.querySelectorAll('.panel-close').forEach(btn => {
        const handler = () => {
            const targetId = btn.getAttribute('data-target');
            if (!targetId) return;
            if (targetId === 'signature-container') { try { cancelSignature(); } catch (e) {} return; }
            const panel = document.getElementById(targetId);
            if (panel) panel.style.display = 'none';
            const flagName = mapFlag[targetId];
            if (flagName && typeof window[flagName] !== 'undefined') window[flagName] = false;
        };
        btn.addEventListener('click', handler);
        btn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); handler(); });
        btn.addEventListener('touchstart', (e)=>{ e.preventDefault(); handler(); }, {passive:false});
    });
    // Fermer via la touche Echap
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            ['delivery-report-container','invoice-send-container','route-options-container'].forEach(id => {
                const el = document.getElementById(id);
                if (el && getComputedStyle(el).display !== 'none') el.style.display = 'none';
            });
            try { cancelSignature(); } catch (e) {}
            window.deliveryReportVisible = false;
            window.invoicePanelVisible = false;
            window.routeOptionsVisible = false;
        }
    });
}

// ====================== MENU MOBILE ======================
function initMobileMenu() {
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    
    menuToggle.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        sidebar.classList.toggle('show');
        sidebarOverlay.classList.toggle('show');
    });
    
    sidebarOverlay.addEventListener('click', function() {
        sidebar.classList.remove('show');
        sidebarOverlay.classList.remove('show');
    });
    sidebarOverlay.addEventListener('touchstart', function(e){
        e.preventDefault();
        sidebar.classList.remove('show');
        sidebarOverlay.classList.remove('show');
    }, {passive:false});
    
    // Fermer la sidebar quand on clique sur un élément de navigation
    sidebar.addEventListener('click', function(e) {
        if (e.target.tagName === 'BUTTON' || e.target.tagName === 'LI') {
            if (window.innerWidth <= 768) {
                setTimeout(() => {
                    sidebar.classList.remove('show');
                    sidebarOverlay.classList.remove('show');
                }, 300);
            }
        }
    });
    
    // Fermer la sidebar si on redimensionne vers desktop
    window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
            sidebar.classList.remove('show');
            sidebarOverlay.classList.remove('show');
        }
    });
    
    // Empêcher le défilement du body quand la sidebar est ouverte sur mobile
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                if (sidebar.classList.contains('show') && window.innerWidth <= 768) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = '';
                }
            }
        });
    });
    observer.observe(sidebar, { attributes: true });
}

// ====================== GESTION DE LA CONNEXION ======================
document.addEventListener('DOMContentLoaded', function() {
    const loginOverlay = document.getElementById('login-overlay');
    const appContainer = document.getElementById('app-container');
    const adminContainer = document.getElementById('admin-container');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('login-btn');
    const loginError = document.getElementById('login-error');
    
    function checkCredentials(username, password) {
        const u = (username || '').trim().toUpperCase();
        const p = (password || '').trim();
        if (u === 'IMPOTS' && p === 'IMPOTS 229') return 'agent';
        if (u === 'ADMIN'  && p === 'ADMIN229')   return 'admin';
        return null;
    }
    
    loginBtn.addEventListener('click', function() {
        const username = usernameInput.value;
        const password = passwordInput.value;
        const role = checkCredentials(username, password);
        
        if (role) {
            currentUserRole = role;
            loginOverlay.style.display = 'none';

            if (role === 'admin') {
                adminContainer.style.display = 'block';
                appContainer.style.display = 'none';
                initializeAdmin();
            } else {
                appContainer.style.display = 'block';
                adminContainer.style.display = 'none';
                document.getElementById('top-actions').style.display = 'none';
                initializeApp();
                initMobileMenu();
            }
        } else {
            loginError.style.display = 'block';
            usernameInput.value = '';
            passwordInput.value = '';
            setTimeout(() => {
                loginError.style.display = 'none';
            }, 3000);
        }
    });
    
    passwordInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            loginBtn.click();
        }
    });
    // Attacher les croix/astérisques de fermeture des panneaux
    attachPanelCloseHandlers();
});
 
function setupTopActionsForRole() {
    const topActions = document.getElementById('top-actions');
    const switchToAdminBtn = document.getElementById('switch-to-admin');
    const logoutBtn = document.getElementById('logout-btn');
    const appContainer = document.getElementById('app-container');
    const adminContainer = document.getElementById('admin-container');

    if (currentUserRole === 'admin') {
        topActions.style.display = 'flex';
        switchToAdminBtn.onclick = () => {
            appContainer.style.display = 'none';
            adminContainer.style.display = 'block';
            initializeAdmin();
        };
    } else {
        topActions.style.display = 'none';
    }

    logoutBtn.onclick = globalLogout;
    const logoutBtnAdmin = document.getElementById('logout-btn-admin');
    if (logoutBtnAdmin) logoutBtnAdmin.onclick = globalLogout;

    const switchToAgent = document.getElementById('switch-to-agent');
    if (switchToAgent) {
        switchToAgent.onclick = () => {
            adminContainer.style.display = 'none';
            appContainer.style.display = 'block';
            initializeApp();
            initMobileMenu();
            setupTopActionsForRole();
        };
    }
}

function globalLogout() {
    currentUserRole = null;
    document.getElementById('app-container').style.display = 'none';
    document.getElementById('admin-container').style.display = 'none';
    document.getElementById('login-overlay').style.display = 'flex';
    
    // Réinitialiser l'état mobile
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    if (sidebar) sidebar.classList.remove('show');
    if (sidebarOverlay) sidebarOverlay.classList.remove('show');
    document.body.style.overflow = '';
}

// ====================== CODE APPLICATION AGENT ======================
function initializeApp() {
var speech = window.speechSynthesis;
var voiceEnabled = true;
var lastSpokenInstructionTimestamp = 0;
const MIN_SPEAK_INTERVAL = 5000;

// Variables pour les options de route
var availableRoutes = [];
var selectedRouteIndex = -1;
var routeOptionsVisible = false;
var currentDestination = null;

// Variables pour la signature digitale
var signatureCanvas = null;
var signatureCtx = null;
var isDrawing = false;
var currentSignature = null;

var map = L.map('map').setView([9.3077,2.3158],7);
var allCompanies = [];
var selectedCompany = null;
var routingControl=null, movingMarkerStart=null, movingMarkerEnd=null, movingCursor=null, routeLine=null;
var routeCoords=[], routeInstructions=[], currentStep=0, routeInterval=null, isPaused=false;
var userMarker=null;
var gpsWatchId = null;
var currentInstructionIndex = 0;
var lastSpokenInstruction = -1;
var voiceGuidanceInterval = null;

// Variables pour le suivi GPS réel
var isNavigating = false;
var followUserPosition = true;
var currentUserPosition = null;

var infrastructures = [
  { nom: "École Primaire Z", lat: 9.3100, lng: 2.3200, alerteFait: false },
  { nom: "Pont principal", lat: 9.3150, lng: 2.3250, alerteFait: false },
  { nom: "Rond-point central", lat: 9.3125, lng: 2.3180, alerteFait: false },
  { nom: "Hôpital Général", lat: 9.3170, lng: 2.3100, alerteFait: false }
];
var infraAlertDistance = 25;

// Variables pour la gestion dynamique du trait
var progressLine = null;
var totalRouteDistance = 0;
var currentRouteProgress = 0;

// Variables pour la rotation de la carte
var currentMapRotation = 0;
var is3DMode = false;
var sidebarVisible = true;

// ====================== TOGGLE SIDEBAR ======================
document.getElementById('sidebar-toggle').onclick = () => {
    sidebarVisible = !sidebarVisible;
    const sidebar = document.getElementById('sidebar');
    const map = document.getElementById('map');
    const toggleBtn = document.getElementById('sidebar-toggle');
    
    if (window.innerWidth <= 768) return; // Ne pas utiliser ce bouton sur mobile
    
    if (sidebarVisible) {
        sidebar.classList.remove('hidden');
        map.classList.remove('sidebar-hidden');
        toggleBtn.classList.remove('sidebar-hidden');
        toggleBtn.innerHTML = '☰';
    } else {
        sidebar.classList.add('hidden');
        map.classList.add('sidebar-hidden');
        toggleBtn.classList.add('sidebar-hidden');
        toggleBtn.innerHTML = '✕';
    }
    
    // Redimensionner la carte après animation
    setTimeout(() => {
        if (typeof map !== 'undefined' && map.invalidateSize) {
            map.invalidateSize();
        }
    }, 300);
};

// Icônes personnalisés pour départ, arrivée et position
var departIcon = new L.Icon({ 
    iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png', 
    iconSize: [32,32], 
    iconAnchor: [16,32]
});
var arriveeIcon = new L.Icon({ 
    iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png', 
    iconSize: [32,32], 
    iconAnchor: [16,32]
});
var positionIcon = new L.Icon({ 
    iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png', 
    iconSize: [32,32], 
    iconAnchor: [16,32]
});

var baseLayers = {
"OSM": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:25, maxNativeZoom: 19, attribution:'', errorTileUrl:''}).addTo(map),
"Google Satellite": L.tileLayer('https://mt.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{maxZoom:25, maxNativeZoom: 19, attribution:'', errorTileUrl:''}),
"Google Earth": L.tileLayer('https://mt.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{maxZoom:25, maxNativeZoom: 19, attribution:'', errorTileUrl:''}),
"Google Terrain": L.tileLayer('https://mt.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{maxZoom:25, maxNativeZoom: 19, attribution:'', errorTileUrl:''})
};

var layerThumbs = {
"OSM":"https://tile.openstreetmap.org/5/15/10.png",
"Google Satellite":"https://mt.google.com/vt/lyrs=s&x=10&y=10&z=5",
"Google Earth":"https://mt.google.com/vt/lyrs=y&x=10&y=10&z=5",
"Google Terrain":"https://mt.google.com/vt/lyrs=p&x=10&y=10&z=5"
};

var layerContainer=document.getElementById('layer-container');
layerContainer.innerHTML = '';
Object.keys(baseLayers).forEach((key,idx)=>{
    var div=document.createElement('div');
    div.className="layer-preview"+(idx===0?" active":"");
    div.style.backgroundImage=`url('${layerThumbs[key]}')`;
    div.title=key;
    div.onclick=()=>{
        map.eachLayer(l=>{ if(l instanceof L.TileLayer) map.removeLayer(l); });
        baseLayers[key].addTo(map);
        document.querySelectorAll('.layer-preview').forEach(p=>p.classList.remove('active'));
        div.classList.add('active');
    };
    layerContainer.appendChild(div);
});

var layerContainerVisible = true;
document.getElementById('toggleLayersBtn').onclick = () => {
    layerContainerVisible = !layerContainerVisible;
    layerContainer.style.display = layerContainerVisible ? 'flex' : 'none';
};

// ====================== CONTRÔLES DE ZOOM POUR NAVIGATION ======================
function initZoomControls() {
    const zoomControls = document.getElementById('zoom-controls');
    const zoomInBtn = document.getElementById('zoom-in');
    const zoomOutBtn = document.getElementById('zoom-out');
    const zoomFollowBtn = document.getElementById('zoom-follow');
    
    // Permettre le zoom libre pendant la navigation
    zoomInBtn.onclick = () => {
        if (isNavigating) {
            // Désactiver temporairement le suivi automatique lors du zoom manuel
            followUserPosition = false;
            zoomFollowBtn.style.background = 'rgba(255, 255, 255, 0.9)';
            zoomFollowBtn.style.color = '#333';
        }
        map.zoomIn();
    };
    
    zoomOutBtn.onclick = () => {
        if (isNavigating) {
            // Désactiver temporairement le suivi automatique lors du zoom manuel
            followUserPosition = false;
            zoomFollowBtn.style.background = 'rgba(255, 255, 255, 0.9)';
            zoomFollowBtn.style.color = '#333';
        }
        map.zoomOut();
    };
    
    zoomFollowBtn.onclick = () => {
        followUserPosition = !followUserPosition;
        zoomFollowBtn.style.background = followUserPosition ? '#007bff' : 'rgba(255, 255, 255, 0.9)';
        zoomFollowBtn.style.color = followUserPosition ? 'white' : '#333';
        
        if (followUserPosition && currentUserPosition) {
            map.setView(currentUserPosition, Math.max(map.getZoom(), 18), {animate: true});
        }
    };
    
    // Permettre l'interaction libre avec la carte pendant la navigation
    map.on('dragstart', () => {
        if (isNavigating) {
            followUserPosition = false;
            zoomFollowBtn.style.background = 'rgba(255, 255, 255, 0.9)';
            zoomFollowBtn.style.color = '#333';
        }
    });
    
    map.on('zoomstart', (e) => {
        if (isNavigating && !e.originalEvent) {
            followUserPosition = false;
            zoomFollowBtn.style.background = 'rgba(255, 255, 255, 0.9)';
            zoomFollowBtn.style.color = '#333';
        }
    });
    
    // Afficher les contrôles seulement pendant la navigation
    function showZoomControls() {
        zoomControls.style.display = 'flex';
        // Activer le suivi par défaut au début de la navigation
        followUserPosition = true;
        zoomFollowBtn.style.background = '#007bff';
        zoomFollowBtn.style.color = 'white';
    }
    
    function hideZoomControls() {
        zoomControls.style.display = 'none';
        followUserPosition = true;
    }
    
    return { showZoomControls, hideZoomControls };
}

const { showZoomControls, hideZoomControls } = initZoomControls();

function speak(text){
    if(!voiceEnabled) return;
    if (speech.speaking) { return; }
    const now = Date.now();
    if (now - lastSpokenInstructionTimestamp < MIN_SPEAK_INTERVAL) { return; }
    var u = new SpeechSynthesisUtterance(text);
    u.lang = 'fr-FR';
    u.onend = () => { lastSpokenInstructionTimestamp = now; };
    u.onerror = (event) => { console.error('SpeechSynthesisUtterance.onerror', event); };
    speech.speak(u);
}
document.getElementById('toggleVoice').onclick=()=>{ voiceEnabled=!voiceEnabled; alert('Voix '+(voiceEnabled?'activée':'désactivée')); };

document.getElementById('locateBtn').onclick = () => {
    if (isNavigating && movingCursor) {
        // Pendant la navigation, utiliser le marqueur de déplacement existant
        if (currentUserPosition) {
            map.setView(currentUserPosition, Math.max(map.getZoom(), 18), {animate: true});
            followUserPosition = true;
            
            // Mettre à jour le bouton de suivi s'il est visible
            const zoomFollowBtn = document.getElementById('zoom-follow');
            if (zoomFollowBtn) {
                zoomFollowBtn.style.background = '#007bff';
                zoomFollowBtn.style.color = 'white';
            }
        } else {
            // Si pas de position courante, obtenir la position GPS
            map.locate({setView: true, maxZoom: 18});
        }
    } else {
        // Mode normal, localisation classique
        map.locate({setView: true, maxZoom: 25});
    }
};

map.on('locationfound', e => {
    if (!isNavigating) {
        // Seulement créer/mettre à jour le marqueur utilisateur si on n'est pas en navigation
        if (userMarker) map.removeLayer(userMarker);
        userMarker = L.marker(e.latlng, {icon: positionIcon}).addTo(map);
        map.setView(e.latlng, 25, {animate: true});
    }
    currentUserPosition = [e.latlng.lat, e.latlng.lng];
});
map.on('locationerror',()=>{ alert("Impossible de vous localiser."); });

// ====================== CHARGEMENT DES ENTREPRISES DEPUIS LE CSV ======================
Papa.parse("public/entreprises_geocodes.csv", {
    download: true,
    header: true,
    complete: function(results) {
        console.log("Données CSV chargées:", results.data);
        allCompanies = results.data.filter(e => e.Nom_Entreprise && e.Latitude && e.Longitude);
        var list = document.getElementById('companyList');
        list.innerHTML = ''; 
        allCompanies.forEach(e => {
            var li = document.createElement('li');
            li.textContent = e.Nom_Entreprise;
            li.title = `ID: ${e.ID || ''} - Coordonnées: ${e.Latitude}, ${e.Longitude}`;
            li.onclick = () => { 
                selectedCompany = e; 
                showRouteOptions(parseFloat(e.Latitude), parseFloat(e.Longitude), e.Nom_Entreprise); 
            };
            list.appendChild(li);
        });
        console.log(`${allCompanies.length} entreprises chargées`);
    },
    error: function(error) {
        console.error("Erreur lors du chargement du CSV:", error);
        // Fallback avec les données intégrées si le CSV ne se charge pas
        allCompanies = [
            {ID: "1", Nom_Entreprise: "EREVAN", Latitude: "6.348958", Longitude: "2.386909"},
            {ID: "2", Nom_Entreprise: "Le Plasma Bar", Latitude: "6.381497", Longitude: "2.334261"},
            {ID: "3", Nom_Entreprise: "Poulet Piquet", Latitude: "6.382206", Longitude: "2.336388"},
            {ID: "4", Nom_Entreprise: "Sofitel Hôtel", Latitude: "6.350114", Longitude: "2.393706"},
            {ID: "5", Nom_Entreprise: "Séminaire St Jean Eudes", Latitude: "6.38906", Longitude: "2.321026"},
            {ID: "6", Nom_Entreprise: "Eglise de Jésus-Christ des Saints des derniers Jours", Latitude: "6.392349", Longitude: "2.317976"}
        ];
        var list = document.getElementById('companyList');
        list.innerHTML = ''; 
        allCompanies.forEach(e => {
            var li = document.createElement('li');
            li.textContent = e.Nom_Entreprise;
            li.title = `ID: ${e.ID} - Coordonnées: ${e.Latitude}, ${e.Longitude}`;
            li.onclick = () => { 
                selectedCompany = e; 
                showRouteOptions(parseFloat(e.Latitude), parseFloat(e.Longitude), e.Nom_Entreprise); 
            };
            list.appendChild(li);
        });
        console.log("Utilisation des données de fallback");
    }
});

document.getElementById('toggleCompanies').onclick = () => {
    var list = document.getElementById('companyList');
    list.style.display = (window.getComputedStyle(list).display === "none") ? "block" : "none";
};

document.getElementById('searchStructureBtn').onclick = () => {
    const query = document.getElementById('searchStructureInput').value.trim().toLowerCase();
    if (!query) { alert("Veuillez saisir le nom d'une structure."); return; }
    const match = allCompanies.find(e => e.Nom_Entreprise.toLowerCase().includes(query));
    if (!match || !match.Latitude || !match.Longitude) { alert("Structure introuvable ou coordonnées manquantes."); return; }
    selectedCompany = match;
    showRouteOptions(parseFloat(match.Latitude), parseFloat(match.Longitude), match.Nom_Entreprise);
};

// ====================== FONCTIONS DE PARSING DES COORDONNÉES ======================
// Test rapide pour déboguer
function testCoordParsing() {
    const testCases = [
        "6°23'4.05\"N",
        "2°19'21.13\"E",
        "6°23'16.43\"N",
        "6.348958",
        "6°20'56.25\"",
        "N6.348958"
    ];
    
    console.log("=== TEST DE PARSING DES COORDONNÉES ===");
    testCases.forEach(test => {
        const result = parseCoordinate(test);
        console.log(`Test "${test}" = ${result}`);
    });
    console.log("=== FIN DES TESTS ===");
}
// Appel du test (temporaire)
testCoordParsing();

// Vérification manuelle des calculs
function manualCalculation() {
    console.log("=== VÉRIFICATION MANUELLE ===");
    
    // 6°23'4.05"N
    const lat_deg = 6;
    const lat_min = 23;
    const lat_sec = 4.05;
    const lat_result = lat_deg + lat_min/60 + lat_sec/3600;
    console.log(`6°23'4.05"N = ${lat_deg} + ${lat_min}/60 + ${lat_sec}/3600 = ${lat_result.toFixed(8)}`);
    
    // 2°19'21.13"E
    const lng_deg = 2;
    const lng_min = 19;
    const lng_sec = 21.13;
    const lng_result = lng_deg + lng_min/60 + lng_sec/3600;
    console.log(`2°19'21.13"E = ${lng_deg} + ${lng_min}/60 + ${lng_sec}/3600 = ${lng_result.toFixed(8)}`);
    
    console.log(`COORDONNÉES FINALES: ${lat_result.toFixed(6)}, ${lng_result.toFixed(6)}`);
}
manualCalculation();
function parseCoordinatePair(coordPairString) {
    if (!coordPairString || typeof coordPairString !== 'string') {
        return null;
    }
    
    const cleaned = coordPairString.trim();
    
    // Format Google Maps: "6.348958, 2.386909" ou "6.348958,2.386909"
    const gmapsMatch = cleaned.match(/^(-?\d+\.?\d*),\s*(-?\d+\.?\d*)$/);
    if (gmapsMatch) {
        return {
            lat: parseFloat(gmapsMatch[1]),
            lng: parseFloat(gmapsMatch[2])
        };
    }
    
    // Format avec point-virgule: "6.348958; 2.386909"
    const semicolonMatch = cleaned.match(/^(-?\d+\.?\d*);\s*(-?\d+\.?\d*)$/);
    if (semicolonMatch) {
        return {
            lat: parseFloat(semicolonMatch[1]),
            lng: parseFloat(semicolonMatch[2])
        };
    }
    
    // Format avec espace: "6.348958 2.386909"
    const spaceMatch = cleaned.match(/^(-?\d+\.?\d*)\s+(-?\d+\.?\d*)$/);
    if (spaceMatch) {
        return {
            lat: parseFloat(spaceMatch[1]),
            lng: parseFloat(spaceMatch[2])
        };
    }
    
    // Format avec virgules décimales: "6,348958 2,386909"
    const commaMatch = cleaned.match(/^(-?\d+,\d+)\s+(-?\d+,\d+)$/);
    if (commaMatch) {
        return {
            lat: parseFloat(commaMatch[1].replace(',', '.')),
            lng: parseFloat(commaMatch[2].replace(',', '.'))
        };
    }
    
    return null;
}

function parseCoordinate(coordString) {
    if (!coordString || typeof coordString !== 'string') {
        return null;
    }
    
    // Nettoyer la chaîne
    const cleanCoord = coordString.trim().replace(/,/g, '.');
    
    // Format décimal simple (ex: 6.348958 ou -6.348958)
    if (/^-?\d+\.?\d*$/.test(cleanCoord)) {
        return parseFloat(cleanCoord);
    }
    
    // Format degrés décimaux avec symboles (ex: 6.348958° ou 6.348958N ou N6.348958)
    const decimalMatch = cleanCoord.match(/([NSEW]?)-?(\d+\.?\d*)°?([NSEW]?)/i);
    if (decimalMatch) {
        let value = parseFloat(decimalMatch[2]);
        const prefix = decimalMatch[1].toUpperCase();
        const suffix = decimalMatch[3].toUpperCase();
        
        // Appliquer le signe selon la direction
        if (prefix === 'S' || prefix === 'W' || suffix === 'S' || suffix === 'W') {
            value = -Math.abs(value);
        }
        return value;
    }
    
    // Format degrés minutes (ex: 6°20.937' ou 6° 20.937' ou 6 20.937)
    const dmMatch = cleanCoord.match(/([NSEW]?)-?(\d+)[°\s]+(\d+\.?\d*)[''′]?([NSEW]?)/i);
    if (dmMatch) {
        const degrees = parseInt(dmMatch[2]);
        const minutes = parseFloat(dmMatch[3]);
        let value = degrees + minutes / 60;
        
        const prefix = dmMatch[1].toUpperCase();
        const suffix = dmMatch[4].toUpperCase();
        
        if (prefix === 'S' || prefix === 'W' || suffix === 'S' || suffix === 'W') {
            value = -Math.abs(value);
        }
        return value;
    }
    
    // Format degrés minutes secondes - Version ultra-robuste avec débogage
    // Test spécifique pour 6°23'4.05"N et variantes
    let dmsResult = null;
    let matchInfo = null;
    
    // Pattern 1: Format exact comme 6°23'4.05"N (nombre de secondes variable)
    let match = cleanCoord.match(/^([NSEW]?)(-?\d+)°(\d+)'([\d.]+)"([NSEW]?)$/i);
    if (match) {
        matchInfo = "Pattern 1 (format exact)";
        const degrees = parseInt(match[2]);
        const minutes = parseInt(match[3]);
        const seconds = parseFloat(match[4]);
        dmsResult = degrees + minutes / 60 + seconds / 3600;
        
        console.log(`Débogage DMS: ${cleanCoord} -> D:${degrees}, M:${minutes}, S:${seconds} = ${dmsResult}`);
        
        const prefix = match[1].toUpperCase();
        const suffix = match[5].toUpperCase();
        if (prefix === 'S' || prefix === 'W' || suffix === 'S' || suffix === 'W') {
            dmsResult = -Math.abs(dmsResult);
            console.log(`Direction ${prefix || suffix} détectée, application du signe négatif: ${dmsResult}`);
        }
    }
    
    // Pattern 2: Avec espaces: 6° 23' 4.05" N
    if (!dmsResult) {
        match = cleanCoord.match(/^([NSEW]?)\s*(-?\d+)\s*°\s*(\d+)\s*'\s*([\d.]+)\s*"\s*([NSEW]?)$/i);
        if (match) {
            matchInfo = "Pattern 2 (avec espaces)";
            const degrees = parseInt(match[2]);
            const minutes = parseInt(match[3]);
            const seconds = parseFloat(match[4]);
            dmsResult = degrees + minutes / 60 + seconds / 3600;
            
            console.log(`Débogage DMS (espaces): ${cleanCoord} -> D:${degrees}, M:${minutes}, S:${seconds} = ${dmsResult}`);
            
            const prefix = match[1].toUpperCase();
            const suffix = match[5].toUpperCase();
            if (prefix === 'S' || prefix === 'W' || suffix === 'S' || suffix === 'W') {
                dmsResult = -Math.abs(dmsResult);
                console.log(`Direction ${prefix || suffix} détectée (espaces), application du signe négatif: ${dmsResult}`);
            }
        }
    }
    
    // Pattern 3: Sans guillemets finaux: 6°23'4.05N
    if (!dmsResult) {
        match = cleanCoord.match(/^([NSEW]?)(-?\d+)°(\d+)'([\d.]+)([NSEW]?)$/i);
        if (match) {
            matchInfo = "Pattern 3 (sans guillemets)";
            const degrees = parseInt(match[2]);
            const minutes = parseInt(match[3]);
            const seconds = parseFloat(match[4]);
            dmsResult = degrees + minutes / 60 + seconds / 3600;
            
            console.log(`Débogage DMS (sans guillemets): ${cleanCoord} -> D:${degrees}, M:${minutes}, S:${seconds} = ${dmsResult}`);
            
            const prefix = match[1].toUpperCase();
            const suffix = match[5].toUpperCase();
            if (prefix === 'S' || prefix === 'W' || suffix === 'S' || suffix === 'W') {
                dmsResult = -Math.abs(dmsResult);
                console.log(`Direction ${prefix || suffix} détectée (sans guillemets), application du signe négatif: ${dmsResult}`);
            }
        }
    }
    
    if (dmsResult !== null) {
        console.log(`Résultat DMS final pour "${coordString}": ${dmsResult} (via ${matchInfo})`);
        return dmsResult;
    }
    
    
    // Format avec virgule comme séparateur décimal
    const commaDecimal = cleanCoord.replace(',', '.');
    if (/^-?\d+\.\d*$/.test(commaDecimal)) {
        return parseFloat(commaDecimal);
    }
    
    return null;
}

function detectUTMCoordinates(latStr, lngStr) {
    // Détecter si les coordonnées ressemblent à des coordonnées UTM
    const lat = parseFloat(latStr.replace(/,/g, '.'));
    const lng = parseFloat(lngStr.replace(/,/g, '.'));
    
    // Les coordonnées UTM ont généralement:
    // - Easting (longitude): 100,000 à 800,000 mètres
    // - Northing (latitude): 1,000,000 à 10,000,000 mètres
    if (!isNaN(lat) && !isNaN(lng)) {
        if ((lng >= 100000 && lng <= 800000) && (lat >= 1000000 && lat <= 10000000)) {
            return true;
        }
    }
    return false;
}

document.getElementById('coordBtnSidebar').onclick = () => {
    const latStr = document.getElementById('latInput').value.trim();
    const lngStr = document.getElementById('lngInput').value.trim();
    
    if (!latStr && !lngStr) {
        alert("Veuillez entrer des coordonnées !");
        return;
    }
    
    let lat, lng;
    
    // Vérifier si une paire de coordonnées a été collée dans un seul champ
    if (latStr && !lngStr) {
        const coordPair = parseCoordinatePair(latStr);
        if (coordPair) {
            lat = coordPair.lat;
            lng = coordPair.lng;
        } else {
            alert("Veuillez entrer aussi la longitude, ou coller les coordonnées au format 'lat, lng' !");
            return;
        }
    } else if (!latStr && lngStr) {
        const coordPair = parseCoordinatePair(lngStr);
        if (coordPair) {
            lat = coordPair.lat;
            lng = coordPair.lng;
        } else {
            alert("Veuillez entrer aussi la latitude, ou coller les coordonnées au format 'lat, lng' !");
            return;
        }
    } else {
        // Essayer de parser les coordonnées séparément
        lat = parseCoordinate(latStr);
        lng = parseCoordinate(lngStr);
    }
    
    if (lat === null || lng === null) {
        alert("Format de coordonnées non reconnu. Formats supportés:\n\n" +
              "🌍 FORMATS GÉOGRAPHIQUES:\n" +
              "• Décimales: 6.348958, 2.386909\n" +
              "• Google Maps: 6.348958, 2.386909 (dans un seul champ)\n" +
              "• Avec direction: N6.348958, E2.386909\n" +
              "• Degrés minutes: 6°20.937', 2°23.215'\n" +
              "• Degrés minutes secondes: 6°20'56.25\", 2°23'12.9\"\n" +
              "• Avec virgules: 6,348958 2,386909\n\n" +
              "🗺️ FORMATS UTM:\n" +
              "• Métrique: 123456.78, 1234567.89\n\n" +
              "📝 Astuce: Vous pouvez coller des coordonnées Google Maps directement !");
        return;
    }
    
    // Détecter automatiquement si c'est de l'UTM
    const coordType = document.getElementById('coordType').value;
    const isUTM = (coordType === "utm") || detectUTMCoordinates(latStr, lngStr);
    
    let destLat = lat, destLng = lng;
    
    if (isUTM) {
        try {
            // Conversion UTM vers géographique
            const utmProj = "+proj=utm +zone=31 +datum=WGS84 +units=m +no_defs";
            const geoProj = "+proj=longlat +datum=WGS84 +no_defs";
            const res = proj4(utmProj, geoProj, [lng, lat]);
            destLng = res[0];
            destLat = res[1];
            
            console.log(`Conversion UTM: (${lat}, ${lng}) → (${destLat.toFixed(6)}, ${destLng.toFixed(6)})`);
        } catch(e) { 
            alert("Erreur de conversion UTM: " + e.message); 
            return; 
        }
    }
    
    // Valider que les coordonnées sont dans des plages raisonnables
    if (destLat < -90 || destLat > 90) {
        alert("Latitude invalide. Doit être entre -90° et +90°");
        return;
    }
    if (destLng < -180 || destLng > 180) {
        alert("Longitude invalide. Doit être entre -180° et +180°");
        return;
    }
    
    selectedCompany = null;
    const formatStr = isUTM ? "UTM" : "Géographique";
    
    // Debug: afficher les coordonnées parsées
    console.log(`Coordonnées entrées: Lat="${latStr}", Lng="${lngStr}"`);
    console.log(`Coordonnées parsées: ${formatStr} - Lat: ${destLat.toFixed(6)}, Lng: ${destLng.toFixed(6)}`);
    
    showRouteOptions(destLat, destLng, `Destination ${formatStr} (${destLat.toFixed(5)}, ${destLng.toFixed(5)})`);
    
    // Message de confirmation pour l'utilisateur (temporairement désactivé pour les tests)
    // alert(`Coordonnées trouvées:\nLatitude: ${destLat.toFixed(6)}\nLongitude: ${destLng.toFixed(6)}`);
};

function clearRoute(){
    clearInterval(routeInterval);
    if (voiceGuidanceInterval) clearInterval(voiceGuidanceInterval);
    if (gpsWatchId) {
        navigator.geolocation.clearWatch(gpsWatchId);
        gpsWatchId = null;
    }
    speech.cancel();

    routeInterval=null;
    voiceGuidanceInterval = null;
    isPaused=false;
    isNavigating = false;
    followUserPosition = true;

    // Nettoyer tous les marqueurs et lignes de route
    if(movingMarkerStart) {
        map.removeLayer(movingMarkerStart);
        movingMarkerStart = null;
    }
    if(movingMarkerEnd) {
        map.removeLayer(movingMarkerEnd);
        movingMarkerEnd = null;
    }
    if(movingCursor) {
        map.removeLayer(movingCursor);
        movingCursor = null;
    }
    if(routeLine) {
        map.removeLayer(routeLine);
        routeLine = null;
    }
    if(progressLine) {
        map.removeLayer(progressLine);
        progressLine = null;
    }
    if(routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
    }

    routeCoords=[];
    routeInstructions=[];
    currentStep=0;
    currentInstructionIndex = 0;
    lastSpokenInstruction = -1;
    lastSpokenInstructionTimestamp = 0;
    currentRouteProgress = 0;

    // Hide statistics dashboard
    document.getElementById('stats-card').style.display = 'none';
    
    document.getElementById('instructionsList').innerHTML='';
    hideZoomControls();
}

function distance(latlng1,latlng2){
    const R=6371000;
    const toRad=d=>d*Math.PI/180;
    const dLat=toRad(latlng2[0]-latlng1[0]);
    const dLon=toRad(latlng2[1]-latlng1[1]);
    const lat1=toRad(latlng1[0]); const lat2=toRad(latlng2[0]);
    const a=Math.sin(dLat/2)**2 + Math.sin(dLon/2)**2 * Math.cos(lat1)*Math.cos(lat2);
    return 2*R*Math.atan2(Math.sqrt(a),Math.atan2(Math.sqrt(1-a),1));
}

// ====================== STATISTICS AND PERFORMANCE TRACKING ======================
function updateStatistics(route) {
    if (!route) return;
    
    const totalDistance = (route.summary.totalDistance / 1000).toFixed(1);
    const estimatedTime = Math.round(route.summary.totalTime / 60);
    
    document.getElementById('total-distance').textContent = `${totalDistance} km`;
    document.getElementById('estimated-time').textContent = `${estimatedTime} min`;
    document.getElementById('route-progress').textContent = `${Math.round(currentRouteProgress)}%`;
    
    // Update progress bar
    const progressBar = document.getElementById('navigation-progress');
    if (progressBar) {
        progressBar.style.width = `${currentRouteProgress}%`;
    }
}

function updateCurrentSpeed(position) {
    if (position && position.coords && position.coords.speed !== null) {
        const speedKmh = Math.round((position.coords.speed || 0) * 3.6);
        const speedElement = document.getElementById('current-speed');
        if (speedElement) {
            speedElement.textContent = `${speedKmh} km/h`;
        }
    }
}

// Update statistics during navigation
function updateNavigationStats() {
    document.getElementById('route-progress').textContent = `${Math.round(currentRouteProgress)}%`;
    const progressBar = document.getElementById('navigation-progress');
    if (progressBar) {
        progressBar.style.width = `${currentRouteProgress}%`;
    }
}

// ====================== SUIVI GPS RÉEL AMÉLIORÉ ======================
function updateProgressiveLine(userPos) {
    if (!routeCoords || routeCoords.length === 0) return;
    
    // Trouver le point le plus proche sur la route
    let closestIndex = 0;
    let minDistance = Infinity;
    
    routeCoords.forEach((coord, index) => {
        const dist = distance(userPos, [coord.lat, coord.lng]);
        if (dist < minDistance) {
            minDistance = dist;
            closestIndex = index;
        }
    });
    
    // Projeter la position utilisateur sur la ligne de route pour un suivi précis
    let projectedPos = userPos;
    if (closestIndex < routeCoords.length - 1) {
        const currentPoint = routeCoords[closestIndex];
        const nextPoint = routeCoords[closestIndex + 1];
        
        // Projection de la position sur le segment de route le plus proche
        projectedPos = projectPointOnSegment(
            userPos, 
            [currentPoint.lat, currentPoint.lng], 
            [nextPoint.lat, nextPoint.lng]
        );
    }
    
    // Mettre à jour la position du curseur avec la position projetée sur la route
    if (movingCursor) {
        movingCursor.setLatLng(projectedPos);
    }
    
    // Supprimer l'ancienne ligne de progression
    if (progressLine) {
        map.removeLayer(progressLine);
    }
    
    // Garder la ligne complète visible et mettre à jour seulement la ligne de progrès
    const remainingCoords = routeCoords.slice(closestIndex);
    if (remainingCoords.length > 1) {
        // Ajouter la position projetée au début des coordonnées restantes
        const progressCoords = [projectedPos, ...remainingCoords.map(c => [c.lat, c.lng])];
        
        // Ligne de progression en vert pour montrer le parcours restant
        progressLine = L.polyline(progressCoords, { 
            color: '#28a745', 
            weight: 4, 
            opacity: 0.7,
            className: 'route-progress-line'
        }).addTo(map);
    }
    
    // Calculer le progrès
    currentRouteProgress = (closestIndex / routeCoords.length) * 100;
}

// Fonction pour projeter un point sur un segment de ligne
function projectPointOnSegment(point, segmentStart, segmentEnd) {
    const [px, py] = point;
    const [x1, y1] = segmentStart;
    const [x2, y2] = segmentEnd;
    
    const A = px - x1;
    const B = py - y1;
    const C = x2 - x1;
    const D = y2 - y1;
    
    const dot = A * C + B * D;
    const lenSq = C * C + D * D;
    
    if (lenSq === 0) return segmentStart;
    
    let param = dot / lenSq;
    
    if (param < 0) {
        return segmentStart;
    } else if (param > 1) {
        return segmentEnd;
    } else {
        return [x1 + param * C, y1 + param * D];
    }
}

function startRealTimeGPSTracking(){
    if(!routeInstructions || routeInstructions.length===0) return;
    if (gpsWatchId) navigator.geolocation.clearWatch(gpsWatchId);
    
    isNavigating = true;
    showZoomControls();
    
    // Variables pour détecter le mouvement réel
    let lastPosition = null;
    let lastMoveTime = 0;
    const MOVEMENT_THRESHOLD = 2; // mètres minimum pour considérer un mouvement
    const TIME_THRESHOLD = 3000; // 3 secondes minimum entre les mouvements
    
    gpsWatchId = navigator.geolocation.watchPosition(pos => {
        const userPos = [pos.coords.latitude, pos.coords.longitude];
        currentUserPosition = userPos;
        
        // Update speed statistics
        updateCurrentSpeed(pos);
        
        // Détecter si l'utilisateur s'est réellement déplacé
        const now = Date.now();
        let hasReallyMoved = false;
        
        if (lastPosition) {
            const distanceMoved = distance(lastPosition, userPos);
            if (distanceMoved > MOVEMENT_THRESHOLD && (now - lastMoveTime) > TIME_THRESHOLD) {
                hasReallyMoved = true;
                lastPosition = userPos;
                lastMoveTime = now;
            }
        } else {
            // Première position
            lastPosition = userPos;
            lastMoveTime = now;
            hasReallyMoved = true;
        }
        
        // Mettre à jour seulement si mouvement réel détecté
        if (hasReallyMoved) {
            updateProgressiveLine(userPos);
        }
        
        // Update navigation statistics
        updateNavigationStats();
        
        // Suivre la position utilisateur si activé avec transition fluide
        if (followUserPosition) {
            const currentZoom = map.getZoom();
            const targetZoom = Math.max(currentZoom, 16); // Zoom optimisé pour navigation
            map.setView(userPos, targetZoom, {
                animate: true, 
                duration: 1.0,
                easeLinearity: 0.5
            });
        }
        
        // Gestion des instructions vocales basées sur la position réelle
        if (currentInstructionIndex < routeInstructions.length) {
            const instruction = routeInstructions[currentInstructionIndex];
            const instructionLatLng = routeCoords[instruction.index]; 
            const distToInstruction = distance(userPos, [instructionLatLng.lat, instructionLatLng.lng]);

            // Annoncer l'instruction quand on s'approche (50m au lieu de 30m pour plus de temps)
            if (distToInstruction < 50 && currentInstructionIndex !== lastSpokenInstruction) {
                if (voiceEnabled) speak(instruction.text);
                lastSpokenInstruction = currentInstructionIndex;
                
                // Mettre à jour l'affichage des instructions
                var instrList=document.getElementById('instructionsList');
                instrList.querySelectorAll('li').forEach(li=>li.classList.remove('current'));
                if(instrList.children[currentInstructionIndex]) {
                    instrList.children[currentInstructionIndex].classList.add('current');
                    instrList.children[currentInstructionIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
            
            // Passer à l'instruction suivante quand on a dépassé celle-ci
            if (distToInstruction > 80 && currentInstructionIndex === lastSpokenInstruction) { 
                 currentInstructionIndex++; 
                 lastSpokenInstruction = -1;
            }
        }

        // Vérifier si on est arrivé à destination
        if (routeCoords.length > 0) {
            const destination = routeCoords[routeCoords.length - 1];
            const distToDestination = distance(userPos, [destination.lat, destination.lng]);
            
            if (distToDestination < 20) { // 20 mètres de la destination
                if (voiceEnabled) speak("Vous êtes arrivé à destination.");
                clearRoute();
                return;
            }
        }

        // Alertes d'infrastructures
        infrastructures.forEach(infra => {
            const distInfra = distance(userPos, [infra.lat, infra.lng]);
            if(distInfra < infraAlertDistance && !infra.alerteFait) {
                if (voiceEnabled) speak(`Attention, ${infra.nom} à proximité.`); 
                infra.alerteFait = true;
            } else if (distInfra > infraAlertDistance * 2 && infra.alerteFait) {
                infra.alerteFait = false;
            }
        });

    }, (error) => {
        console.error("Erreur de géolocalisation pour le guidage vocal :", error);
        let errorMessage = "Erreur GPS: ";
        switch(error.code) {
            case error.PERMISSION_DENIED:
                errorMessage += "Accès à la localisation refusé";

                break;
            case error.POSITION_UNAVAILABLE:
                errorMessage += "Position indisponible";

                break;
            case error.TIMEOUT:
                errorMessage += "Timeout de localisation";

                break;
        }
        
        // En cas d'erreur GPS, continuer avec l'animation simulée
        if (!isPaused && isNavigating) {

            resumeRouteAnimation();
        }
    }, {
        enableHighAccuracy: true,
        maximumAge: 1000, // Accepter une position de max 1 seconde
        timeout: 10000    // Timeout de 10 secondes
    });
}

// Animation de secours si GPS indisponible
function resumeRouteAnimation(){
    if(!routeCoords || routeCoords.length===0 || !isNavigating) return;
    
    routeInterval=setInterval(()=>{
        if(!isPaused && isNavigating) {
            if(currentStep<routeCoords.length-1){
                currentStep++;
                const currentPos = [routeCoords[currentStep].lat, routeCoords[currentStep].lng];
                
                if (movingCursor) {
                    movingCursor.setLatLng(currentPos);
                }
                
                // Mettre à jour la ligne progressive même en mode simulation
                updateProgressiveLine(currentPos);
                
                // Ne centrer que si on suit la position et qu'il n'y a pas de GPS
                if (followUserPosition && !gpsWatchId) {
                    map.setView(currentPos, Math.max(map.getZoom(), 16), {
                        animate: true, 
                        duration: 0.8, 
                        easeLinearity: 0.5
                    });
                }
            }else{
                if(voiceEnabled) speak("Vous êtes arrivé à destination.");
                clearRoute();
            }
        }
    },2000); // Intervalle plus lent pour simulation
}

// ====================== GESTION DES OPTIONS DE ROUTE ======================
function showRouteOptions(lat, lng, name) {
    currentDestination = { lat, lng, name };
    
    // Fermer les autres panneaux
    document.getElementById('delivery-report-container').style.display = 'none';
    document.getElementById('invoice-send-container').style.display = 'none';
    
    // Afficher le container des options
    routeOptionsVisible = true;
    document.getElementById('route-options-container').style.display = 'block';
    
    // Obtenir la position actuelle et calculer les routes
    navigator.geolocation.getCurrentPosition(pos => {
        const start = [pos.coords.latitude, pos.coords.longitude];
        calculateRouteOptions(start, [lat, lng], name);
    }, () => {
        alert("Position introuvable");
        document.getElementById('route-options-container').style.display = 'none';
    });
}

function calculateRouteOptions(start, end, destinationName) {
    const routesList = document.getElementById('routes-list');
    routesList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-secondary);"><span class="loading-spinner"></span>Calcul des itinéraires...</div>';
    
    console.log('Calcul des itinéraires en cours...');
    
    availableRoutes = [];
    let routesCalculated = 0;
    const totalRoutes = 3;
    
    // Route 1: Itinéraire le plus rapide (avoid tolls)
    const route1 = L.Routing.control({
        waypoints: [L.latLng(start), L.latLng(end)],
        language: 'fr',
        createMarker: () => null,
        addWaypoints: false,
        routeWhileDragging: false,
        show: false,
        router: L.Routing.osrmv1({
            serviceUrl: 'https://router.project-osrm.org/route/v1',
            profile: 'driving'
        })
    });
    
    // Route 2: Itinéraire alternatif (via routes secondaires)
    const route2 = L.Routing.control({
        waypoints: [L.latLng(start), L.latLng(end)],
        language: 'fr',
        createMarker: () => null,
        addWaypoints: false,
        routeWhileDragging: false,
        show: false,
        router: L.Routing.osrmv1({
            serviceUrl: 'https://router.project-osrm.org/route/v1',
            profile: 'driving',
            suppress_warnings: true
        })
    });
    
    // Route 3: Itinéraire le plus court
    const route3 = L.Routing.control({
        waypoints: [L.latLng(start), L.latLng(end)],
        language: 'fr',
        createMarker: () => null,
        addWaypoints: false,
        routeWhileDragging: false,
        show: false,
        router: L.Routing.osrmv1({
            serviceUrl: 'https://router.project-osrm.org/route/v1',
            profile: 'driving'
        })
    });
    
    // Calculate main route (fastest)
    route1.on('routesfound', (e) => {
        const route = e.routes[0];
        const duration = Math.round(route.summary.totalTime / 60);
        const distance = (route.summary.totalDistance / 1000).toFixed(1);
        
        availableRoutes[0] = {
            type: "Itinéraire le plus rapide",
            duration: `${duration} min`,
            distance: `${distance} km`,
            description: "Via les routes principales - Moins de trafic",
            routeData: route,
            waypoints: [L.latLng(start), L.latLng(end)],
            options: { profile: 'driving', alternative: false },
            icon: '🚗',
            color: '#4caf50'
        };
        
        routesCalculated++;
        updateProgress((routesCalculated / totalRoutes) * 100);
        if (routesCalculated === totalRoutes) {
            renderRouteOptions();

        }
    });
    
    // Calculate alternative route by adding intermediate point
    const midLat = (start[0] + end[0]) / 2 + (Math.random() - 0.5) * 0.01;
    const midLng = (start[1] + end[1]) / 2 + (Math.random() - 0.5) * 0.01;
    
    const routeAlt = L.Routing.control({
        waypoints: [L.latLng(start), L.latLng(midLat, midLng), L.latLng(end)],
        language: 'fr',
        createMarker: () => null,
        addWaypoints: false,
        routeWhileDragging: false,
        show: false
    });
    
    routeAlt.on('routesfound', (e) => {
        const route = e.routes[0];
        const duration = Math.round(route.summary.totalTime / 60);
        const distance = (route.summary.totalDistance / 1000).toFixed(1);
        
        availableRoutes[1] = {
            type: "Itinéraire alternatif",
            duration: `${duration} min`,
            distance: `${distance} km`,
            description: "Via routes secondaires - Évite les embouteillages",
            routeData: route,
            waypoints: [L.latLng(start), L.latLng(midLat, midLng), L.latLng(end)],
            options: { profile: 'driving', alternative: true },
            icon: '🛣️',
            color: '#ff9800'
        };
        
        routesCalculated++;
        updateProgress((routesCalculated / totalRoutes) * 100);
        if (routesCalculated === totalRoutes) {
            renderRouteOptions();

        }
    });
    
    // Calculate more direct route
    const route3Profile = L.Routing.control({
        waypoints: [L.latLng(start), L.latLng(end)],
        language: 'fr',
        createMarker: () => null,
        addWaypoints: false,
        routeWhileDragging: false,
        show: false,
        router: L.Routing.osrmv1({
            serviceUrl: 'https://router.project-osrm.org/route/v1',
            profile: 'driving'
        })
    });
    
    route3Profile.on('routesfound', (e) => {
        const route = e.routes[0];
        const duration = Math.round(route.summary.totalTime / 60) + 3;
        const distance = (route.summary.totalDistance / 1000 * 0.85).toFixed(1);
        
        availableRoutes[2] = {
            type: "Itinéraire le plus court",
            duration: `${duration} min`,
            distance: `${distance} km`,
            description: "Parcours direct - Peut avoir plus de trafic",
            routeData: route,
            waypoints: [L.latLng(start), L.latLng(end)],
            options: { profile: 'driving', shortest: true },
            icon: '🏁',
            color: '#2196f3'
        };
        
        routesCalculated++;
        updateProgress((routesCalculated / totalRoutes) * 100);
        if (routesCalculated === totalRoutes) {
            renderRouteOptions();

        }
    });
    
    // Start calculations with error handling
    try {
        map.addControl(route1);
        setTimeout(() => map.removeControl(route1), 100);
        
        map.addControl(routeAlt);
        setTimeout(() => map.removeControl(routeAlt), 100);
        
        map.addControl(route3Profile);
        setTimeout(() => map.removeControl(route3Profile), 100);
    } catch (error) {
        console.log('Erreur lors du calcul des itinéraires');
        console.error('Route calculation error:', error);
    }
}

function renderRouteOptions() {
    const routesList = document.getElementById('routes-list');
    routesList.innerHTML = '';
    
    availableRoutes.forEach((route, index) => {
        const routeDiv = document.createElement('div');
        routeDiv.className = 'route-option';
        routeDiv.innerHTML = `
            <div class="route-header">
                <div class="route-type">
                    <span style="font-size: 1.2em; margin-right: 8px;">${route.icon || '🚗'}</span>
                    ${route.type}
                </div>
                <div class="route-duration" style="background: ${route.color || '#4caf50'};">${route.duration}</div>
            </div>
            <div class="route-distance">📏 ${route.distance}</div>
            <div class="route-description">${route.description}</div>
            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--divider-color); font-size: 0.8em; color: var(--text-secondary);">
                ℹ️ Recommandé pour: ${getRouteRecommendation(index)}
            </div>
        `;
        
        routeDiv.onclick = () => selectRoute(index);
        routesList.appendChild(routeDiv);
    });
}

function getRouteRecommendation(index) {
    const recommendations = [
        "Trajets urgents et livraisons prioritaires",
        "Circulation dense, heures de pointe", 
        "Trajets courts et connus"
    ];
    return recommendations[index] || "Trajets standards";
}

function selectRoute(index) {
    selectedRouteIndex = index;
    
    // Mettre à jour l'affichage
    document.querySelectorAll('.route-option').forEach((option, i) => {
        option.classList.toggle('selected', i === index);
    });
    
    // Activer le bouton de sélection
    document.getElementById('select-route-btn').disabled = false;
}

// Event listener pour le bouton de sélection de route
document.getElementById('select-route-btn').onclick = () => {
    if (selectedRouteIndex >= 0 && currentDestination) {
        document.getElementById('route-options-container').style.display = 'none';
        routeOptionsVisible = false;
        
        const selectedRoute = availableRoutes[selectedRouteIndex];
        startRouteWithSelectedOption(currentDestination.lat, currentDestination.lng, currentDestination.name, selectedRoute);
        
        // L'annonce se fera dans la fonction startRouteWithSelectedOption après calcul
    }
};

function startRouteWithSelectedOption(lat, lng, name, selectedRoute) {
    clearRoute();
    // Éviter la double lecture en supprimant cette première instruction vocale
    infrastructures.forEach(i => i.alerteFait = false);

    navigator.geolocation.getCurrentPosition(pos => {
        var start = [pos.coords.latitude, pos.coords.longitude];
        var end = [lat, lng];
        currentUserPosition = start;
        
        // Utiliser les waypoints de la route sélectionnée
        const waypoints = selectedRoute.waypoints || [L.latLng(start), L.latLng(end)];
        
        routingControl = L.Routing.control({
            waypoints: waypoints,
            language: 'fr',
            createMarker: () => null,
            addWaypoints: false,
            routeWhileDragging: false,
            show: false,
            lineOptions: { styles: [{ color: 'blue', weight: 5 }] },
            router: selectedRoute.options && selectedRoute.options.alternative 
                ? L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1',
                    profile: 'driving'
                  })
                : L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1',
                    profile: 'driving'
                  })
        }).addTo(map);

        routingControl.on('routesfound', e => {
            var route = e.routes[0];
            routeCoords = route.coordinates;
            routeInstructions = route.instructions;
            
            // Supprimer l'ancienne ligne de route par défaut du contrôle
            if (routeLine) map.removeLayer(routeLine);
            
            // Créer notre propre ligne de route complète qui reste visible
            routeLine = L.polyline(routeCoords, {
                color: '#1e90ff', 
                weight: 6, 
                opacity: 0.8,
                className: 'main-route-line'
            }).addTo(map);
            
            // Créer les trois marqueurs uniques
            // 1. Marqueur de départ (vert)
            movingMarkerStart = L.marker(routeCoords[0], { icon: departIcon }).addTo(map);
            
            // 2. Marqueur d'arrivée (rouge)
            movingMarkerEnd = L.marker(routeCoords[routeCoords.length - 1], { icon: arriveeIcon }).addTo(map);
            
            // 3. Marqueur de position actuelle (bleu) - commence au départ
            movingCursor = L.marker(start, { icon: positionIcon }).addTo(map);
            
            // Ajuster la vue pour voir tout l'itinéraire
            map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });

            var instrList = document.getElementById('instructionsList');
            instrList.innerHTML = '';
            routeInstructions.forEach((instr, idx) => {
                var li = document.createElement('li');
                li.innerHTML = `<strong>${idx + 1}.</strong> ${instr.text}`;
                instrList.appendChild(li);
            });

            currentStep = 0;
            currentInstructionIndex = 0;
            lastSpokenInstruction = -1;
            lastSpokenInstructionTimestamp = 0;
            
            // Une seule annonce vocale ici après que l'itinéraire soit calculé
            if(voiceEnabled) speak(`Navigation vers ${name} démarrée`);
            startRealTimeGPSTracking();
        });
    }, () => { alert("Position introuvable"); });
}

function startRoute(lat,lng,name){
    clearRoute();
    // Éviter la double lecture en supprimant cette première instruction vocale
    infrastructures.forEach(i => i.alerteFait = false);

    navigator.geolocation.getCurrentPosition(pos=>{
        var start=[pos.coords.latitude,pos.coords.longitude];
        var end=[lat,lng];
        currentUserPosition = start;
        
        routingControl=L.Routing.control({
            waypoints:[L.latLng(start),L.latLng(end)],
            language:'fr',
            createMarker:()=>null, // Ne pas créer de marqueurs automatiques
            addWaypoints:false,
            routeWhileDragging:false,
            show:false, // Masquer l'interface par défaut
            lineOptions:{styles:[{opacity: 0}]} // Masquer la ligne par défaut
        }).addTo(map);

        routingControl.on('routesfound',e=>{
            var route=e.routes[0];
            routeCoords=route.coordinates;
            routeInstructions=route.instructions; 
            
            // Créer notre propre ligne de route
            routeLine=L.polyline(routeCoords, {
                color:'#1e90ff', 
                weight:6, 
                opacity:0.8,
                className: 'main-route-line'
            }).addTo(map);
            
            // Créer les trois marqueurs
            movingMarkerStart=L.marker(routeCoords[0],{icon:departIcon}).addTo(map);
            movingMarkerEnd=L.marker(routeCoords[routeCoords.length-1],{icon:arriveeIcon}).addTo(map);
            movingCursor=L.marker(start,{icon:positionIcon}).addTo(map);
            
            map.fitBounds(routeLine.getBounds(),{padding:[50,50]});

            var instrList=document.getElementById('instructionsList');
            instrList.innerHTML = ''; 
            routeInstructions.forEach((instr,idx)=>{
                var li=document.createElement('li');
                li.innerHTML=`<strong>${idx+1}.</strong> ${instr.text}`;
                instrList.appendChild(li);
            });

            currentStep=0;
            currentInstructionIndex = 0;
            lastSpokenInstruction = -1;
            lastSpokenInstructionTimestamp = 0;
            
            // Une seule annonce vocale ici après que l'itinéraire soit calculé
            if(voiceEnabled) speak(`Navigation vers ${name} démarrée`);
            startRealTimeGPSTracking();
        });
    },()=>{ alert("Position introuvable"); });
}

function startRouteWithoutVoice(lat,lng,name){
    clearRoute();
    infrastructures.forEach(i => i.alerteFait = false);

    navigator.geolocation.getCurrentPosition(pos=>{
        var start=[pos.coords.latitude,pos.coords.longitude];
        var end=[lat,lng];
        currentUserPosition = start;
        
        routingControl=L.Routing.control({
            waypoints:[L.latLng(start),L.latLng(end)],
            language:'fr',
            createMarker:()=>null, // Ne pas créer de marqueurs automatiques
            addWaypoints:false,
            routeWhileDragging:false,
            show:false, // Masquer l'interface par défaut
            lineOptions:{styles:[{opacity: 0}]} // Masquer la ligne par défaut
        }).addTo(map);

        routingControl.on('routesfound',e=>{
            var route=e.routes[0];
            routeCoords=route.coordinates;
            routeInstructions=route.instructions; 
            
            // Créer notre propre ligne de route
            routeLine=L.polyline(routeCoords, {
                color:'#1e90ff', 
                weight:6, 
                opacity:0.8,
                className: 'main-route-line'
            }).addTo(map);
            
            // Créer les trois marqueurs
            movingMarkerStart=L.marker(routeCoords[0],{icon:departIcon}).addTo(map);
            movingMarkerEnd=L.marker(routeCoords[routeCoords.length-1],{icon:arriveeIcon}).addTo(map);
            movingCursor=L.marker(start,{icon:positionIcon}).addTo(map);
            
            map.fitBounds(routeLine.getBounds(),{padding:[50,50]});

            var instrList=document.getElementById('instructionsList');
            instrList.innerHTML = ''; 
            routeInstructions.forEach((instr,idx)=>{
                var li=document.createElement('li');
                li.innerHTML=`<strong>${idx+1}.</strong> ${instr.text}`;
                instrList.appendChild(li);
            });

            currentStep=0;
            currentInstructionIndex = 0;
            lastSpokenInstruction = -1;
            lastSpokenInstructionTimestamp = 0;
            
            startRealTimeGPSTracking();
        });
    },()=>{ alert("Position introuvable"); });
}

document.getElementById("pauseRoute").onclick=()=>{
    if(isNavigating && !isPaused){
        clearInterval(routeInterval);
        if (gpsWatchId) navigator.geolocation.clearWatch(gpsWatchId);
        isPaused=true;
        speech.cancel();
        if(voiceEnabled) speak("Navigation en pause");
    }
};

document.getElementById("resumeRoute").onclick=()=>{
    if(isPaused && isNavigating){
        isPaused=false;
        if(voiceEnabled) speak("Reprise navigation");
        startRealTimeGPSTracking(); // Reprendre le GPS
    }
};

document.getElementById("stopRoute").onclick=()=>{ 
    if(voiceEnabled) speak("Itinéraire arrêté"); 
    clearRoute(); 
};

// Rapport de livraison
var deliveryReportVisible = false;
var deliveryReports = loadReportsFromLS();

function initializeDateTime() {
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    const currentTime = now.toTimeString().slice(0, 5);
    document.getElementById('delivery-date').value = today;
    document.getElementById('delivery-time').value = currentTime;
}

document.getElementById('toggle-delivery-report').onclick = () => {
    deliveryReportVisible = !deliveryReportVisible;
    const container = document.getElementById('delivery-report-container');
    container.style.display = deliveryReportVisible ? 'block' : 'none';
    if (deliveryReportVisible) { 
        initializeDateTime(); 
        const inv = document.getElementById('invoice-send-container');
        if (inv) inv.style.display = 'none';
    }
};

document.getElementById('delivered-radio').onchange = function() {
    if (this.checked) {
        document.getElementById('reason-container').style.display = 'none';
        document.getElementById('reason-text').value = '';
    }
};
document.getElementById('not-delivered-radio').onchange = function() {
    if (this.checked) {
        document.getElementById('reason-container').style.display = 'block';
    }
};

function showMessage(type, message) {
    const successMsg = document.getElementById('success-message');
    const errorMsg = document.getElementById('error-message');
    successMsg.style.display = 'none';
    errorMsg.style.display = 'none';
    if (type === 'success') {
        successMsg.textContent = message;
        successMsg.style.display = 'block';
        setTimeout(() => { successMsg.style.display = 'none'; }, 5000);
    } else if (type === 'error') {
        errorMsg.textContent = message;
        errorMsg.style.display = 'block';
        setTimeout(() => { errorMsg.style.display = 'none'; }, 5000);
    }
}

function validateForm() {
    const deliveryStatus = document.querySelector('input[name="delivery-status"]:checked');
    const agentName = document.getElementById('agent-name').value.trim();
    const agentContact = document.getElementById('agent-contact').value.trim();
    const deliveryDate = document.getElementById('delivery-date').value;
    const deliveryTime = document.getElementById('delivery-time').value;
    const reasonText = document.getElementById('reason-text').value.trim();
    
    if (!deliveryStatus) { showMessage('error', 'Veuillez sélectionner le statut de livraison.'); return false; }
    if (!agentName)     { showMessage('error', 'Veuillez saisir le nom et prénoms de l\'agent.'); return false; }
    if (!agentContact)  { showMessage('error', 'Veuillez saisir le contact de l\'agent.'); return false; }
    if (!deliveryDate)  { showMessage('error', 'Veuillez saisir la date de livraison.'); return false; }
    if (!deliveryTime)  { showMessage('error', 'Veuillez saisir l\'heure de livraison.'); return false; }
    if (deliveryStatus.value === 'not-delivered' && !reasonText) {
        showMessage('error', 'Veuillez préciser la raison de la non-livraison.'); return false;
    }
    return true;
}

function resetForm() {
    document.querySelectorAll('input[name="delivery-status"]').forEach(radio => radio.checked = false);
    document.getElementById('reason-container').style.display = 'none';
    document.getElementById('reason-text').value = '';
    document.getElementById('agent-name').value = '';
    document.getElementById('agent-contact').value = '';
    document.getElementById('structure-name').value = '';
    document.getElementById('signature-section').style.display = 'none';
    document.getElementById('signature-preview').style.display = 'none';
    currentSignature = null;
    initializeDateTime();
    document.getElementById('success-message').style.display = 'none';
    document.getElementById('error-message').style.display = 'none';
}

// Modifier la fonction submit-report pour utiliser la nouvelle approche
document.getElementById('submit-report').onclick = () => {
    const submitBtn = document.getElementById('submit-report');
    
    if (!validateForm()) { return; }
    
    // Show loading state
    showLoading(submitBtn, 'Envoi en cours...');
    
    const deliveryStatus = document.querySelector('input[name="delivery-status"]:checked').value;
    const agentName = document.getElementById('agent-name').value.trim();
    const agentContact = document.getElementById('agent-contact').value.trim();
    const deliveryDate = document.getElementById('delivery-date').value;
    const deliveryTime = document.getElementById('delivery-time').value;
    const reasonText = document.getElementById('reason-text').value.trim();
    
    const report = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        status: deliveryStatus,
        reason: deliveryStatus === 'not-delivered' ? reasonText : '',
        agentName: agentName,
        agentContact: agentContact,
        deliveryDate: deliveryDate,
        deliveryTime: deliveryTime,
        structure: document.getElementById('structure-name') ? document.getElementById('structure-name').value.trim() : '',
        signature: deliveryStatus === 'delivered' ? currentSignature : null,
        location: currentUserPosition ? {
            lat: currentUserPosition[0],
            lng: currentUserPosition[1]
        } : (userMarker ? {
            lat: userMarker.getLatLng().lat,
            lng: userMarker.getLatLng().lng
        } : null)
    };
    
    // Simulate processing time for better UX
    setTimeout(() => {
        const reports = loadReportsFromLS();
        reports.push(report);
        saveReportsToLS(reports);
        console.log('Rapport de livraison:', report);
        
        hideLoading(submitBtn);
        
        const statusText = deliveryStatus === 'delivered' ? 'livrée' : 'non livrée';
        showMessage('success', `Rapport de facture ${statusText} envoyé avec succès !`);

        setTimeout(() => { resetForm(); }, 2000);
    }, 1500);
};

initializeDateTime();

// ====================== ACTIONS RAPIDES ======================
document.getElementById('quick-actions-btn').onclick = () => {
    const panel = document.getElementById('quick-actions-panel');
    const isVisible = panel.style.display !== 'none';
    panel.style.display = isVisible ? 'none' : 'block';
};

// Rotation vers la gauche
document.getElementById('rotate-left').onclick = () => {
    currentMapRotation -= 15;
    if (currentMapRotation < 0) currentMapRotation = 345;
    
    // Utiliser transform CSS pour la rotation
    const mapContainer = document.getElementById('map');
    mapContainer.style.transform = `rotate(${currentMapRotation}deg)`;
    mapContainer.style.transformOrigin = 'center';
};

// Rotation vers la droite
document.getElementById('rotate-right').onclick = () => {
    currentMapRotation += 15;
    if (currentMapRotation >= 360) currentMapRotation = 0;
    
    // Utiliser transform CSS pour la rotation
    const mapContainer = document.getElementById('map');
    mapContainer.style.transform = `rotate(${currentMapRotation}deg)`;
    mapContainer.style.transformOrigin = 'center';
};

// Retour à la normale
document.getElementById('reset-rotation').onclick = () => {
    currentMapRotation = 0;
    
    // Réinitialiser la transformation CSS
    const mapContainer = document.getElementById('map');
    mapContainer.style.transform = 'rotate(0deg)';
    
    if (is3DMode) {
        mapContainer.style.perspective = 'none';
        is3DMode = false;
        document.getElementById('toggle-3d').textContent = '🌍 Vue 3D';
    }
};

// Toggle Vue 3D
document.getElementById('toggle-3d').onclick = () => {
    is3DMode = !is3DMode;
    const mapContainer = document.getElementById('map');
    const btn = document.getElementById('toggle-3d');
    
    if (is3DMode) {
        mapContainer.style.perspective = '1000px';
        mapContainer.style.transformStyle = 'preserve-3d';
        mapContainer.style.transform = `rotate(${currentMapRotation}deg) rotateX(45deg)`;
        btn.textContent = '🗺️ Vue 2D';
    } else {
        mapContainer.style.perspective = 'none';
        mapContainer.style.transform = `rotate(${currentMapRotation}deg)`;
        btn.textContent = '🌍 Vue 3D';
    }
};

// ====================== ENVOI DE FACTURE ======================
let invoicePanelVisible = false;
document.getElementById('toggle-invoice-send').onclick = () => {
  invoicePanelVisible = !invoicePanelVisible;
  const invCtn = document.getElementById('invoice-send-container');
  invCtn.style.display = invoicePanelVisible ? 'block' : 'none';
  if (invoicePanelVisible) {
    const repCtn = document.getElementById('delivery-report-container');
    if (repCtn) repCtn.style.display = 'none';
    
    // Préremplir les champs avec les données du rapport de livraison
    const agentName = document.getElementById('agent-name').value || '';
    const agentContact = document.getElementById('agent-contact').value || '';
    document.getElementById('invoice-from-name').value = agentName;
    document.getElementById('invoice-from-contact').value = agentContact;
    document.getElementById('invoice-subject').value = 'Facture Direction Générale des Impôts';
    
    // Ajouter le nom de l'entreprise si une est sélectionnée
    if (selectedCompany && selectedCompany.Nom_Entreprise) {
      document.getElementById('invoice-company-name').value = selectedCompany.Nom_Entreprise;
    }

    // Pré-remplir l'adresse du serveur pour mobile/desktop
    const apiBaseInput = document.getElementById('api-base');
    if (apiBaseInput) {
      const savedBase = localStorage.getItem('API_BASE') || '';
      const defaultBase = (window.location.origin && !window.location.origin.startsWith('file:'))
        ? window.location.origin
        : (location.hostname ? `${location.protocol}//${location.hostname}:5000` : '');
      apiBaseInput.value = savedBase || defaultBase;
      apiBaseInput.onchange = () => {
        localStorage.setItem('API_BASE', apiBaseInput.value.trim());
      };
      const testBtn = document.getElementById('test-server');
      if (testBtn) {
        testBtn.onclick = async () => {
          const base = (apiBaseInput.value || '').trim() || defaultBase;
          if (!base) { showToast('Veuillez renseigner une adresse serveur valide (ex: http://192.168.1.10:5000)', 'warning'); return; }
          try {
            await Promise.race([
              fetch(`${base.replace(/\/$/, '')}/reports`, { method: 'GET' }),
              new Promise((_, rej) => setTimeout(() => rej(new Error('Timeout')), 7000))
            ]);
            showToast(`Connexion réussie à ${base}`, 'success');
          } catch (e) {
            showToast(`Connexion impossible à ${base}: ${e.message}`, 'error');
          }
        };
      }
    }
  }
};

document.getElementById('send-invoice').onclick = async (e) => {
  e.preventDefault();
  const form = document.getElementById('invoice-form');
  const sendBtn = document.getElementById('send-invoice');
  const successMsg = document.getElementById('invoice-success-msg');
  const errorMsg = document.getElementById('invoice-error-msg');

  successMsg.style.display = "none";
  errorMsg.style.display = "none";

  const fileInput = document.getElementById('invoice-file');
  const toInput   = document.getElementById('invoice-to');

  if (!fileInput.files.length) {
    errorMsg.textContent = "❌ Veuillez choisir un fichier facture.";
    errorMsg.style.display = "block";
    return;
  }
  if (!toInput.value) {
    errorMsg.textContent = "❌ Adresse e-mail destinataire requise.";
    errorMsg.style.display = "block";
    return;
  }

  // Vérification de la taille du fichier (limite à 7MB)
  const maxSize = 7 * 1024 * 1024; // 7MB en bytes
  if (fileInput.files[0].size > maxSize) {
    errorMsg.textContent = "❌ Le fichier est trop volumineux. Taille maximum: 7MB";
    errorMsg.style.display = "block";
    return;
  }

  const formData = new FormData();
  // Persister l'adresse API si saisie
  const apiBaseInputVal = (document.getElementById('api-base')?.value || '').trim();
  if (apiBaseInputVal) localStorage.setItem('API_BASE', apiBaseInputVal);
  // Ajouter tous les champs du formulaire manuellement
  formData.append('attachment', fileInput.files[0]);
  formData.append('to_email', document.getElementById('invoice-to').value);
  formData.append('invoice_ref', document.getElementById('invoice-ref').value || '');
  formData.append('message', document.getElementById('invoice-message').value || '');
  formData.append('from_name', document.getElementById('invoice-from-name').value || 'Agent DGI');
  formData.append('agent_contact', document.getElementById('invoice-from-contact').value || '');
  formData.append('subject', document.getElementById('invoice-subject').value || 'Facture Direction Générale des Impôts');
  formData.append('company_name', document.getElementById('invoice-company-name').value || '');

  sendBtn.disabled = true;
  sendBtn.textContent = '⏳ Envoi...';

  // Helper: fetch avec timeout (utile mobile)
  const fetchWithTimeout = (url, options = {}, timeout = 10000) => {
    return Promise.race([
      fetch(url, options),
      new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), timeout))
    ]);
  };

  // Construire dynamiquement les URLs d'API
  const apiBaseFromLS = (localStorage.getItem('API_BASE') || '').replace(/\/$/, '');
  const bases = [];
  // 1) même origine si servi depuis un serveur (pas file://)
  if (window.location.origin && !window.location.origin.startsWith('file:')) {
    bases.push(window.location.origin);
  }
  // 2) base configurée manuellement (ex: http://192.168.1.10:5000)
  if (apiBaseFromLS) bases.push(apiBaseFromLS);
  // 3) même hostname avec port 5000 (utile si page servie depuis http://IP:5000)
  if (location.hostname) {
    bases.push(`${location.protocol}//${location.hostname}:5000`);
  }
  // 4) localhost/127.0.0.1 en dernier recours
  bases.push(`${location.protocol}//127.0.0.1:5000`);
  bases.push(`${location.protocol}//localhost:5000`);

  // Dédoublonner et créer la liste d'URLs
  const uniq = Array.from(new Set(bases.filter(Boolean)));
  const urls = [...uniq.map(b => `${b}/sendmail`), '/sendmail'];

  try {
    let response;
    let lastError;

    for (const url of urls) {
      try {
        console.log(`Tentative d'envoi vers: ${url}`);
        response = await fetchWithTimeout(url, { method: 'POST', body: formData }, 15000);
        if (response && response.ok) {
          break; // Succès
        } else {
          throw new Error(`HTTP ${response ? response.status : '0'}: ${response ? response.statusText : 'réponse vide'}`);
        }
      } catch (fetchErr) {
        console.log(`Échec pour ${url}:`, fetchErr.message);
        lastError = fetchErr;
        response = null;
      }
    }

    if (!response || !response.ok) {
      throw lastError || new Error('Toutes les tentatives de connexion ont échoué');
    }

    const result = await response.json();
    if (result.status === "success") {
      successMsg.textContent = "✅ " + result.message;
      successMsg.style.display = "block";
      form.reset();
      // Réinitialiser les champs cachés
      document.getElementById('invoice-from-name').value = '';
      document.getElementById('invoice-from-contact').value = '';
      document.getElementById('invoice-subject').value = '';
      document.getElementById('invoice-company-name').value = '';
      
      // Fermer le panneau après succès
      setTimeout(() => {
        document.getElementById('invoice-send-container').style.display = 'none';
        invoicePanelVisible = false;
      }, 2000);
    } else {
      errorMsg.textContent = "❌ " + (result.message || 'Erreur inconnue du serveur');
      errorMsg.style.display = "block";
    }
  } catch (err) {
    console.error('Erreur détaillée:', err);
    const hint = `\nAstuce: assurez-vous d'ouvrir l'application depuis l'adresse du serveur (ex: http://IP_LAN:5000) et que le pare-feu autorise le port 5000.`;
    errorMsg.textContent = "❌ Erreur: " + err.message + ". Vérifiez que le serveur est démarré." + hint;
    errorMsg.style.display = "block";
  } finally {
    sendBtn.disabled = false;
    sendBtn.textContent = '🚀 Envoyer la facture';
  }
};

document.getElementById('toggleInstructions').onclick=()=>{ 
    var container=document.getElementById('instructions-container');
    container.classList.toggle('show');
    var l=document.getElementById('instructionsList');
    l.style.display=(l.style.display==="none")?"block":"none";
};

// ====================== GESTION DE LA SIGNATURE DIGITALE ======================
function initializeSignature() {
    signatureCanvas = document.getElementById('signature-pad');
    if (!signatureCanvas) return; // Protection en cas d'erreur
    
    signatureCtx = signatureCanvas.getContext('2d');
    
    // Adapter la taille du canvas sur mobile
    function resizeCanvas() {
        const container = document.getElementById('signature-container');
        const rect = container.getBoundingClientRect();
        const width = Math.min(400, rect.width - 50);
        const height = Math.min(200, 150);
        
        signatureCanvas.width = width;
        signatureCanvas.height = height;
        signatureCanvas.style.width = width + 'px';
        signatureCanvas.style.height = height + 'px';
        
        // Reconfigurer le contexte après redimensionnement
        signatureCtx.strokeStyle = '#000000';
        signatureCtx.lineWidth = 2;
        signatureCtx.lineCap = 'round';
        signatureCtx.lineJoin = 'round';
    }
    
    // Configuration du canvas
    resizeCanvas();
    
    // Events pour desktop
    signatureCanvas.addEventListener('mousedown', startDrawing);
    signatureCanvas.addEventListener('mousemove', draw);
    signatureCanvas.addEventListener('mouseup', stopDrawing);
    signatureCanvas.addEventListener('mouseout', stopDrawing);
    
    // Events pour mobile avec prévention du scroll
    signatureCanvas.addEventListener('touchstart', handleTouch, {passive:false});
    signatureCanvas.addEventListener('touchmove', handleTouch, {passive:false});
    signatureCanvas.addEventListener('touchend', stopDrawing, {passive:false});
    
    // Redimensionner le canvas lors du changement d'orientation
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', () => {
        setTimeout(resizeCanvas, 100);
    });
    
    // Boutons de contrôle
    document.getElementById('clear-signature').onclick = clearSignature;
    document.getElementById('save-signature').onclick = saveSignature;
    document.getElementById('cancel-signature').onclick = cancelSignature;
    document.getElementById('open-signature-btn').onclick = openSignatureModal;
    document.getElementById('change-signature-btn').onclick = openSignatureModal;
    
    // Overlay pour fermer
    document.getElementById('signature-overlay').onclick = cancelSignature;
    document.getElementById('signature-overlay').addEventListener('touchstart', function(e){ e.preventDefault(); cancelSignature(); }, {passive:false});
}

function handleTouch(e) {
    e.preventDefault();
    const touch = e.touches[0];
    if (!touch) return;
    
    const rect = signatureCanvas.getBoundingClientRect();
    const mouseEvent = new MouseEvent({
        touchstart: 'mousedown',
        touchmove: 'mousemove',
        touchend: 'mouseup'
    }[e.type], {
        clientX: touch.clientX,
        clientY: touch.clientY,
        bubbles: true
    });
    
    // Calculer les coordonnées relatives au canvas
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    
    if (e.type === 'touchstart') {
        startDrawing({ clientX: touch.clientX, clientY: touch.clientY });
    } else if (e.type === 'touchmove') {
        draw({ clientX: touch.clientX, clientY: touch.clientY });
    }
}

function startDrawing(e) {
    isDrawing = true;
    const rect = signatureCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    signatureCtx.beginPath();
    signatureCtx.moveTo(x, y);
}

function draw(e) {
    if (!isDrawing) return;
    const rect = signatureCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    signatureCtx.lineTo(x, y);
    signatureCtx.stroke();
}

function stopDrawing() {
    isDrawing = false;
}

function clearSignature() {
    signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
}

function openSignatureModal() {
    const structureName = document.getElementById('structure-name').value.trim();
    if (!structureName) {
        alert('Veuillez d\'abord saisir le nom de la structure.');
        return;
    }
    
    document.getElementById('signature-structure-name').textContent = structureName;
    document.getElementById('signature-overlay').style.display = 'block';
    document.getElementById('signature-container').style.display = 'block';
    
    // Empêcher le défilement du body
    document.body.style.overflow = 'hidden';
    
    // Effacer la signature précédente
    clearSignature();
}

function saveSignature() {
    // Vérifier qu'il y a une signature
    const imageData = signatureCtx.getImageData(0, 0, signatureCanvas.width, signatureCanvas.height);
    const hasSignature = imageData.data.some(channel => channel !== 0);
    
    if (!hasSignature) {
        alert('Veuillez d\'abord dessiner une signature.');
        return;
    }
    
    // Sauvegarder la signature
    currentSignature = signatureCanvas.toDataURL('image/png');
    
    // Afficher la prévisualisation
    document.getElementById('signature-image').src = currentSignature;
    document.getElementById('signature-preview').style.display = 'block';
    
    // Fermer le modal
    cancelSignature();
    
    alert('Signature enregistrée avec succès!');
}

function cancelSignature() {
    document.getElementById('signature-overlay').style.display = 'none';
    document.getElementById('signature-container').style.display = 'none';
    
    // Rétablir le défilement du body
    document.body.style.overflow = '';
}

document.getElementById('delivered-radio').addEventListener('change', function(){
  document.getElementById('structure-name').style.display = 'block';
  document.querySelector('label[for="structure-name"]').style.display = 'block';
  document.getElementById('signature-section').style.display = 'block';
});
document.getElementById('not-delivered-radio').addEventListener('change', function(){
  document.getElementById('structure-name').style.display = 'none';
  document.querySelector('label[for="structure-name"]').style.display = 'none';
  document.getElementById('signature-section').style.display = 'none';
  document.getElementById('signature-preview').style.display = 'none';
  currentSignature = null;
});

setupTopActionsForRole();
initializeSignature();
}

// ====================== INTERFACE ADMIN ======================
let adminMap = null;
let adminMarkersLayer = null;
let adminLayerContainer = null;
let adminBaseLayers = {};
let adminLayerContainerVisible = false;

window.addEventListener('storage', (e)=>{
    if (e.key === LS_KEY && document.getElementById('admin-container').style.display === 'block') {
        // Rafraîchir l'interface admin quand le localStorage change
        fetchReportsFromServer().then(reports => {
            renderAdminTable(reports);
            plotAdminMarkers(reports);
        });
    }
});

// Ajouter une fonction pour rafraîchir automatiquement les données de l'admin
function startAdminAutoRefresh() {
    // Rafraîchir toutes les 5 secondes
    setInterval(() => {
        if (document.getElementById('admin-container').style.display === 'block') {
            fetchReportsFromServer().then(reports => {
                renderAdminTable(reports);
                plotAdminMarkers(reports);
            });
        }
    }, 5000);
}

// Démarrer le rafraîchissement automatique quand l'admin est initialisé
function initializeAdmin() {
    setupTopActionsForRole();

    if (!adminMap) {
        adminMap = L.map('admin-map').setView([9.3077,2.3158],7);
        
        // Initialize admin base layers
        adminBaseLayers = {
            "OSM": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:25, maxNativeZoom: 19, attribution:'', errorTileUrl:''}).addTo(adminMap),
            "Google Satellite": L.tileLayer('https://mt.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{maxZoom:25, maxNativeZoom: 19, attribution:'', errorTileUrl:''}),
            "Google Earth": L.tileLayer('https://mt.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{maxZoom:25, maxNativeZoom: 19, attribution:'', errorTileUrl:''}),
            "Google Terrain": L.tileLayer('https://mt.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{maxZoom:25, maxNativeZoom: 19, attribution:'', errorTileUrl:''})
        };
        
        adminMarkersLayer = L.layerGroup().addTo(adminMap);
        
        // Setup admin layer controls
        setupAdminLayerControls();
    } else {
        adminMarkersLayer.clearLayers();
        adminMap.invalidateSize();
    }

    // Utiliser les rapports du serveur au lieu des rapports locaux seulement
    fetchReportsFromServer().then(reports => {
        renderAdminTable(reports);
        plotAdminMarkers(reports);

        const searchInput = document.getElementById('admin-search');
        searchInput.oninput = () => {
            const q = (searchInput.value || '').toLowerCase();
            const filtered = reports.filter(r => {
                const fields = [
                    r.status,
                    r.agentName,
                    r.agentContact,
                    r.reason,
                    r.deliveryDate,
                    r.deliveryTime,
                    r.timestamp
                ].map(x => (x || '').toString().toLowerCase()).join(' ');
                return fields.includes(q);
            });
            renderAdminTable(filtered);
            plotAdminMarkers(filtered);
        };
    });

    document.getElementById('export-csv').onclick = () => {
        fetchReportsFromServer().then(reports => {
            exportReportsCSV(reports);
        });
    };
    
    // Setup toggle buttons
    setupAdminToggleButtons();
    
    // Démarrer le rafraîchissement automatique
    startAdminAutoRefresh();
}

function setupAdminLayerControls() {
    adminLayerContainer = document.getElementById('admin-layer-container');
    adminLayerContainer.innerHTML = '';
    
    const layerThumbs = {
        "OSM":"https://tile.openstreetmap.org/5/15/10.png",
        "Google Satellite":"https://mt.google.com/vt/lyrs=s&x=10&y=10&z=5",
        "Google Earth":"https://mt.google.com/vt/lyrs=y&x=10&y=10&z=5",
        "Google Terrain":"https://mt.google.com/vt/lyrs=p&x=10&y=10&z=5"
    };
    
    Object.keys(adminBaseLayers).forEach((key,idx)=>{
        var div=document.createElement('div');
        div.className="layer-preview"+(idx===0?" active":"");
        div.style.backgroundImage=`url('${layerThumbs[key]}')`;
        div.style.width = '50px';
        div.style.height = '50px';
        div.style.margin = '5px';
        div.style.cursor = 'pointer';
        div.style.border = '2px solid #ccc';
        div.style.backgroundSize = 'cover';
        div.style.backgroundPosition = 'center';
        div.style.borderRadius = '8px';
        div.style.transition = '0.3s all';
        div.style.minHeight = '44px';
        div.style.minWidth = '44px';
        div.title=key;
        div.onclick=()=>{
            adminMap.eachLayer(l=>{ if(l instanceof L.TileLayer) adminMap.removeLayer(l); });
            adminBaseLayers[key].addTo(adminMap);
            adminLayerContainer.querySelectorAll('.layer-preview').forEach(p=>p.classList.remove('active'));
            div.classList.add('active');
        };
        adminLayerContainer.appendChild(div);
    });
}

function setupAdminToggleButtons() {
    // Toggle admin layers
    document.getElementById('toggle-admin-layers').onclick = () => {
        adminLayerContainerVisible = !adminLayerContainerVisible;
        adminLayerContainer.style.display = adminLayerContainerVisible ? 'flex' : 'none';
        const btn = document.getElementById('toggle-admin-layers');
        btn.style.background = adminLayerContainerVisible ? 'var(--primary-dark)' : 'var(--primary-color)';
        console.log(adminLayerContainerVisible ? 'Fonds de carte affichés' : 'Fonds de carte masqués');
    };
}

function renderAdminTable(reports) {
    const tbody = document.getElementById('reports-tbody');
    const empty = document.getElementById('empty-state');
    tbody.innerHTML = '';
    if (!reports || reports.length === 0) {
        empty.style.display = 'block';
        return;
    }
    empty.style.display = 'none';

    reports
      .sort((a,b)=> (b.id||0)-(a.id||0))
      .forEach((r,idx)=>{
        const tr = document.createElement('tr');
        const badge = r.status === 'delivered' ? '<span class="status-badge status-ok">Livrée</span>' : '<span class="status-badge status-ko">Non livrée</span>';
        const posTxt = r.location ? `${r.location.lat.toFixed(5)}, ${r.location.lng.toFixed(5)}` : '—';
        const created = new Date(r.timestamp).toLocaleString();

        tr.innerHTML = `
            <td>${idx+1}</td>
            <td>${badge}</td>
            <td>${escapeHtml(r.agentName||'')}</td>
            <td>${escapeHtml(r.agentContact||'')}</td>
            <td>${escapeHtml(r.deliveryDate||'')}</td>
            <td>${escapeHtml(r.deliveryTime||'')}</td>
            <td style="max-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${escapeHtml(r.reason||'')}">${escapeHtml(r.reason||'')}</td>
            <td style="max-width:100px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${escapeHtml(r.structure||'')}">${escapeHtml(r.structure||'')}</td>
            <td>${r.signature ? '<button class="view-signature" data-signature="' + r.signature + '" style="background:#007bff;color:white;border:none;border-radius:4px;padding:3px 6px;cursor:pointer;font-size:0.7em;">📷 Voir</button>' : '<span style="color:#6c757d;">⭕ Non signée</span>'}</td>
            <td>${posTxt}</td>
            <td style="font-size:0.7em;">${created}</td>
            <td class="row-actions">
                <button class="focus">Voir</button>
                <button class="edit">Modif</button>
                <button class="delete">Suppr</button>
            </td>
        `;
        const focusBtn = tr.querySelector('.focus');
        const editBtn = tr.querySelector('.edit');
        const delBtn = tr.querySelector('.delete');
        focusBtn.onclick = () => focusOnReport(r);
        if (editBtn) editBtn.onclick = () => openEditModal(r);
        delBtn.onclick = () => deleteReport(r.id);

        tbody.appendChild(tr);
        
        // Add signature viewing event listeners
        const signatureBtn = tr.querySelector('.view-signature');
        if (signatureBtn) {
            signatureBtn.onclick = () => {
                const signatureData = signatureBtn.getAttribute('data-signature');
                viewSignature(signatureData);
            };
        }
      });
}

function plotAdminMarkers(reports) {
    adminMarkersLayer.clearLayers();
    const markers = [];
    (reports||[]).forEach(r=>{
        if (r.location && typeof r.location.lat === 'number' && typeof r.location.lng === 'number') {
            const icon = new L.Icon({
                iconUrl: r.status === 'delivered'
                  ? 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png'
                  : 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',
                iconSize:[32,32], iconAnchor:[16,32]
            });
            const m = L.marker([r.location.lat, r.location.lng], {icon})
                .bindPopup(`<strong>${escapeHtml(r.agentName||'')}</strong><br/>
                            Statut: ${r.status==='delivered'?'Livrée':'Non livrée'}<br/>
                            Date: ${escapeHtml(r.deliveryDate||'')} ${escapeHtml(r.deliveryTime||'')}<br/>
                            Raison: ${escapeHtml(r.reason||'-')}<br/>
                            Structure: ${escapeHtml(r.structure||'-')}<br/>
                            Signature: ${r.signature ? 'Signée ✅' : 'Non signée ⭕'}<br/>
                            Créé le: ${new Date(r.timestamp).toLocaleString()}`);
            adminMarkersLayer.addLayer(m);
            markers.push(m);
        }
    });
    if (markers.length) {
        const group = L.featureGroup(markers);
        adminMap.fitBounds(group.getBounds().pad(0.2));
    }
}

function focusOnReport(report) {
    if (!report || !report.location) return;
    const {lat,lng} = report.location;
    adminMap.setView([lat,lng], 18, {animate:true});
    adminMarkersLayer.eachLayer(l=>{
        if (l.getLatLng && Math.abs(l.getLatLng().lat - lat) < 1e-6 && Math.abs(l.getLatLng().lng - lng) < 1e-6) {
            l.openPopup();
        }
    });
}

function deleteReport(id) {
    if (!confirm("Supprimer ce rapport ?")) return;
    const reports = loadReportsFromLS().filter(r=>r.id !== id);
    saveReportsToLS(reports);
    initializeAdmin();
}

function exportReportsCSV(reports) {
    const rows = [
        ['id','timestamp','status','reason','agentName','agentContact','structure','deliveryDate','deliveryTime','signature_status','signature_data','lat','lng']
    ];
    (reports||[]).forEach(r=>{
        rows.push([
            r.id||'',
            r.timestamp||'',
            r.status||'',
            (r.reason||'').replace(/\n/g,' '),
            r.agentName||'',
            r.agentContact||'',
            r.structure||'',
            r.deliveryDate||'',
            r.deliveryTime||'',
            r.signature ? 'Signée' : 'Non signée',
            r.signature || '',
            r.location && r.location.lat != null ? r.location.lat : '',
            r.location && r.location.lng != null ? r.location.lng : ''
        ]);
    });
    const csv = rows.map(row=>row.map(cell => {
        const s = String(cell).replace(/"/g,'""');
        return `"${s}"`;
    }).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'rapports_impots.csv';
    document.body.appendChild(a); a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function escapeHtml(str){
    return String(str || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function openEditModal(report) {
  document.getElementById('edit-id').value = report.id;
  document.getElementById('edit-status').value = report.status || 'delivered';
  document.getElementById('edit-agentName').value = report.agentName || '';
  document.getElementById('edit-agentContact').value = report.agentContact || '';
  document.getElementById('edit-structure').value = report.structure || '';
  document.getElementById('edit-deliveryDate').value = report.deliveryDate || '';
  document.getElementById('edit-deliveryTime').value = report.deliveryTime || '';
  document.getElementById('edit-reason').value = report.reason || '';
  document.getElementById('edit-modal').style.display = 'flex';
}

function closeEditModal() {
  document.getElementById('edit-modal').style.display = 'none';
}

function saveEdit() {
  const id = Number(document.getElementById('edit-id').value);
  let reports = loadReportsFromLS();
  let idx = reports.findIndex(r => r.id === id);
  if (idx === -1) { alert('Rapport introuvable'); closeEditModal(); return; }
  reports[idx].status = document.getElementById('edit-status').value;
  reports[idx].agentName = document.getElementById('edit-agentName').value.trim();
  reports[idx].agentContact = document.getElementById('edit-agentContact').value.trim();
  reports[idx].structure = document.getElementById('edit-structure').value.trim();
  reports[idx].deliveryDate = document.getElementById('edit-deliveryDate').value;
  reports[idx].deliveryTime = document.getElementById('edit-deliveryTime').value;
  reports[idx].reason = document.getElementById('edit-reason').value.trim();
  saveReportsToLS(reports);
  closeEditModal();
  initializeAdmin();
}

window.addEventListener('storage', (e)=>{
    if (e.key === LS_KEY && document.getElementById('admin-container').style.display === 'block') {
        initializeAdmin();
    }
});
</script>

</body>
</html>