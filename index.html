<!DOCTYPE html> 
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Syst√®me de Distribution des Factures Imp√¥ts</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.css" />
<style>
/* Styles pour la page de connexion */
#login-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #007bff, #0056b3);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 20px;
    box-sizing: border-box;
}

#login-container {
    background: rgba(255, 255, 255, 0.95);
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    width: 100%;
    max-width: 350px;
    text-align: center;
}

#login-container h2 {
    margin-top: 0;
    color: #007bff;
    margin-bottom: 25px;
    font-size: 1.8em;
}

.login-input {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1em;
    box-sizing: border-box;
    transition: border-color 0.3s;
}

.login-input:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
}

#login-btn {
    width: 100%;
    padding: 12px;
    background: linear-gradient(145deg, #007bff, #0056b3);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.1em;
    cursor: pointer;
    transition: transform 0.2s, background 0.2s;
    margin-top: 10px;
}

#login-btn:hover {
    background: linear-gradient(145deg, #0056b3, #003f7f);
    transform: translateY(-2px);
}

#login-error {
    color: #dc3545;
    margin-top: 15px;
    display: none;
    font-weight: 500;
}

/* Styles pour l'application principale */
#app-container {
    display: none;
}

body { 
    margin: 0; 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    background: #f5f5f5;
    overflow-x: hidden;
}

#header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    background: #007bff; 
    color: white; 
    padding: 15px; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.3); 
    position: relative; 
    z-index: 1001;
}

#header .header-content {
    display: flex;
    align-items: center;
    flex: 1;
    justify-content: center;
}

#header img { 
    width: 40px; 
    margin-right: 15px; 
}

#header h1 { 
    margin: 0; 
    font-size: 1.4em; 
    text-shadow: 1px 1px 2px #000;
    text-align: center;
}

/* Bouton hamburger pour mobile */
#menu-toggle {
    display: none;
    background: transparent;
    border: none;
    color: white;
    font-size: 1.5em;
    cursor: pointer;
    padding: 8px;
    z-index: 1002;
}

#map { 
    height: calc(100vh - 80px);
    transition: margin-left 0.3s ease;
}

#sidebar { 
    position: fixed;
    top: 80px; 
    left: 0; 
    bottom: 0; 
    width: 280px; 
    z-index: 1000; 
    background: rgba(255,255,255,0.95); 
    backdrop-filter: blur(10px); 
    padding: 15px; 
    overflow-y: auto; 
    display: flex; 
    flex-direction: column; 
    border-radius: 0 12px 12px 0; 
    box-shadow: 2px 4px 12px rgba(0,0,0,0.15);
    transform: translateX(0);
    transition: transform 0.3s ease;
}

#sidebar.hidden {
    transform: translateX(-100%);
}

#sidebar h3 { 
    margin-top: 0; 
    text-align: center; 
    color: #007bff;
    font-size: 1.1em;
}

#sidebar input, #sidebar select { 
    width: calc(100% - 16px); 
    padding: 10px; 
    margin-bottom: 10px; 
    border-radius: 8px; 
    border: 1px solid #ccc; 
    font-size: 0.95em; 
    transition: 0.2s all;
    box-sizing: border-box;
}

#sidebar input:focus, #sidebar select:focus { 
    border-color: #007bff; 
    box-shadow: 0 0 6px rgba(0,123,255,0.4); 
    outline: none; 
}

#sidebar button { 
    width: 100%; 
    padding: 10px; 
    margin-bottom: 8px; 
    border: none; 
    border-radius: 8px; 
    color: white; 
    cursor: pointer; 
    font-weight: 600; 
    transition: 0.25s all; 
    background: linear-gradient(145deg,#007bff,#0056b3); 
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    font-size: 0.9em;
}

#sidebar button:hover { 
    background: linear-gradient(145deg,#0056b3,#003f7f); 
    transform: translateY(-2px); 
}

#companyList { 
    display: none; 
    list-style: none; 
    padding: 0; 
    margin: 0; 
    max-height: 200px; 
    overflow-y: auto; 
    border: 1px solid #ddd; 
    border-radius: 5px; 
}

#companyList li { 
    padding: 8px 10px; 
    cursor: pointer; 
    border-bottom: 1px solid #eee; 
    transition: 0.2s; 
    border-radius: 3px;
    font-size: 0.9em;
}

#companyList li:hover, #companyList li.active { 
    background: #007bff; 
    color: white; 
}

#routeControls { 
    margin-top: auto; 
    border-top: 1px solid #eee; 
    padding-top: 15px; 
}

#routeControls h3 { 
    color: #28a745; 
}

#pauseRoute { background: #ffc107; color: black; }
#resumeRoute { background: #17a2b8; }
#stopRoute { background: #dc3545; }
#locateBtn { background: #28a745; }

#layer-container { 
    position: absolute; 
    top: 90px; 
    right: 10px; 
    z-index: 1000; 
    background: rgba(255,255,255,0.95); 
    backdrop-filter: blur(8px); 
    padding: 10px; 
    border-radius: 12px; 
    display: flex; 
    flex-direction: column; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.25); 
}

.layer-preview { 
    width: 50px; 
    height: 50px; 
    margin: 5px; 
    cursor: pointer; 
    border: 2px solid #ccc; 
    background-size: cover; 
    background-position: center; 
    border-radius: 8px; 
    transition: 0.3s all; 
}

.layer-preview.active, .layer-preview:hover { 
    transform: scale(1.1); 
    border-color: #007bff; 
    box-shadow: 0 2px 8px rgba(0,123,255,0.4); 
}

#instructions-container { 
    position: absolute; 
    bottom: 10px; 
    right: 10px; 
    z-index: 1001; 
    max-width: 300px; 
    background: rgba(255,255,255,0.9); 
    backdrop-filter: blur(10px); 
    border-radius: 10px; 
    box-shadow: 0 4px 14px rgba(0,0,0,0.25); 
    padding: 15px; 
    font-size: 0.9em; 
    transition: transform 0.3s ease, opacity 0.3s ease; 
    transform: translateY(20px); 
    opacity: 0.95; 
}

#instructions-container.show { 
    transform: translateY(0); 
    opacity: 1; 
}

#toggleInstructions { 
    background: #007bff; 
    border: none; 
    color: white; 
    padding: 5px 10px; 
    border-radius: 5px; 
    cursor: pointer; 
    font-size: 0.85em; 
    margin-bottom: 5px; 
}

#instructionsList { 
    max-height: 200px; 
    overflow-y: auto; 
    padding-left: 10px; 
}

#instructionsList li { 
    padding: 6px 8px; 
    margin-bottom: 4px; 
    border-radius: 6px; 
    transition: 0.2s; 
}

#instructionsList li.current { 
    background: #007bff; 
    color: white; 
    font-weight: bold; 
    box-shadow: 0 2px 6px rgba(0,123,255,0.4); 
}

.leaflet-container { 
    cursor: url('https://maps.gstatic.com/mapfiles/openhand_8_8.cur'), move; 
}

#toggleLayersBtn { 
    position: absolute; 
    top: 50px; 
    right: 10px; 
    z-index: 1002; 
    padding: 8px 12px; 
    border: none; 
    background: #007bff; 
    color: white; 
    border-radius: 8px; 
    cursor: pointer;
    font-size: 0.85em;
}

/* Rapport de livraison */
#delivery-report-container {
    position: fixed;
    top: 90px;
    left: 300px;
    z-index: 1000;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    width: 350px;
    max-width: calc(100vw - 40px);
    display: none;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
}

#delivery-report-container h3 {
    margin-top: 0;
    color: #007bff;
    text-align: center;
    margin-bottom: 20px;
    font-size: 1.3em;
}

.delivery-option {
    margin-bottom: 15px;
}

.delivery-option input[type="radio"] {
    margin-right: 10px;
    transform: scale(1.2);
}

.delivery-option label {
    font-weight: 500;
    color: #333;
    cursor: pointer;
    display: flex;
    align-items: center;
}

.delivery-option label.delivered {
    color: #28a745;
}

.delivery-option label.not-delivered {
    color: #dc3545;
}

#reason-container {
    display: none;
    margin-top: 10px;
}

#reason-text {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    resize: vertical;
    min-height: 80px;
    font-family: inherit;
    font-size: 0.9em;
    box-sizing: border-box;
}

#reason-text:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.4);
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #333;
}

.form-group input, .form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 0.9em;
    box-sizing: border-box;
}

.form-group input:focus, .form-group textarea:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.4);
}

.datetime-group {
    display: flex;
    gap: 10px;
}

.datetime-group .form-group {
    flex: 1;
}

#submit-report {
    width: 100%;
    padding: 12px;
    background: linear-gradient(145deg, #28a745, #1e7e34);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    margin-top: 10px;
}

#submit-report:hover {
    background: linear-gradient(145deg, #1e7e34, #155724);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

#submit-report:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

#toggle-delivery-report {
    background: linear-gradient(145deg, #28a745, #1e7e34);
    color: white;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    width: 100%;
    padding: 10px;
    margin-bottom: 8px;
    border: none;
}

#toggle-delivery-report:hover {
    background: linear-gradient(145deg, #1e7e34, #155724);
    transform: translateY(-2px);
}

.success-message, .error-message {
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: none;
}

.success-message {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.error-message {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

/* Interface Admin */
#admin-container { display: none; }
#admin-header {
    display: flex; 
    align-items: center; 
    justify-content: space-between;
    background: #343a40; 
    color: #fff; 
    padding: 12px 16px;
    flex-wrap: wrap;
    gap: 10px;
}
#admin-header .title { 
    display: flex; 
    align-items: center; 
    gap: 12px; 
    flex: 1;
}
#admin-header img { width: 36px; }
#admin-actions { 
    display: flex; 
    gap: 8px; 
    flex-wrap: wrap;
}
.admin-btn {
    padding: 8px 12px; 
    border: none; 
    border-radius: 8px; 
    cursor: pointer; 
    color: #fff;
    background: #007bff; 
    font-weight: 600;
    font-size: 0.9em;
}
.admin-btn.secondary { background: #6c757d; }
.admin-btn.danger { background: #dc3545; }
#admin-main { 
    display: grid; 
    grid-template-columns: 1fr; 
    gap: 12px; 
    padding: 12px; 
}
#admin-panel {
    background: #fff; 
    border-radius: 12px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
    padding: 12px;
    order: 2;
}
#admin-panel h2 { 
    margin: 0 0 10px; 
    color: #007bff; 
    font-size: 1.3em; 
}
#admin-search { 
    width: 100%; 
    padding: 10px; 
    border: 1px solid #ddd; 
    border-radius: 8px; 
    margin-bottom: 8px;
    box-sizing: border-box;
}
#reports-table { 
    width: 100%; 
    border-collapse: collapse; 
    font-size: 0.85em;
    overflow-x: auto;
}
#reports-table th, #reports-table td { 
    border-bottom: 1px solid #eee; 
    padding: 6px 4px; 
    text-align: left;
    word-wrap: break-word;
}
#reports-table th { 
    position: sticky; 
    top: 0; 
    background: #f7f9fc; 
    z-index: 1; 
    font-size: 0.8em;
}
.status-badge { 
    padding: 2px 6px; 
    border-radius: 999px; 
    font-weight: 700; 
    font-size: 0.7em;
    white-space: nowrap;
}
.status-ok { background: #d4edda; color: #155724; }
.status-ko { background: #f8d7da; color: #721c24; }
.row-actions button { 
    border: none; 
    border-radius: 6px; 
    padding: 3px 6px; 
    margin-right: 2px; 
    cursor: pointer;
    font-size: 0.7em;
}
.row-actions .focus { background: #17a2b8; color: #fff; }
.row-actions .edit { background: #28a745; color: #fff; }
.row-actions .delete { background: #ffc107; color: #000; }
#admin-map { 
    height: 400px; 
    border-radius: 12px; 
    overflow: hidden; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    order: 1;
}
#empty-state { 
    font-size: 0.95em; 
    color: #555; 
    padding: 8px 0 0; 
}

#top-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}
.top-btn {
    padding: 6px 10px;
    border: none;
    border-radius: 999px;
    cursor: pointer;
    font-weight: 700;
    background: #ffffff;
    color: #007bff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    font-size: 0.85em;
}
.top-btn.danger { color: #fff; background: #dc3545; }
.top-btn.dark { color: #fff; background: #343a40; }

/* Envoi Facture */
#invoice-send-container {
    position: fixed;
    top: 90px;
    left: 300px;
    z-index: 1000;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    width: 350px;
    max-width: calc(100vw - 40px);
    display: none;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
}
#invoice-send-container h3 {
    margin-top: 0;
    color: #007bff;
    text-align: center;
    margin-bottom: 20px;
    font-size: 1.3em;
}
#toggle-invoice-send {
    background: linear-gradient(145deg, #0069d9, #004a9f);
    color: #fff; 
    border-radius: 8px; 
    cursor: pointer; 
    font-weight: 600;
    transition: all .3s; 
    box-shadow: 0 2px 6px rgba(0,0,0,.2);
    width: 100%; 
    padding: 10px; 
    margin-bottom: 8px; 
    border: none;
}
#toggle-invoice-send:hover {
    background: linear-gradient(145deg, #004a9f, #003a80);
    transform: translateY(-2px);
}
#send-invoice {
    width: 100%;
    padding: 12px;
    background: linear-gradient(145deg, #0069d9, #004a9f);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    margin-top: 8px;
}
#send-invoice:hover { 
    background: linear-gradient(145deg, #004a9f, #003a80); 
    transform: translateY(-2px); 
}
#send-invoice:disabled { 
    background: #6c757d; 
    cursor: not-allowed; 
    transform: none; 
}
#invoice-success-msg, #invoice-error-msg {
    padding: 10px; 
    border-radius: 8px; 
    margin-bottom: 12px; 
    display: none; 
    border: 1px solid transparent;
}
#invoice-success-msg { 
    background: #d4edda; 
    color: #155724; 
    border-color: #c3e6cb; 
}
#invoice-error-msg { 
    background: #f8d7da; 
    color: #721c24; 
    border-color: #f5c6cb; 
}
.small-muted { 
    font-size: .85em; 
    color: #666; 
}
.accepted-types { 
    font-size: .85em; 
    color: #007bff; 
}

/* Suppression des bordures des tuiles */
.leaflet-tile,
.leaflet-tile-container img,
.leaflet-layer,
.leaflet-tile-pane,
.leaflet-map-pane,
.leaflet-pane {
    border: none !important;
    box-shadow: none !important;
    outline: none !important;
    background: none !important;
}

/* ====================== MEDIA QUERIES RESPONSIVE ====================== */

/* Tablettes */
@media screen and (max-width: 1024px) {
    #admin-main {
        grid-template-columns: 1fr;
    }
    
    #layer-container {
        right: 5px;
        top: 85px;
    }
    
    .layer-preview {
        width: 40px;
        height: 40px;
    }
    
    #instructions-container {
        max-width: 250px;
        bottom: 5px;
        right: 5px;
    }
}

/* Smartphones et petites tablettes */
@media screen and (max-width: 768px) {
    /* Header responsive */
    #header {
        padding: 10px 15px;
        flex-direction: row;
        justify-content: space-between;
    }
    
    #header .header-content {
        justify-content: flex-start;
        flex: 1;
    }
    
    #header h1 {
        font-size: 1.2em;
        text-align: left;
    }
    
    #header img {
        width: 35px;
        margin-right: 10px;
    }
    
    /* Bouton hamburger visible */
    #menu-toggle {
        display: block;
        order: 3;
    }
    
    #top-actions {
        order: 2;
        margin-right: 10px;
    }
    
    .top-btn {
        padding: 4px 8px;
        font-size: 0.75em;
    }
    
    /* Sidebar devient overlay sur mobile */
    #sidebar {
        width: 100%;
        max-width: 320px;
        transform: translateX(-100%);
        z-index: 1100;
        box-shadow: 4px 0 20px rgba(0,0,0,0.3);
        border-radius: 0;
    }
    
    #sidebar.show {
        transform: translateX(0);
    }
    
    /* Overlay pour fermer la sidebar */
    #sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1050;
        display: none;
    }
    
    #sidebar-overlay.show {
        display: block;
    }
    
    /* Map prend toute la largeur sur mobile */
    #map {
        margin-left: 0;
    }
    
    /* Repositionnement des containers de rapport et facture */
    #delivery-report-container,
    #invoice-send-container {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 350px;
        max-height: 80vh;
        z-index: 1200;
    }
    
    /* Layer container adapt√© */
    #layer-container {
        top: 85px;
        right: 5px;
        padding: 5px;
    }
    
    .layer-preview {
        width: 35px;
        height: 35px;
        margin: 3px;
    }
    
    /* Instructions container */
    #instructions-container {
        bottom: 5px;
        right: 5px;
        left: 5px;
        max-width: none;
        font-size: 0.8em;
        padding: 10px;
    }
    
    #toggleInstructions {
        font-size: 0.75em;
    }
    
    #instructionsList {
        max-height: 150px;
    }
    
    /* Toggle layers button */
    #toggleLayersBtn {
        top: 85px;
        right: 50px;
        padding: 6px 8px;
        font-size: 0.75em;
    }
    
    /* Interface Admin responsive */
    #admin-header {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
    }
    
    #admin-header .title {
        justify-content: center;
        text-align: center;
    }
    
    #admin-actions {
        justify-content: center;
    }
    
    #admin-main {
        padding: 8px;
        gap: 8px;
    }
    
    #admin-panel {
        padding: 8px;
    }
    
    #reports-table {
        font-size: 0.75em;
    }
    
    #reports-table th,
    #reports-table td {
        padding: 4px 2px;
    }
    
    .status-badge {
        font-size: 0.65em;
        padding: 1px 4px;
    }
    
    .row-actions button {
        padding: 2px 4px;
        font-size: 0.65em;
        margin-right: 1px;
    }
    
    #admin-map {
        height: 300px;
    }
    
    /* Form groups responsive */
    .datetime-group {
        flex-direction: column;
        gap: 5px;
    }
    
    /* Login responsive */
    #login-container {
        padding: 20px;
        margin: 10px;
    }
    
    #login-container h2 {
        font-size: 1.5em;
    }
}

/* Tr√®s petits √©crans */
@media screen and (max-width: 480px) {
    #header h1 {
        font-size: 1em;
    }
    
    #header img {
        width: 30px;
        margin-right: 8px;
    }
    
    #sidebar {
        max-width: 280px;
        padding: 10px;
    }
    
    #sidebar h3 {
        font-size: 1em;
    }
    
    #sidebar button {
        padding: 8px;
        font-size: 0.85em;
    }
    
    #delivery-report-container,
    #invoice-send-container {
        width: 95%;
        padding: 15px;
        max-height: 85vh;
    }
    
    .layer-preview {
        width: 30px;
        height: 30px;
        margin: 2px;
    }
    
    #instructions-container {
        font-size: 0.75em;
        padding: 8px;
    }
    
    #reports-table {
        font-size: 0.7em;
    }
    
    .status-badge {
        font-size: 0.6em;
    }
    
    .row-actions button {
        font-size: 0.6em;
        padding: 1px 3px;
    }
}

/* Paysage mobile */
@media screen and (max-height: 500px) and (orientation: landscape) {
    #delivery-report-container,
    #invoice-send-container {
        max-height: 90vh;
        top: 5%;
        transform: translate(-50%, 0);
    }
    
    #instructions-container {
        max-height: 120px;
    }
    
    #instructionsList {
        max-height: 100px;
    }
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
<!-- Overlay sidebar pour mobile -->
<div id="sidebar-overlay"></div>

<!-- Page de connexion -->
<div id="login-overlay">
    <div id="login-container">
        <h2>Connexion au Syst√®me</h2>
        <input type="text" id="username" class="login-input" placeholder="Nom d'utilisateur" autocomplete="off">
        <input type="password" id="password" class="login-input" placeholder="Mot de passe" autocomplete="off">
        <button id="login-btn">Se connecter</button>
        <div id="login-error">Identifiants incorrects. Veuillez r√©essayer.</div>
        <!-- Astuce d'identifiants -->
        <div style="margin-top:10px;color:#ffffffcc;font-size:0.9em">
            <div><strong>Agent :</strong> IMPOTS / IMPOTS 229</div>
            <div><strong>Admin :</strong> ADMIN / ADMIN229</div>
        </div>
    </div>
</div>

<!-- Application principale (Agent) -->
<div id="app-container">
    <div id="header">
        <button id="menu-toggle">‚ò∞</button>
        <div class="header-content">
            <img src="https://upload.wikimedia.org/wikipedia/commons/0/0a/Flag_of_Benin.svg" alt="Drapeau B√©nin">
            <h1>Syst√®me de Distribution des Factures imp√¥ts</h1>
        </div>
        <div id="top-actions" style="display:none;">
            <button id="switch-to-admin" class="top-btn dark">Admin</button>
            <button id="logout-btn" class="top-btn danger">D√©connexion</button>
        </div>
    </div>
    
    <div id="sidebar">
        <div id="coordContainer">
            <h3>Recherche par coordonn√©es</h3>
            <input id="latInput" placeholder="Latitude / Est" type="text">
            <input id="lngInput" placeholder="Longitude / Nord" type="text">
            <select id="coordType">
                <option value="geo">G√©ographique (Lat/Lng)</option>
                <option value="utm">UTM / M√©trique</option>
            </select>
            <button id="coordBtnSidebar">üìç Aller</button>
        </div>
        <div id="searchControls">
            <h3>Rechercher une Structure</h3>
            <input type="text" id="searchStructureInput" placeholder="Nom de la structure">
            <button id="searchStructureBtn">üîç Rechercher</button>
            <button id="locateBtn">üìç Me localiser</button>
            <button id="toggleVoice">üîä Voix ON/OFF</button>
        </div>
        <div id="companySection">
            <button id="toggleCompanies">üìÇ Afficher/Cacher entreprises</button>
            <ul id="companyList"></ul>
        </div>
        <div id="routeControls">
            <h3>Navigation</h3>
            <button id="pauseRoute">‚è∏ Pause</button>
            <button id="resumeRoute">‚ñ∂Ô∏è Reprendre</button>
            <button id="stopRoute">üõë Arr√™ter</button>
            <button id="toggle-delivery-report">üìã Rapport Livraison</button>
            <button id="toggle-invoice-send">‚úâÔ∏è Envoi Facture</button>
        </div>
    </div>
    
    <!-- Container pour le rapport de livraison -->
    <div id="delivery-report-container">
        <h3>üìã Rapport de Livraison</h3>
        
        <div id="success-message" class="success-message"></div>
        <div id="error-message" class="error-message"></div>
        
        <div class="delivery-option">
            <label class="delivered">
                <input type="radio" name="delivery-status" value="delivered" id="delivered-radio">
                ‚úÖ Facture Livr√©e
            </label>
        </div>
        
        <div class="delivery-option">
            <label class="not-delivered">
                <input type="radio" name="delivery-status" value="not-delivered" id="not-delivered-radio">
                ‚ùå Facture Non Livr√©e
            </label>
        </div>
        
        <div id="reason-container">
            <label for="reason-text">Raison de la non-livraison :</label>
            <textarea id="reason-text" placeholder="Veuillez pr√©ciser la raison..."></textarea>
        </div>
        
        <div class="form-group">
            <label for="agent-name">Nom et Pr√©noms de l'Agent :</label>
            <input type="text" id="agent-name" placeholder="Nom complet de l'agent">
        </div>
        
        <div class="form-group">
            <label for="agent-contact">Contact :</label>
            <input type="tel" id="agent-contact" placeholder="Num√©ro de t√©l√©phone">
        </div>
        
        <div class="datetime-group">
            <div class="form-group">
                <label for="delivery-date">Date de livraison :</label>
                <input type="date" id="delivery-date">
            </div>
            
            <div class="form-group">
                <label for="delivery-time">Heure de livraison :</label>
                <input type="time" id="delivery-time">
            </div>
        </div>
        
        <div class="form-group">
            <label for="structure-name" style="display:none;">Structure ayant re√ßu la facture :</label>
            <input type="text" id="structure-name" placeholder="Nom de la structure" style="display:none;">
        </div>
        
        <button id="submit-report">üì§ Envoyer le Rapport</button>
    </div>

    <!-- Container pour l'envoi de facture -->
    <div id="invoice-send-container">
      <h3>‚úâÔ∏è Envoi de Facture</h3>

      <div id="invoice-success-msg"></div>
      <div id="invoice-error-msg"></div>

      <form id="invoice-form" method="POST" enctype="multipart/form-data">
        <div class="form-group">
          <label for="invoice-file">Fichier facture (PDF/JPG/PNG) :</label>
          <input type="file" id="invoice-file" name="attachment" accept=".pdf,.jpg,.jpeg,.png" required>
          <div class="small-muted">Taille max recommand√©e: 7 Mo</div>
        </div>

        <div class="form-group">
          <label for="invoice-to">Adresse e‚Äëmail destinataire :</label>
          <input type="email" id="invoice-to" name="to_email" placeholder="ex: facturation@structure.bj" required>
        </div>

        <div class="form-group">
          <label for="invoice-ref">R√©f√©rence (n¬∞ de mail ou n¬∞ de facture) :</label>
          <input type="text" id="invoice-ref" name="invoice_ref" placeholder="Ex: FAC-2025-001 (optionnel)">
        </div>

        <div class="form-group">
          <label for="invoice-message">Message (optionnel) :</label>
          <textarea id="invoice-message" name="message" placeholder="Message d'accompagnement..."></textarea>
        </div>

        <input type="hidden" name="from_name" id="invoice-from-name" value="">
        <input type="hidden" name="agent_contact" id="invoice-from-contact" value="">
        <input type="hidden" name="subject" id="invoice-subject" value="">
        <input type="hidden" name="company_name" id="invoice-company-name" value="">
      </form>

      <button id="send-invoice">üöÄ Envoyer la facture</button>
      <div class="small-muted accepted-types">Formats accept√©s: .pdf, .jpg, .jpeg, .png</div>
      <div class="small-muted">Astuce: le nom et le contact de l'agent (du Rapport de Livraison) sont repris comme exp√©diteur.</div>
    </div>
    
    <div id="layer-container"></div>
    <div id="map"></div>
    <div id="toggleLayersBtn">Fonds</div>
    <div id="instructions-container">
        <button id="toggleInstructions">Instructions</button>
        <ul id="instructionsList" style="display:none;"></ul>
    </div>
</div>

<!-- Interface Administrateur -->
<div id="admin-container">
    <div id="admin-header">
        <div class="title">
            <img src="https://upload.wikimedia.org/wikipedia/commons/0/0a/Flag_of_Benin.svg" alt="BJ">
            <strong>Interface Administrateur ‚Äî Suivi des Rapports</strong>
        </div>
        <div id="admin-actions">
            <button id="switch-to-agent" class="admin-btn secondary">Mode Agent</button>
            <button id="export-csv" class="admin-btn">Exporter CSV</button>
            <button id="logout-btn-admin" class="admin-btn danger">D√©connexion</button>
        </div>
    </div>
    <div id="admin-main">
        <div id="admin-map"></div>
        <div id="admin-panel">
            <h2>üìë Rapports re√ßus</h2>
            <input id="admin-search" placeholder="Rechercher (agent, statut, raison, contact, date, heure)...">
            <div style="max-height: calc(100vh - 300px); overflow:auto; border:1px solid #eee; border-radius:8px;">
                <table id="reports-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Statut</th>
                            <th>Agent</th>
                            <th>Contact</th>
                            <th>Date</th>
                            <th>Heure</th>
                            <th>Raison</th>
                            <th>Structure</th>
                            <th>Position</th>
                            <th>Cr√©√© le</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reports-tbody">
                        <!-- Lignes inject√©es JS -->
                    </tbody>
                </table>
            </div>
            <div id="empty-state" style="display:none;">Aucun rapport pour le moment.</div>
        </div>
    </div>
</div>

<!-- Modal √©dition administrateur -->
<div id="edit-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:12000; padding:20px;">
  <div style="background:#fff; padding:16px; border-radius:8px; width:100%; max-width:420px; box-shadow:0 6px 18px rgba(0,0,0,0.2); max-height:90vh; overflow-y:auto;">
    <h3 style="margin-top:0;">‚úèÔ∏è Modifier le rapport</h3>
    <div style="display:flex;flex-direction:column;gap:8px;">
      <input id="edit-id" type="hidden" />
      <label>Statut:
        <select id="edit-status" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;"><option value="delivered">Livr√©e</option><option value="not-delivered">Non livr√©e</option></select>
      </label>
      <label>Agent: <input id="edit-agentName" type="text" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" /></label>
      <label>Contact: <input id="edit-agentContact" type="text" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" /></label>
      <label>Structure: <input id="edit-structure" type="text" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" /></label>
      <label>Date: <input id="edit-deliveryDate" type="date" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" /></label>
      <label>Heure: <input id="edit-deliveryTime" type="time" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" /></label>
      <label>Raison: <textarea id="edit-reason" style="min-height:60px;width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;"></textarea></label>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
        <button onclick="closeEditModal()" style="background:#6c757d;color:#fff;padding:8px 16px;border-radius:6px;border:none;cursor:pointer;">Annuler</button>
        <button onclick="saveEdit()" style="background:#007bff;color:#fff;padding:8px 16px;border-radius:6px;border:none;cursor:pointer;">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
<script>
// ====================== AUTH / MODE ======================
let currentUserRole = null;
const LS_KEY = 'deliveryReports_v1';

function saveReportsToLS(reports) {
    try { localStorage.setItem(LS_KEY, JSON.stringify(reports || [])); } catch(e){ console.warn(e); }
}
function loadReportsFromLS() {
    try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch(e){ return []; }
}

// ====================== MENU MOBILE ======================
function initMobileMenu() {
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    
    menuToggle.addEventListener('click', function() {
        sidebar.classList.toggle('show');
        sidebarOverlay.classList.toggle('show');
    });
    
    sidebarOverlay.addEventListener('click', function() {
        sidebar.classList.remove('show');
        sidebarOverlay.classList.remove('show');
    });
    
    // Fermer la sidebar quand on clique sur un √©l√©ment de navigation
    sidebar.addEventListener('click', function(e) {
        if (e.target.tagName === 'BUTTON' || e.target.tagName === 'LI') {
            if (window.innerWidth <= 768) {
                setTimeout(() => {
                    sidebar.classList.remove('show');
                    sidebarOverlay.classList.remove('show');
                }, 300);
            }
        }
    });
}

// ====================== GESTION DE LA CONNEXION ======================
document.addEventListener('DOMContentLoaded', function() {
    const loginOverlay = document.getElementById('login-overlay');
    const appContainer = document.getElementById('app-container');
    const adminContainer = document.getElementById('admin-container');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('login-btn');
    const loginError = document.getElementById('login-error');
    
    function checkCredentials(username, password) {
        const u = (username || '').trim().toUpperCase();
        const p = (password || '').trim();
        if (u === 'IMPOTS' && p === 'IMPOTS 229') return 'agent';
        if (u === 'ADMIN'  && p === 'ADMIN229')   return 'admin';
        return null;
    }
    
    loginBtn.addEventListener('click', function() {
        const username = usernameInput.value;
        const password = passwordInput.value;
        const role = checkCredentials(username, password);
        
        if (role) {
            currentUserRole = role;
            loginOverlay.style.display = 'none';

            if (role === 'admin') {
                adminContainer.style.display = 'block';
                appContainer.style.display = 'none';
                initializeAdmin();
            } else {
                appContainer.style.display = 'block';
                adminContainer.style.display = 'none';
                document.getElementById('top-actions').style.display = 'none';
                initializeApp();
                initMobileMenu();
            }
        } else {
            loginError.style.display = 'block';
            usernameInput.value = '';
            passwordInput.value = '';
            setTimeout(() => {
                loginError.style.display = 'none';
            }, 3000);
        }
    });
    
    passwordInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            loginBtn.click();
        }
    });
});

function setupTopActionsForRole() {
    const topActions = document.getElementById('top-actions');
    const switchToAdminBtn = document.getElementById('switch-to-admin');
    const logoutBtn = document.getElementById('logout-btn');
    const appContainer = document.getElementById('app-container');
    const adminContainer = document.getElementById('admin-container');

    if (currentUserRole === 'admin') {
        topActions.style.display = 'flex';
        switchToAdminBtn.onclick = () => {
            appContainer.style.display = 'none';
            adminContainer.style.display = 'block';
            initializeAdmin();
        };
    } else {
        topActions.style.display = 'none';
    }

    logoutBtn.onclick = globalLogout;
    const logoutBtnAdmin = document.getElementById('logout-btn-admin');
    if (logoutBtnAdmin) logoutBtnAdmin.onclick = globalLogout;

    const switchToAgent = document.getElementById('switch-to-agent');
    if (switchToAgent) {
        switchToAgent.onclick = () => {
            adminContainer.style.display = 'none';
            appContainer.style.display = 'block';
            initializeApp();
            initMobileMenu();
            setupTopActionsForRole();
        };
    }
}

function globalLogout() {
    currentUserRole = null;
    document.getElementById('app-container').style.display = 'none';
    document.getElementById('admin-container').style.display = 'none';
    document.getElementById('login-overlay').style.display = 'flex';
}

// ====================== CODE APPLICATION AGENT ======================
function initializeApp() {
var speech = window.speechSynthesis;
var voiceEnabled = true;
var lastSpokenInstructionTimestamp = 0;
const MIN_SPEAK_INTERVAL = 5000;

var map = L.map('map').setView([9.3077,2.3158],7);
var allCompanies = [];
var selectedCompany = null;
var routingControl=null, movingMarkerStart=null, movingMarkerEnd=null, movingCursor=null, routeLine=null;
var routeCoords=[], routeInstructions=[], currentStep=0, routeInterval=null, isPaused=false;
var userMarker=null;
var gpsWatchId = null;
var currentInstructionIndex = 0;
var lastSpokenInstruction = -1;
var voiceGuidanceInterval = null;

var infrastructures = [
  { nom: "√âcole Primaire Z", lat: 9.3100, lng: 2.3200, alerteFait: false },
  { nom: "Pont principal", lat: 9.3150, lng: 2.3250, alerteFait: false },
  { nom: "Rond-point central", lat: 9.3125, lng: 2.3180, alerteFait: false },
  { nom: "H√¥pital G√©n√©ral", lat: 9.3170, lng: 2.3100, alerteFait: false }
];
var infraAlertDistance = 25;

var greenIcon = new L.Icon({ iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png', iconSize:[32,32], iconAnchor:[16,32] });
var redIcon = new L.Icon({ iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png', iconSize:[32,32], iconAnchor:[16,32] });
var googleCursorIcon = new L.Icon({ iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png', iconSize:[32,32], iconAnchor:[16,32] });

var baseLayers = {
"OSM": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:25, maxNativeZoom: 19, attribution:'', errorTileUrl:''}).addTo(map),
"Google Satellite": L.tileLayer('https://mt.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{maxZoom:25, maxNativeZoom: 19, attribution:'', errorTileUrl:''}),
"Google Earth": L.tileLayer('https://mt.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{maxZoom:25, maxNativeZoom: 19, attribution:'', errorTileUrl:''}),
"Google Terrain": L.tileLayer('https://mt.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{maxZoom:25, maxNativeZoom: 19, attribution:'', errorTileUrl:''})
};

var layerThumbs = {
"OSM":"https://tile.openstreetmap.org/5/15/10.png",
"Google Satellite":"https://mt.google.com/vt/lyrs=s&x=10&y=10&z=5",
"Google Earth":"https://mt.google.com/vt/lyrs=y&x=10&y=10&z=5",
"Google Terrain":"https://mt.google.com/vt/lyrs=p&x=10&y=10&z=5"
};

var layerContainer=document.getElementById('layer-container');
layerContainer.innerHTML = '';
Object.keys(baseLayers).forEach((key,idx)=>{
    var div=document.createElement('div');
    div.className="layer-preview"+(idx===0?" active":"");
    div.style.backgroundImage=`url('${layerThumbs[key]}')`;
    div.title=key;
    div.onclick=()=>{
        map.eachLayer(l=>{ if(l instanceof L.TileLayer) map.removeLayer(l); });
        baseLayers[key].addTo(map);
        document.querySelectorAll('.layer-preview').forEach(p=>p.classList.remove('active'));
        div.classList.add('active');
    };
    layerContainer.appendChild(div);
});

var layerContainerVisible = true;
document.getElementById('toggleLayersBtn').onclick = () => {
    layerContainerVisible = !layerContainerVisible;
    layerContainer.style.display = layerContainerVisible ? 'flex' : 'none';
};

function speak(text){
    if(!voiceEnabled) return;
    if (speech.speaking) { return; }
    const now = Date.now();
    if (now - lastSpokenInstructionTimestamp < MIN_SPEAK_INTERVAL) { return; }
    var u = new SpeechSynthesisUtterance(text);
    u.lang = 'fr-FR';
    u.onend = () => { lastSpokenInstructionTimestamp = now; };
    u.onerror = (event) => { console.error('SpeechSynthesisUtterance.onerror', event); };
    speech.speak(u);
}
document.getElementById('toggleVoice').onclick=()=>{ voiceEnabled=!voiceEnabled; alert('Voix '+(voiceEnabled?'activ√©e':'d√©sactiv√©e')); };

document.getElementById('locateBtn').onclick=()=>{ map.locate({setView:true,maxZoom:25}); };
map.on('locationfound', e => {
    if(userMarker) map.removeLayer(userMarker);
    userMarker = L.marker(e.latlng,{icon:redIcon}).addTo(map);
    map.setView(e.latlng,25,{animate:true});
});
map.on('locationerror',()=>{ alert("Impossible de vous localiser."); });

fetch('/api/entreprises')
  .then(r => r.json())
  .then(data => {
    allCompanies = data;
    var list = document.getElementById('companyList');
    list.innerHTML = ''; 
    data.forEach(e => {
      if (e.Latitude && e.Longitude) {
        var li = document.createElement('li');
        li.textContent = e.Nom_Entreprise;
        li.title = e.Adresse_Complete;
        li.onclick = () => { 
            selectedCompany = e; 
            startRoute(parseFloat(e.Latitude), parseFloat(e.Longitude), e.Nom_Entreprise); 
        };
        list.appendChild(li);
      }
    });
  });
document.getElementById('toggleCompanies').onclick = () => {
    var list = document.getElementById('companyList');
    list.style.display = (window.getComputedStyle(list).display === "none") ? "block" : "none";
};

document.getElementById('searchStructureBtn').onclick = () => {
    const query = document.getElementById('searchStructureInput').value.trim().toLowerCase();
    if (!query) { alert("Veuillez saisir le nom d'une structure."); return; }
    const match = allCompanies.find(e => e.Nom_Entreprise.toLowerCase().includes(query));
    if (!match || !match.Latitude || !match.Longitude) { alert("Structure introuvable ou coordonn√©es manquantes."); return; }
    selectedCompany = match;
    startRoute(parseFloat(match.Latitude), parseFloat(match.Longitude), match.Nom_Entreprise);
};

document.getElementById('coordBtnSidebar').onclick = () => {
    const lat = parseFloat(document.getElementById('latInput').value);
    const lng = parseFloat(document.getElementById('lngInput').value);
    const coordType = document.getElementById('coordType').value;
    if (isNaN(lat) || isNaN(lng)) {
        alert("Veuillez entrer des coordonn√©es valides !");
        return;
    }
    let destLat = lat, destLng = lng;
    if (coordType === "utm") {
        try {
            const utmProj = "+proj=utm +zone=31 +datum=WGS84 +units=m +no_defs";
            const geoProj = "+proj=longlat +datum=WGS84 +no_defs";
            const res = proj4(utmProj, geoProj, [lng, lat]);
            destLng = res[0];
            destLat = res[1];
        } catch(e){ alert("Erreur de conversion UTM: " + e); return; }
    }
    selectedCompany = null;
    startRouteWithoutVoice(destLat, destLng, `Destination (${destLat.toFixed(5)}, ${destLng.toFixed(5)})`);
};

function clearRoute(){
    clearInterval(routeInterval);
    if (voiceGuidanceInterval) clearInterval(voiceGuidanceInterval);
    if (gpsWatchId) {
        navigator.geolocation.clearWatch(gpsWatchId);
        gpsWatchId = null;
    }
    speech.cancel();

    routeInterval=null;
    voiceGuidanceInterval = null;
    isPaused=false;

    if(movingMarkerStart) map.removeLayer(movingMarkerStart);
    if(movingMarkerEnd) map.removeLayer(movingMarkerEnd);
    if(movingCursor) map.removeLayer(movingCursor);
    if(routeLine) map.removeLayer(routeLine);
    if(routingControl) map.removeControl(routingControl);

    routeCoords=[];
    routeInstructions=[];
    currentStep=0;
    currentInstructionIndex = 0;
    lastSpokenInstruction = -1;
    lastSpokenInstructionTimestamp = 0;

    document.getElementById('instructionsList').innerHTML='';
}

function distance(latlng1,latlng2){
    const R=6371000;
    const toRad=d=>d*Math.PI/180;
    const dLat=toRad(latlng2[0]-latlng1[0]);
    const dLon=toRad(latlng2[1]-latlng1[1]);
    const lat1=toRad(latlng1[0]); const lat2=toRad(latlng2[0]);
    const a=Math.sin(dLat/2)**2 + Math.sin(dLon/2)**2 * Math.cos(lat1)*Math.cos(lat2);
    return 2*R*Math.atan2(Math.sqrt(a),Math.atan2(Math.sqrt(1-a),1));
}

function resumeRouteAnimation(){
    if(!routeCoords || routeCoords.length===0) return;
    routeInterval=setInterval(()=>{
        if(!isPaused) {
            if(currentStep<routeCoords.length-1){
                currentStep++;
                movingCursor.setLatLng(routeCoords[currentStep]);
                map.panTo(routeCoords[currentStep], {animate:true, duration:0.5, easeLinearity:0.5});
            }else{
                if(voiceEnabled) speak("Vous √™tes arriv√© √† destination.");
                clearInterval(routeInterval);
            }
        }
    },200);
}

function startVoiceGuidance(){
    if(!routeInstructions || routeInstructions.length===0) return;
    if (gpsWatchId) navigator.geolocation.clearWatch(gpsWatchId);
    
    gpsWatchId = navigator.geolocation.watchPosition(pos => {
        const userPos = [pos.coords.latitude, pos.coords.longitude];
        
        if (movingCursor) {
            movingCursor.setLatLng(userPos);
            map.panTo(userPos, {animate:true, duration:0.5, easeLinearity:0.5});
        }
        
        if (currentInstructionIndex < routeInstructions.length) {
            const instruction = routeInstructions[currentInstructionIndex];
            const instructionLatLng = routeCoords[instruction.index]; 
            const distToInstruction = distance(userPos, [instructionLatLng.lat, instructionLatLng.lng]);

            if (distToInstruction < 30 && currentInstructionIndex !== lastSpokenInstruction) {
                if (voiceEnabled) speak(instruction.text);
                lastSpokenInstruction = currentInstructionIndex;
                var instrList=document.getElementById('instructionsList');
                instrList.querySelectorAll('li').forEach(li=>li.classList.remove('current'));
                if(instrList.children[currentInstructionIndex]) instrList.children[currentInstructionIndex].classList.add('current');
                instrList.children[currentInstructionIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            if (distToInstruction > 50 && currentInstructionIndex === lastSpokenInstruction) { 
                 currentInstructionIndex++; 
                 lastSpokenInstruction = -1;
            }
        }

        infrastructures.forEach(infra => {
            const distInfra = distance(userPos, [infra.lat, infra.lng]);
            if(distInfra < infraAlertDistance && !infra.alerteFait) {
                if (voiceEnabled) speak(`Attention, ${infra.nom} √† proximit√©.`); 
                infra.alerteFait = true;
            } else if (distInfra > infraAlertDistance * 2 && infra.alerteFait) {
                infra.alerteFait = false;
            }
        });

    }, (error) => {
        console.error("Erreur de g√©olocalisation pour le guidage vocal :", error);
    }, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 5000
    });
}

function startRoute(lat,lng,name){
    clearRoute();
    if(voiceEnabled) speak(`Itin√©raire vers ${name} en cours`);
    infrastructures.forEach(i => i.alerteFait = false);

    navigator.geolocation.getCurrentPosition(pos=>{
        var start=[pos.coords.latitude,pos.coords.longitude];
        var end=[lat,lng];
        routingControl=L.Routing.control({
            waypoints:[L.latLng(start),L.latLng(end)],
            language:'fr',
            createMarker:()=>null,
            addWaypoints:false,
            routeWhileDragging:false,
            show:false,
            lineOptions:{styles:[{color:'blue',weight:5}]}
        }).addTo(map);

        routingControl.on('routesfound',e=>{
            var route=e.routes[0];
            routeCoords=route.coordinates;
            routeInstructions=route.instructions; 
            
            routeLine=L.polyline(routeCoords,{color:'blue',weight:5}).addTo(map);
            movingMarkerStart=L.marker(routeCoords[0],{icon:greenIcon}).addTo(map);
            movingMarkerEnd=L.marker(routeCoords[routeCoords.length-1],{icon:redIcon}).addTo(map);
            movingCursor=L.marker(routeCoords[0],{icon:googleCursorIcon}).addTo(map);
            map.fitBounds(routeLine.getBounds(),{padding:[50,50]});

            var instrList=document.getElementById('instructionsList');
            instrList.innerHTML = ''; 
            routeInstructions.forEach((instr,idx)=>{
                var li=document.createElement('li');
                li.innerHTML=`<strong>${idx+1}.</strong> ${instr.text}`;
                instrList.appendChild(li);
            });

            currentStep=0;
            currentInstructionIndex = 0;
            lastSpokenInstruction = -1;
            lastSpokenInstructionTimestamp = 0;
            resumeRouteAnimation();
            startVoiceGuidance();
        });
    },()=>{ alert("Position introuvable"); });
}

function startRouteWithoutVoice(lat,lng,name){
    clearRoute();
    infrastructures.forEach(i => i.alerteFait = false);

    navigator.geolocation.getCurrentPosition(pos=>{
        var start=[pos.coords.latitude,pos.coords.longitude];
        var end=[lat,lng];
        routingControl=L.Routing.control({
            waypoints:[L.latLng(start),L.latLng(end)],
            language:'fr',
            createMarker:()=>null,
            addWaypoints:false,
            routeWhileDragging:false,
            show:false,
            lineOptions:{styles:[{color:'blue',weight:5}]}
        }).addTo(map);

        routingControl.on('routesfound',e=>{
            var route=e.routes[0];
            routeCoords=route.coordinates;
            routeInstructions=route.instructions; 
            
            routeLine=L.polyline(routeCoords,{color:'blue',weight:5}).addTo(map);
            movingMarkerStart=L.marker(routeCoords[0],{icon:greenIcon}).addTo(map);
            movingMarkerEnd=L.marker(routeCoords[routeCoords.length-1],{icon:redIcon}).addTo(map);
            movingCursor=L.marker(routeCoords[0],{icon:googleCursorIcon}).addTo(map);
            map.fitBounds(routeLine.getBounds(),{padding:[50,50]});

            var instrList=document.getElementById('instructionsList');
            instrList.innerHTML = ''; 
            routeInstructions.forEach((instr,idx)=>{
                var li=document.createElement('li');
                li.innerHTML=`<strong>${idx+1}.</strong> ${instr.text}`;
                instrList.appendChild(li);
            });

            currentStep=0;
            currentInstructionIndex = 0;
            lastSpokenInstruction = -1;
            lastSpokenInstructionTimestamp = 0;
            resumeRouteAnimation();
        });
    },()=>{ alert("Position introuvable"); });
}

document.getElementById("pauseRoute").onclick=()=>{
    if(routeInterval && !isPaused){
        clearInterval(routeInterval);
        if (gpsWatchId) navigator.geolocation.clearWatch(gpsWatchId);
        isPaused=true;
        speech.cancel();
        if(voiceEnabled) speak("Navigation en pause");
    }
};
document.getElementById("resumeRoute").onclick=()=>{
    if(isPaused){
        isPaused=false;
        if(voiceEnabled) speak("Reprise navigation");
        resumeRouteAnimation();
        startVoiceGuidance(); 
    }
};
document.getElementById("stopRoute").onclick=()=>{ 
    if(voiceEnabled) speak("Itin√©raire arr√™t√©"); 
    clearRoute(); 
};

// Rapport de livraison
var deliveryReportVisible = false;
var deliveryReports = loadReportsFromLS();

function initializeDateTime() {
    const now = new Date();
    const today = now.toISOString().split('T')[0];
    const currentTime = now.toTimeString().slice(0, 5);
    document.getElementById('delivery-date').value = today;
    document.getElementById('delivery-time').value = currentTime;
}

document.getElementById('toggle-delivery-report').onclick = () => {
    deliveryReportVisible = !deliveryReportVisible;
    const container = document.getElementById('delivery-report-container');
    container.style.display = deliveryReportVisible ? 'block' : 'none';
    if (deliveryReportVisible) { 
        initializeDateTime(); 
        const inv = document.getElementById('invoice-send-container');
        if (inv) inv.style.display = 'none';
    }
};

document.getElementById('delivered-radio').onchange = function() {
    if (this.checked) {
        document.getElementById('reason-container').style.display = 'none';
        document.getElementById('reason-text').value = '';
    }
};
document.getElementById('not-delivered-radio').onchange = function() {
    if (this.checked) {
        document.getElementById('reason-container').style.display = 'block';
    }
};

function showMessage(type, message) {
    const successMsg = document.getElementById('success-message');
    const errorMsg = document.getElementById('error-message');
    successMsg.style.display = 'none';
    errorMsg.style.display = 'none';
    if (type === 'success') {
        successMsg.textContent = message;
        successMsg.style.display = 'block';
        setTimeout(() => { successMsg.style.display = 'none'; }, 5000);
    } else if (type === 'error') {
        errorMsg.textContent = message;
        errorMsg.style.display = 'block';
        setTimeout(() => { errorMsg.style.display = 'none'; }, 5000);
    }
}

function validateForm() {
    const deliveryStatus = document.querySelector('input[name="delivery-status"]:checked');
    const agentName = document.getElementById('agent-name').value.trim();
    const agentContact = document.getElementById('agent-contact').value.trim();
    const deliveryDate = document.getElementById('delivery-date').value;
    const deliveryTime = document.getElementById('delivery-time').value;
    const reasonText = document.getElementById('reason-text').value.trim();
    
    if (!deliveryStatus) { showMessage('error', 'Veuillez s√©lectionner le statut de livraison.'); return false; }
    if (!agentName)     { showMessage('error', 'Veuillez saisir le nom et pr√©noms de l\'agent.'); return false; }
    if (!agentContact)  { showMessage('error', 'Veuillez saisir le contact de l\'agent.'); return false; }
    if (!deliveryDate)  { showMessage('error', 'Veuillez saisir la date de livraison.'); return false; }
    if (!deliveryTime)  { showMessage('error', 'Veuillez saisir l\'heure de livraison.'); return false; }
    if (deliveryStatus.value === 'not-delivered' && !reasonText) {
        showMessage('error', 'Veuillez pr√©ciser la raison de la non-livraison.'); return false;
    }
    return true;
}

function resetForm() {
    document.querySelectorAll('input[name="delivery-status"]').forEach(radio => radio.checked = false);
    document.getElementById('reason-container').style.display = 'none';
    document.getElementById('reason-text').value = '';
    document.getElementById('agent-name').value = '';
    document.getElementById('agent-contact').value = '';
    initializeDateTime();
    document.getElementById('success-message').style.display = 'none';
    document.getElementById('error-message').style.display = 'none';
}

document.getElementById('submit-report').onclick = () => {
    if (!validateForm()) { return; }
    const deliveryStatus = document.querySelector('input[name="delivery-status"]:checked').value;
    const agentName = document.getElementById('agent-name').value.trim();
    const agentContact = document.getElementById('agent-contact').value.trim();
    const deliveryDate = document.getElementById('delivery-date').value;
    const deliveryTime = document.getElementById('delivery-time').value;
    const reasonText = document.getElementById('reason-text').value.trim();
    
    const report = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        status: deliveryStatus,
        reason: deliveryStatus === 'not-delivered' ? reasonText : '',
        agentName: agentName,
        agentContact: agentContact,
        deliveryDate: deliveryDate,
        deliveryTime: deliveryTime,
        structure: document.getElementById('structure-name') ? document.getElementById('structure-name').value.trim() : '',
        location: userMarker ? {
            lat: userMarker.getLatLng().lat,
            lng: userMarker.getLatLng().lng
        } : null
    };
    
    deliveryReports.push(report);
    saveReportsToLS(deliveryReports);
    console.log('Rapport de livraison:', report);
    
    const statusText = deliveryStatus === 'delivered' ? 'livr√©e' : 'non livr√©e';
    showMessage('success', `Rapport de facture ${statusText} envoy√© avec succ√®s !`);

    setTimeout(() => { resetForm(); }, 2000);
};

initializeDateTime();

// Envoi de facture
let invoicePanelVisible = false;
document.getElementById('toggle-invoice-send').onclick = () => {
  invoicePanelVisible = !invoicePanelVisible;
  const invCtn = document.getElementById('invoice-send-container');
  invCtn.style.display = invoicePanelVisible ? 'block' : 'none';
  if (invoicePanelVisible) {
    const repCtn = document.getElementById('delivery-report-container');
    if (repCtn) repCtn.style.display = 'none';
  }
};

document.getElementById('send-invoice').onclick = async (e) => {
  e.preventDefault();
  const form = document.getElementById('invoice-form');
  const sendBtn = document.getElementById('send-invoice');
  const successMsg = document.getElementById('invoice-success-msg');
  const errorMsg = document.getElementById('invoice-error-msg');

  successMsg.style.display = "none";
  errorMsg.style.display = "none";

  const fileInput = document.getElementById('invoice-file');
  const toInput   = document.getElementById('invoice-to');

  if (!fileInput.files.length) {
    errorMsg.textContent = "‚ùå Veuillez choisir un fichier facture.";
    errorMsg.style.display = "block";
    return;
  }
  if (!toInput.value) {
    errorMsg.textContent = "‚ùå Adresse e-mail destinataire requise.";
    errorMsg.style.display = "block";
    return;
  }

  const formData = new FormData(form);

  sendBtn.disabled = true;
  sendBtn.textContent = '‚è≥ Envoi...';

  try {
           const response = await fetch("https://projet-final-ylci.onrender.com/sendmail", {   // ‚úÖ nouveau
      method: "POST",
      body: formData
    });



    const result = await response.text();
    if (result.includes("SUCCESS")) {
      successMsg.textContent = "‚úÖ Facture envoy√©e avec succ√®s !";
      successMsg.style.display = "block";
      form.reset();
    } else {
      errorMsg.textContent = "‚ùå Erreur lors de l'envoi (" + result + ")";
      errorMsg.style.display = "block";
    }
  } catch (err) {
    errorMsg.textContent = "‚ùå Erreur r√©seau : " + err;
    errorMsg.style.display = "block";
  } finally {
    sendBtn.disabled = false;
    sendBtn.textContent = 'üöÄ Envoyer la facture';
  }
};

document.getElementById('toggleInstructions').onclick=()=>{ 
    var container=document.getElementById('instructions-container');
    container.classList.toggle('show');
    var l=document.getElementById('instructionsList');
    l.style.display=(l.style.display==="none")?"block":"none";
};

document.getElementById('delivered-radio').addEventListener('change', function(){
  document.getElementById('structure-name').style.display = 'block';
  document.querySelector('label[for="structure-name"]').style.display = 'block';
});
document.getElementById('not-delivered-radio').addEventListener('change', function(){
  document.getElementById('structure-name').style.display = 'none';
  document.querySelector('label[for="structure-name"]').style.display = 'none';
});

setupTopActionsForRole();
}

// ====================== INTERFACE ADMIN ======================
let adminMap = null;
let adminMarkersLayer = null;

function initializeAdmin() {
    setupTopActionsForRole();

    if (!adminMap) {
        adminMap = L.map('admin-map').setView([9.3077,2.3158],7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:25, maxNativeZoom: 19}).addTo(adminMap);
        adminMarkersLayer = L.layerGroup().addTo(adminMap);
    } else {
        adminMarkersLayer.clearLayers();
        adminMap.invalidateSize();
    }

    const reports = loadReportsFromLS();
    renderAdminTable(reports);
    plotAdminMarkers(reports);

    const searchInput = document.getElementById('admin-search');
    searchInput.oninput = () => {
        const q = (searchInput.value || '').toLowerCase();
        const filtered = reports.filter(r => {
            const fields = [
                r.status,
                r.agentName,
                r.agentContact,
                r.reason,
                r.deliveryDate,
                r.deliveryTime,
                r.timestamp
            ].map(x => (x || '').toString().toLowerCase()).join(' ');
            return fields.includes(q);
        });
        renderAdminTable(filtered);
        plotAdminMarkers(filtered);
    };

    document.getElementById('export-csv').onclick = () => exportReportsCSV(loadReportsFromLS());
}

function renderAdminTable(reports) {
    const tbody = document.getElementById('reports-tbody');
    const empty = document.getElementById('empty-state');
    tbody.innerHTML = '';
    if (!reports || reports.length === 0) {
        empty.style.display = 'block';
        return;
    }
    empty.style.display = 'none';

    reports
      .sort((a,b)=> (b.id||0)-(a.id||0))
      .forEach((r,idx)=>{
        const tr = document.createElement('tr');
        const badge = r.status === 'delivered' ? '<span class="status-badge status-ok">Livr√©e</span>' : '<span class="status-badge status-ko">Non livr√©e</span>';
        const posTxt = r.location ? `${r.location.lat.toFixed(5)}, ${r.location.lng.toFixed(5)}` : '‚Äî';
        const created = new Date(r.timestamp).toLocaleString();

        tr.innerHTML = `
            <td>${idx+1}</td>
            <td>${badge}</td>
            <td>${escapeHtml(r.agentName||'')}</td>
            <td>${escapeHtml(r.agentContact||'')}</td>
            <td>${escapeHtml(r.deliveryDate||'')}</td>
            <td>${escapeHtml(r.deliveryTime||'')}</td>
            <td style="max-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${escapeHtml(r.reason||'')}">${escapeHtml(r.reason||'')}</td>
            <td style="max-width:100px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${escapeHtml(r.structure||'')}">${escapeHtml(r.structure||'')}</td>
            <td>${posTxt}</td>
            <td style="font-size:0.7em;">${created}</td>
            <td class="row-actions">
                <button class="focus">Voir</button>
                <button class="edit">Modif</button>
                <button class="delete">Suppr</button>
            </td>
        `;
        const focusBtn = tr.querySelector('.focus');
        const editBtn = tr.querySelector('.edit');
        const delBtn = tr.querySelector('.delete');
        focusBtn.onclick = () => focusOnReport(r);
        if (editBtn) editBtn.onclick = () => openEditModal(r);
        delBtn.onclick = () => deleteReport(r.id);

        tbody.appendChild(tr);
      });
}

function plotAdminMarkers(reports) {
    adminMarkersLayer.clearLayers();
    const markers = [];
    (reports||[]).forEach(r=>{
        if (r.location && typeof r.location.lat === 'number' && typeof r.location.lng === 'number') {
            const icon = new L.Icon({
                iconUrl: r.status === 'delivered'
                  ? 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png'
                  : 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',
                iconSize:[32,32], iconAnchor:[16,32]
            });
            const m = L.marker([r.location.lat, r.location.lng], {icon})
                .bindPopup(`<strong>${escapeHtml(r.agentName||'')}</strong><br/>
                            Statut: ${r.status==='delivered'?'Livr√©e':'Non livr√©e'}<br/>
                            Date: ${escapeHtml(r.deliveryDate||'')} ${escapeHtml(r.deliveryTime||'')}<br/>
                            Raison: ${escapeHtml(r.reason||'-')}<br/>
                            Structure: ${escapeHtml(r.structure||'-')}<br/>
                            Cr√©√© le: ${new Date(r.timestamp).toLocaleString()}`);
            adminMarkersLayer.addLayer(m);
            markers.push(m);
        }
    });
    if (markers.length) {
        const group = L.featureGroup(markers);
        adminMap.fitBounds(group.getBounds().pad(0.2));
    }
}

function focusOnReport(report) {
    if (!report || !report.location) return;
    const {lat,lng} = report.location;
    adminMap.setView([lat,lng], 18, {animate:true});
    adminMarkersLayer.eachLayer(l=>{
        if (l.getLatLng && Math.abs(l.getLatLng().lat - lat) < 1e-6 && Math.abs(l.getLatLng().lng - lng) < 1e-6) {
            l.openPopup();
        }
    });
}

function deleteReport(id) {
    if (!confirm("Supprimer ce rapport ?")) return;
    const reports = loadReportsFromLS().filter(r=>r.id !== id);
    saveReportsToLS(reports);
    initializeAdmin();
}

function exportReportsCSV(reports) {
    const rows = [
        ['id','timestamp','status','reason','agentName','agentContact','structure','deliveryDate','deliveryTime','lat','lng']
    ];
    (reports||[]).forEach(r=>{
        rows.push([
            r.id||'',
            r.timestamp||'',
            r.status||'',
            (r.reason||'').replace(/\n/g,' '),
            r.agentName||'',
            r.agentContact||'',
            r.structure||'',
            r.deliveryDate||'',
            r.deliveryTime||'',
            r.location && r.location.lat != null ? r.location.lat : '',
            r.location && r.location.lng != null ? r.location.lng : ''
        ]);
    });
    const csv = rows.map(row=>row.map(cell => {
        const s = String(cell).replace(/"/g,'""');
        return `"${s}"`;
    }).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'rapports_impots.csv';
    document.body.appendChild(a); a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function escapeHtml(str){
    return String(str || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function openEditModal(report) {
  document.getElementById('edit-id').value = report.id;
  document.getElementById('edit-status').value = report.status || 'delivered';
  document.getElementById('edit-agentName').value = report.agentName || '';
  document.getElementById('edit-agentContact').value = report.agentContact || '';
  document.getElementById('edit-structure').value = report.structure || '';
  document.getElementById('edit-deliveryDate').value = report.deliveryDate || '';
  document.getElementById('edit-deliveryTime').value = report.deliveryTime || '';
  document.getElementById('edit-reason').value = report.reason || '';
  document.getElementById('edit-modal').style.display = 'flex';
}

function closeEditModal() {
  document.getElementById('edit-modal').style.display = 'none';
}

function saveEdit() {
  const id = Number(document.getElementById('edit-id').value);
  let reports = loadReportsFromLS();
  let idx = reports.findIndex(r => r.id === id);
  if (idx === -1) { alert('Rapport introuvable'); closeEditModal(); return; }
  reports[idx].status = document.getElementById('edit-status').value;
  reports[idx].agentName = document.getElementById('edit-agentName').value.trim();
  reports[idx].agentContact = document.getElementById('edit-agentContact').value.trim();
  reports[idx].structure = document.getElementById('edit-structure').value.trim();
  reports[idx].deliveryDate = document.getElementById('edit-deliveryDate').value;
  reports[idx].deliveryTime = document.getElementById('edit-deliveryTime').value;
  reports[idx].reason = document.getElementById('edit-reason').value.trim();
  saveReportsToLS(reports);
  closeEditModal();
  initializeAdmin();
}

window.addEventListener('storage', (e)=>{
    if (e.key === LS_KEY && document.getElementById('admin-container').style.display === 'block') {
        initializeAdmin();
    }
});
<script src="script.js"></script>

</body>
</html>